<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<title>The Waf Book (v1.5.19)</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #dddddd;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }
div.imageblock.latex div.image-title { margin-top: 0.5em; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  div#footer-badges { display: none; }
}

div#toc {
  margin-bottom: 2.5em;
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

pre.verseblock-content {
  font-family: inherit;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){asciidoc.footnotes(); asciidoc.toc(2);}
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  var cont = document.getElementById("content");
  var noteholder = document.getElementById("footnotes");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      // Use [\s\S] in place of . so multi-line matches work.
      // Because JavaScript has no s (dotall) regex flag.
      note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      spans[i].innerHTML =
        "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
        "' title='View footnote' class='footnote'>" + n + "</a>]";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
}

}
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>The Waf Book (v1.5.19)</h1>
<span id="author">Thomas Nagy</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Copyright &#169; 2008-2010 Thomas Nagy</p></div>
<div class="paragraph"><p>Copies of this book may be redistributed, verbatim, and for non-commercial
purposes. The license for this book is
 <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">by-nc-nd license</a>.</p></div>
<h3 id="_a_word_on_build_systems">1.1. A word on build systems</h3><div style="clear:left"></div>
<div class="paragraph"><p>As software is becoming increasingly complex, the process of creating software is becoming more complex too. Today&#8217;s software uses various languages, requires various compilers, and the input data is spread into many files.</p></div>
<div class="paragraph"><p>Software is now used to express the process of building software, it can take the form of simple scripts (shell scripts, makefiles), or compilers (CMake, Qmake), or complete applications (SCons, Maven, Waf). The term &#8216;build system&#8217; is used to design the tools used to build applications.</p></div>
<h3 id="_the_waf_framework">1.2. The Waf framework</h3><div style="clear:left"></div>
<div class="paragraph"><p>Build systems make assumptions on software it is trying to build, and are typically limited where it comes to processing other languages or different projects. For example, Ant is better suited than Make for managing Java projects, but is more limited than Make for managing simple c projects. The programming tools are evolving constantly, making the creation of a complete build system for end-users impossible.</p></div>
<div class="paragraph"><p>The Waf framework is somewhat different than traditional build systems in the sense that the focus is to support indirectly the major usecases encountered when working on a software project, without supporting a language directly. Waf is essentially a library of components that are suitable for use in a build system, with an emphasis on extensibility. Although the default distribution contains various plugins for different programming languages and different tools (c, d, ocaml, java, etc), it is by no means a frozen product. Creating new extensions is both a standard and a recommended practice.</p></div>
<h3 id="_objectives_of_this_book">1.3. Objectives of this book</h3><div style="clear:left"></div>
<div class="paragraph"><p>The objectives of this book is to expose the use of the Waf build system though the use of Waf in practice, the description of the Waf extension system, and an overview of the Waf internals. We hope that this book will serve as a reference for both new and advanced users. Although this book does not deal with build systems in general, a secondary objective is to illustrate quite a few new techniques and patterns through numerous examples.</p></div>
<div class="paragraph"><p>The chapters are ordered by difficulty, starting from the basic use of Waf and Python, and diving gradually into the most difficult topics. It is therefore recommended to read the chapters in order. It is also possible to start by looking at the <a href="http://code.google.com/p/waf/source/browse/trunk/demos/">examples</a> from the waf distribution before starting the reading.</p></div>
</div>
<h2 id="_getting_started">2. Getting Started</h2>
<div class="sectionbody">
<h3 id="_obtaining_waf">2.1. Obtaining Waf</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Waf project is located on <a href="http://code.google.com/p/waf">Google Code</a>.
The current Waf version requires an interpreter for the Python programming language such as <a href="http://www.python.org">cPython</a> 2.3 to 3.1 or <a href="http://www.jython.org">Jython</a> &gt;= 2.5. Note that Waf requires <a href="http://docs.python.org/library/bz2.html">bzip2</a> compression support, which may be unavailable in self-compiled cPython installations.</p></div>
<h4 id="_using_the_waf_binary">2.1.1. Using the Waf binary</h4>
<div class="paragraph"><p>The Waf binary does not require any installation whatsoever. It may be executed directly from a writeable folder. Just rename it into 'waf' if necessary:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.5.19</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ mv waf-1.5.19 waf &amp;&amp; chmod 755 waf</span></span></tt></pre></div></div>
<h4 id="_generating_the_waf_binary_from_the_source_code">2.1.2. Generating the Waf binary from the source code</h4>
<div class="paragraph"><p>The Waf binary creation requires a Python interpreter in version 2.4 to 2.6. The source code is processed to support Python 2.3 and Python 3.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.5.19.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tar xjvf waf-1.5.19.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd waf-1.5.19</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf-light --make-waf</span></span></tt></pre></div></div>
<h3 id="_running_waf">2.2. Running Waf</h3><div style="clear:left"></div>
<div class="paragraph"><p>The <em>waf</em> script can be used directly from a writeable folder:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ ./waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or, if the executable permissions are not set properly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <em>waf</em> file has its own library compressed in a binary stream in the same file. Upon execution, the library is uncompressed in the current directory, in a hidden folder that will be re-created if removed. The naming enables different Waf versions to be executed from the same folders:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ ls -ld .waf*</span></span>
<span style="color: #000000">.waf-1.5.19-2c924e3f453eb715218b9cc852291170</span></tt></pre></div></div>
<div class="paragraph"><p>By default, the recommended Python interpreter is cPython, for which the supported versions are 2.3 to 3.1. For maximum convenience for the user, a copy of the <a href="http://www.jython.org">Jython</a> interpreter in the version 2.5 may be redistributed along with a copy of the Waf executable.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">A project containing <em>waf</em>, <em>jython2.5.jar</em> and the source code may be used almost anywhere.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">The <em>waf</em> script must reside in a writable folder to unpack its cache files.</td>
</tr></table>
</div>
<h3 id="_installing_waf_on_a_system">2.3. Installing Waf on a system</h3><div style="clear:left"></div>
<div class="paragraph"><p>Installing Waf on a system is unnecessary and discouraged:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Interpreter version: unlike the <em>waf</em> file, the installed version will not run on Python 3
</p>
</li>
<li>
<p>
Operating systems: Waf cannot be installed on Windows (yet)
</p>
</li>
<li>
<p>
Installation: installation is cumbersome, and requires administrative privileges
</p>
</li>
<li>
<p>
Waf versions: users rarely install the appropriate software version (too old, too new, bugs)
</p>
</li>
<li>
<p>
Bugs: projects may depend on unspecified behaviour in particular Waf versions
</p>
</li>
<li>
<p>
Size: the <em>waf</em> file is small enough to be redistributed (about 90kB)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Installation require a Python interpreter in the versions 2.4 to 2.6. It may require administrator or root privileges, depending on the target folder (prefix).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399"># ./waf-light configure --prefix=/usr/</span></span>
<span style="font-weight: bold"><span style="color: #993399"># ./waf-light install</span></span></tt></pre></div></div>
<div class="paragraph"><p>Likewise, Waf can be uninstalled using:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399"># ./waf-light --prefix=/usr/</span></span>
<span style="font-weight: bold"><span style="color: #993399"># ./waf-light uninstall</span></span></tt></pre></div></div>
</div>
<h2 id="_the_scripting_system">3. The scripting system</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter provides a practical overview of the waf usage in a software project.</p></div>
<h3 id="_setting_up_a_project">3.1. Setting up a project</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Waf projects are structured based on the following concepts:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Source directory: directory containing the source files that will be packaged and redistributed to other developers or to end users
</p>
</li>
<li>
<p>
Build directory: directory containing the files generated by the project (configuration sets, build files, logs, etc)
</p>
</li>
<li>
<p>
System files: files and folders which do not belong to the project (operating system files, etc)
</p>
</li>
</ol></div>
<div class="paragraph"><p>When Waf is launched, it looks for the top-level project file, which are Python scripts. A valid Waf project requires at least a top-level Waf script file (named <em>wscript</em> without any extension) containing the three following elements:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
top: string representing the project directory. In general, top is set to '.', except for some proprietary projects where the wscript cannot be added to the top-level, top may be set to '../..' or even some other folder such as <em>/checkout/perforce/project</em>
</p>
</li>
<li>
<p>
out: string representing the build directory. In general, it is set to <em>build</em>, except for some proprietary projects where the build directory may be set to an absolute path such as <em>/tmp/build</em>. It is important to be able to remove the build directory safely, so it should never be given as '.' or '..'.
</p>
</li>
<li>
<p>
configure: function called for setting up a project (also known as a <em>Waf command</em>).
</p>
</li>
</ol></div>
<div class="paragraph"><p>The Waf script will always look for one valid top-level project file first before considering other project files.</p></div>
<div class="paragraph"><p>Now let us create a new Waf project in the folder <em>/tmp/smallproject</em>. The first step is to write a wscript file in <em>/tmp/smallproject/wscript</em> with the following contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To use a Waf project for the first time, it is necessary to initialize it. Waf will then validate the project file, and create the cache files for later use (lock file, build directory, store the project options):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject <img src="./callouts/1.png" alt="1" /></span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">→ configuring the project</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build_directory/ <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">|   |-- c4che/ <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">|   |   |-- build.config.py <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">|   |   `-- default.cache.py <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">|   |-- config.log <img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">|   `-- default/ <img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">|--.lock-wscript <img src="./callouts/9.png" alt="9" /></span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
To configure the project, go to the folder containing the top-level project file
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The execution is called by calling <tt>waf configure</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The build directory was created
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The configuration data is stored in the folder <em>c4che/</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The command-line options and environment variables in use are stored in this file
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The user configuration set is stored in this file
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Configuration log (duplicate of the output generated during the configuration)
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Directory for the generated files (none so far)
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Lock file pointing at the relevant project file and build directory
</td></tr>
</table></div>
<h3 id="_adding_project_commands">3.2. Adding project commands</h3><div style="clear:left"></div>
<div class="paragraph"><p>In the last section, we have seen the use of the command <em>configure</em> to initialize a project. Waf commands are special functions declared in the top-level project file and which may be called explicitly by <tt>waf commandname</tt>. Let us create two new commands <em>print_ping</em> and <em>print_pong</em> in the project created previously (<em>/tmp/smallproject/</em>)</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">print_ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' ping!'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">print_pong</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' pong!'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Waf commands always take a single parameter called the <em>context</em>, which is used to ease data sharing between the scripts. To execute the new commands:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf print_ping</span></span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf print_pong</span></span>
<span style="color: #000000"> pong!</span>
<span style="color: #000000">'print_pong' finished successfully (0.000s)</span></tt></pre></div></div>
<div class="paragraph"><p>Waf commands may also be executed at once by chaining them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf print_ping print_pong print_ping</span></span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span>
<span style="color: #000000"> pong!</span>
<span style="color: #000000">'print_pong' finished successfully (0.000s)</span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span></tt></pre></div></div>
<div class="paragraph"><p>Waf commands may be repeated several times too:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf print_ping print_ping print_ping</span></span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span>
<span style="color: #000000"> pong!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span></tt></pre></div></div>
<h3 id="_cleaning_up_a_project">3.3. Cleaning up a project</h3><div style="clear:left"></div>
<div class="paragraph"><p>Waf itself comes with a predefined command called <em>distclean</em> which removes the build directory and the lock file. After calling cleaning a project, it is necessary to configure it once again.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf print_ping</span></span>
<span style="color: #000000"> ping!</span>
<span style="color: #000000">'print_ping' finished successfully (0.000s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf print_ping</span></span>
<span style="color: #000000">Project not configured (run 'waf configure' first)</span></tt></pre></div></div>
<div class="paragraph"><p>It is possible to override the behaviour of <em>distclean</em> by redefining it in the wscript file. For example, the following will cause it to avoid removing the build files.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">distclean</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' Not cleaning anything!'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean</span></span>
<span style="color: #000000"> not cleaning anything!</span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span></tt></pre></div></div>
<h3 id="_packaging_the_project_sources">3.4. Packaging the project sources</h3><div style="clear:left"></div>
<div class="paragraph"><p>The command <em>dist</em> is another predefined utility which is used to create an archive of the project. By using the script presented previously:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Execute the command <em>dist</em> to get:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: noname-1.0.tar.bz2 (sha='c16c97a51b39c7e5bee35bb6d932a12e2952f2f8')</span>
<span style="color: #000000">'dist' finished successfully (0.091s)</span></tt></pre></div></div>
<div class="paragraph"><p>By default, the project name and version are set to <em>noname</em> and <em>1.0</em>. To change them, it is necessary to provide two additional variables in the top-level project file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">APPNAME</span><span style="color: #000000">=</span><span style="color: #009900">'webe'</span>
<span style="color: #000000">VERSION</span><span style="color: #000000">=</span><span style="color: #009900">'2.0'</span>

<span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Because the project was configured once, it is not necessary to configure it once again:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: webe-2.0.tar.bz2 (sha='7ccc338e2ff99b46d97e5301793824e5941dd2be')</span>
<span style="color: #000000">'dist' finished successfully (0.006s)</span></tt></pre></div></div>
<div class="paragraph"><p>The default compression format is <a href="http://www.bzip.org/">bzip2</a>. It may be changed to <a href="http://www.gzip.org/">gzip</a> by using the symbol <em>gz</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Scripting</span>
<span style="color: #000000">Scripting</span><span style="color: #000000">.</span><span style="color: #000000">g_gz </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'gz'</span></tt></pre></div></div>
<div class="paragraph"><p>Or <em>zip</em> for <a href="http://en.wikipedia.org/wiki/ZIP_%28file_format%29">zip</a> files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Scripting</span>
<span style="color: #000000">Scripting</span><span style="color: #000000">.</span><span style="color: #000000">g_gz </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'zip'</span></tt></pre></div></div>
<h3 id="_splitting_a_project_into_several_files">3.5. Splitting a project into several files</h3><div style="clear:left"></div>
<div class="paragraph"><p>Although a Waf project must contain a top-level wscript file, the contents may be split into several sub-project files. We will now illustrate this concept on a small project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">.</span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The commands in the top-level wscript will call the same commands from a subproject wscript file by calling a context method named <em>recurse</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configure from the top-level'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">print_ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from the top-level'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Since the folder <em>src</em> is not a redistributable project, it is not necessary to duplicate the variables <em>top</em> and <em>out</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configure from src'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">print_ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the results will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure print_ping</span></span>
<span style="color: #000000">→ configure from the top-level</span>
<span style="color: #000000">→ configure from src</span>
<span style="color: #000000">'configure' finished successfully (0.080s)</span>
<span style="color: #000000">→ ping from the top-level</span>
<span style="color: #000000">→ ping from src</span>
<span style="color: #000000">'print_ping' finished successfully (0.009s)</span></tt></pre></div></div>
<h3 id="_building_cleaning_installing_and_uninstalling_a_project">3.6. Building, cleaning, installing and uninstalling a project</h3><div style="clear:left"></div>
<div class="paragraph"><p>The <em>build</em> command is used for building the actual software. Starting again from the project file <em>/tmp/smallfolder/wscript</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configure from the top-level'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'building the software'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Without surprise, the execution output will look like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Project not configured (run 'waf configure' first)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configure from the top-level</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="paragraph"><p>Since the command <tt>waf build</tt> is executed very often, a shortcut is provided to call it implicitly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build_directory'</span></tt></pre></div></div>
<div class="paragraph"><p>The Waf commands <tt>build</tt>, <tt>clean</tt>, <tt>install</tt>, <tt>uninstall</tt> are shortcuts for calling <tt>waf build</tt> with different internal options. They all require the presence of the <em>build</em> function in the scripts.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf build install uninstall clean</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">'install' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build_directory'</span>
<span style="color: #000000">'uninstall' finished successfully (0.002s)</span>
<span style="color: #000000">building the software</span>
<span style="color: #000000">'clean' finished successfully (0.002s)</span></tt></pre></div></div>
<div class="paragraph"><p>The meaning of the commands is the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>build:</tt> process the source code to create the object files
</p>
</li>
<li>
<p>
<tt>clean:</tt> remove the object files that were created during a build (unlike distclean, do not remove the configuration)
</p>
</li>
<li>
<p>
<tt>install:</tt> check that all object files have been generated and copy them on the system (programs, libraries, data files, etc)
</p>
</li>
<li>
<p>
<tt>uninstall:</tt> undo the installation, remove the object files from the system without touching the ones in the build directory
</p>
</li>
</ol></div>
<div class="paragraph"><p>Object file creation and installation will be detailed in the next chapters.</p></div>
<h3 id="_customizing_the_command_line_options">3.7. Customizing the command-line options</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Waf script provides various default command-line options, which may be consulted by executing <tt>waf --help</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --help</span></span>
<span style="color: #000000">waf [command] [options]</span>

<span style="color: #000000">Main commands (example: ./waf build -j4)</span>
<span style="color: #000000">  build    : builds the project</span>
<span style="color: #000000">  clean    : removes the build files</span>
<span style="color: #000000">  configure: configures the project</span>
<span style="color: #000000">  dist     : makes a tarball for redistributing the sources</span>
<span style="color: #000000">  distcheck: checks if the sources compile (tarball from 'dist')</span>
<span style="color: #000000">  distclean: removes the build directory</span>
<span style="color: #000000">  install  : installs the build files</span>
<span style="color: #000000">  uninstall: removes the installed files</span>

<span style="color: #000000">Options:</span>
<span style="color: #000000">  --version             show program's version number and exit</span>
<span style="color: #000000">  -h, --help            show this help message and exit</span>
<span style="color: #000000">  -j JOBS, --jobs=JOBS  amount of parallel jobs (2)</span>
<span style="color: #000000">  -k, --keep            keep running happily on independent task groups</span>
<span style="color: #000000">  -v, --verbose         verbosity level -v -vv or -vvv [default: 0]</span>
<span style="color: #000000">  --nocache             ignore the WAFCACHE (if set)</span>
<span style="color: #000000">  --zones=ZONES         debugging zones (task_gen, deps, tasks, etc)</span>
<span style="color: #000000">  -p, --progress        -p: progress bar; -pp: ide output</span>
<span style="color: #000000">  --targets=COMPILE_TARGETS</span>
<span style="color: #000000">                        build given task generators, e.g. "target1,target2"</span>

<span style="color: #000000">  configuration options:</span>
<span style="color: #000000">    --prefix=PREFIX     installation prefix (configuration) [default: '/usr/local/']</span>

<span style="color: #000000">  installation options:</span>
<span style="color: #000000">    --destdir=DESTDIR   installation root [default: '']</span>
<span style="color: #000000">    -f, --force         force file installation</span></tt></pre></div></div>
<div class="paragraph"><p>Accessing a command-line option is possible from any command. Here is how to access the value <em>prefix</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ prefix is '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">prefix</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the following will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ prefix is /usr/local/</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>To define project command-line options, a special command named <em>set_options</em> may be defined in user scripts. This command will be called once before any other command executes.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ the value of foo is %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the following will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure --foo=test</span></span>
<span style="color: #000000">→ the value of foo is 'test'</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>The command context for set_options is a shortcut to access the optparse functionality. For more information on the optparse module, consult the <a href="http://docs.python.org/library/optparse.html">Python documentation</a></p></div>
</div>
<h2 id="_the_configuration_system">4. The configuration system</h2>
<div class="sectionbody">
<div class="paragraph"><p>The configuration step is used to check if the requiremements for working on a project are met. The parameters are then stored for further use.</p></div>
<h3 id="_storing_configuration_sets">4.1. Storing configuration sets</h3><div style="clear:left"></div>
<div class="paragraph"><p>Configuration sets are instances of the class <em>Environment</em>. That class acts as a wrapper around Python dicts to handle serialization (in human-editable files) and copy-on-write efficiently. Instances of that class are used extensively within waf, and the instances are usually named <em>env</em>. Here is how the default configuration set called <em>env</em> is usually stored:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">[</span><span style="color: #009900">'CXXFLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #808080"># key-based access</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">store</span><span style="color: #000000">(</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">TEST        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test'</span><span style="color: #000000">  </span><span style="color: #808080"># attribute-based access</span>

<span style="color: #000000">        new </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">()</span>
<span style="color: #000000">        new</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">new</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">""</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution will result in the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">'CXXFLAGS' ['-O2']</span>
<span style="color: #000000">'PREFIX' '/usr/local'</span>

<span style="color: #000000">'CXXFLAGS' ['-O2']</span>
<span style="color: #000000">'PREFIX' '/usr/local'</span>
<span style="color: #000000">'TEST' 'test'</span>

<span style="font-weight: bold"><span style="color: #993399">$ cat test.txt</span></span>
<span style="color: #000000">CXXFLAGS = ['-O2']</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/c4che/default.cache.py</span></span>
<span style="color: #000000">CXXFLAGS = ['-O2']</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>
<span style="color: #000000">TEST = 'test'</span></tt></pre></div></div>
<div class="paragraph"><p>The default configuration is stored to the cache file named <em>default.cache.py</em>. The configuration set will always contain the default variable PREFIX, which is used to indicate the default directory in which to install something (in case there is something to install). The cache file is written in pseudo-python, and may be edited manually if necessary.</p></div>
<div class="paragraph"><p>Although the conf.env object is similar to a Python dict, a few routines are present to ease value access:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">[</span><span style="color: #009900">'CCFLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CCFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'CXXFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-g'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_unique</span><span style="color: #000000">(</span><span style="color: #009900">'CCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'CCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O3'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        my_copy </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">copy</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span>
<span style="color: #000000">        s </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">subst_vars</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/bin'</span><span style="color: #000000">,</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">s</span><span style="color: #000000">)</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">store</span><span style="color: #000000">(</span><span style="color: #009900">'/tmp/env.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Environment</span>
<span style="color: #000000">        env </span><span style="color: #000000">=</span><span style="color: #000000"> Environment</span><span style="color: #000000">.</span><span style="color: #000000">Environment</span><span style="color: #000000">()</span>
<span style="color: #000000">        env</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'/tmp/env.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/10.png" alt="10" /></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Initialize and set the given value by using the key-based notation
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Initialize and set the given value by using the attribute-based notation
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Ensure conf.env.CXXFLAGS is initalized, and add the given values
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Append the elements from the second list that are not already present in conf.env.CCFLAGS
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Insert the values from the second list in first position, preserving the order
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Create a copy
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Format and print the contents
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Substitute the values in a formatted string
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Serialize and store the contents into a file, one key=value by line.
</td></tr>
<tr><td><img src="./callouts/10.png" alt="10" /></td><td>
Instantiate a new Environment and load the contents from a file
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">'CCFLAGS' ['-O3', '-g', '-O2']</span>
<span style="color: #000000">'CXXFLAGS' ['-O2', '-g']</span>
<span style="color: #000000">'PREFIX' '/usr/local'</span>
<span style="color: #000000">-O3 -g -O2</span></tt></pre></div></div>
<h3 id="_consulting_configuration_sets_during_the_build">4.2. Consulting configuration sets during the build</h3><div style="clear:left"></div>
<div class="paragraph"><p>By splitting the configuration from the build step, it is possible to stop and look at the configuration sets (for example <tt>build/c4che/default.cache.py</tt>). The data used during the build should use the command-line options as little as possible. To achieve this, a pattern similar to the following is usually applied:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> var</span><span style="color: #000000">=</span><span style="color: #009900">'TOUCH'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #808080"># a configuration helper</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">TOUCH</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>All configuration sets are automatically loaded during the build. Upon execution, the output will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --foo=abcd</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">Checking for program touch               : ok /usr/bin/touch</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/comp/waf/demos/simple_scenarios/folders/build'</span>
<span style="color: #000000">/usr/bin/touch</span>
<span style="color: #000000">abcd</span>
<span style="color: #000000">Waf: Leaving directory `/comp/waf/demos/simple_scenarios/folders/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<h3 id="_launching_and_catching_configuration_exceptions">4.3. Launching and catching configuration exceptions</h3><div style="clear:left"></div>
<div class="paragraph"><p>Configuration helpers are methods provided by the conf object to help finding parameters, for example the method <em>conf.find_program</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>When a test fails, the exception <em>Configure.ConfigurationError</em> is raised. For example, such exceptions are thrown when a program could not be found:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Configure</span>
<span style="color: #000000">        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'missing_app'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">except</span><span style="color: #000000"> Configure</span><span style="color: #000000">.</span><span style="color: #000000">ConfigurationError</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">pass</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">([</span><span style="color: #009900">'gjc'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'cjg'</span><span style="color: #000000">],</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The output will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Checking for program missing_app         : not found</span>
<span style="color: #000000">Checking for program gjc,cjg             : not found</span>
<span style="color: #000000"> error: The program ['gjc', 'cjg'] could not be found</span></tt></pre></div></div>
<div class="paragraph"><p>It is sometimes useful to raise such an exception manually by using <em>conf.fatal</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">"I'm sorry Dave, I'm afraid I can't do that"</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Which will display the same kind of error</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000"> error: I'm sorry Dave, I'm afraid I can't do that</span>
<span style="font-weight: bold"><span style="color: #993399">$ echo $?</span></span>
<span style="color: #000000">1</span></tt></pre></div></div>
<h3 id="_loading_waf_tools">4.4. Loading Waf tools</h3><div style="clear:left"></div>
<div class="paragraph"><p>For efficiency reasons, the Waf core libraries do not provide support for programming languages. The configuration helpers are located in separate files called <em>Waf tools</em> and located under the folder <tt>wafadmin/Tools</tt>. The contributed tools, or the tools in testing phase are located under the folder <tt>wafadmin/3rdparty</tt>.</p></div>
<div class="paragraph"><p>Tools usually provide additional routines, and may modify existing classes to extend their behaviour. We will now demonstrate a very simple Waf tool named <tt>dang.py</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conftest </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@conftest</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">detect</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ detect from dang!'</span><span style="color: #000000">)</span>

<span style="color: #000000">@conftest</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">test_hello</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ test from dang!'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build_hello</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ build hello from dang!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Build</span>
<span style="color: #000000">Build</span><span style="color: #000000">.</span><span style="color: #000000">BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">build_hello </span><span style="color: #000000">=</span><span style="color: #000000"> build_hello </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The decorator <em>conftest</em> is used to bind functions as new methods to the <em>configuration context class</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The default detection method to execute when the tool is loaded is called <em>detect</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
New methods may be bound at runtime onto various classes, here the build context class
</td></tr>
</table></div>
<div class="paragraph"><p>For loading a tool, the method <em>check_tool</em> must be used during the configuration. The same tools are then loaded during the build.:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #808080">#import config_c <img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">        </span><span style="color: #808080">#import config_c <img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">is_check_cc_present</span><span style="color: #000000">():</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ method conf.check_cc %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ there is no method conf.check_cc'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">is_check_cc_present</span><span style="color: #000000">()</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'config_c'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000000">is_check_cc_present</span><span style="color: #000000">()</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">,</span><span style="color: #000000"> funs</span><span style="color: #000000">=</span><span style="color: #009900">'test_hello'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">build_hello</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
By loading a Waf tool at the root of a script, the detection routines will not be executed (discouraged)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
By loading a Waf tool using <em>import</em>, the tool will not be loaded at build time (discouraged)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Just an example to show if the method <em>check_cc</em> is present on the configuration context class
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Load the tool providing configuration routines for c and c++ support (the method check_cc)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
When tools provide a method named <em>detect</em>, it is executed during <em>conf.check_tool</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Use specific functions instead of calling the default
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
To ease the creation of projects split into modules, conf.check_tool will not load the tools twice for the same environment and the same parameters.
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Use the build context method defined in dang.py
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">→ there is no method conf.check_cc</span>
<span style="color: #000000">→ method conf.check_cc (ConfigurationContext.check_cc)</span>
<span style="color: #000000">→ detect from dang!</span>
<span style="color: #000000">→ test from dang!</span>
<span style="color: #000000">'configure' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">→ build hello from dang!</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<h3 id="_handling_configuration_exceptions">4.5. Handling configuration exceptions</h3><div style="clear:left"></div>
<div class="paragraph"><p>An error handler attached to the conf object is used for catching the Configuration exceptions and processing the errors. Here is how to replace the default configuration error handler by a custom method which may modify the list of tests, stop the evaluation, or re-raise the exception:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Constants</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span>

<span style="color: #000000">@conf</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">error_handler</span><span style="color: #000000">(</span><span style="color: #000000">fun</span><span style="color: #000000">,</span><span style="color: #000000"> exc</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'exception %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> exc</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #808080"># other optionals return values: Constants.CONTINUE or anything else to re-raise the exception</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> Constants</span><span style="color: #000000">.</span><span style="color: #000000">BREAK</span></tt></pre></div></div>
<div class="paragraph"><p>The following diagram illustrates the test execution loop performed from conf.check_tool</p></div>
<div class="imageblock">
<div class="content">
<img src="conftest.png" alt="Configuration tests" width="425" />
</div>
</div>
</div>
<h2 id="_the_build_phase">5. The build phase</h2>
<div class="sectionbody">
<div class="paragraph"><p>The build phase consists in generating the project outputs as build files. It is usually executed after the configuration phase.</p></div>
<h3 id="_declaring_new_targets">5.1. Declaring new targets</h3><div style="clear:left"></div>
<div class="paragraph"><p>Since the Waf commands build, clean, install and uninstall execute the same function <em>build</em>, it is somehow necessary to isolate the declaration of the targets from the actual code that will create them. For example:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Execution control: targets are only produced during the calls to the commands <em>build</em> and <em>install</em>
</p>
</li>
<li>
<p>
Parallel target processing to accelerate the builds: multi-core systems
</p>
</li>
<li>
<p>
Filesystem abstraction: fetching data from the network
</p>
</li>
<li>
<p>
Extensibility: adding support for new compilers and new languages from user scripts
</p>
</li>
<li>
<p>
Flexibility: changing the semantics of the declarations depending on the platform (operating system, compiler, etc)
</p>
</li>
</ol></div>
<div class="paragraph"><p>These main contraints lead to the creation of an abstraction layer between the actual code execution (<em>task</em>) and the declaration (<em>task generators</em>). Here are two important definitions:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>Task</tt>: Abstract unit of data transformation which may be delegated for later execution. Task instances often present sequential constraints and require a scheduler to optimize the overall execution time (execution in parallel whenever possible).
</p>
</li>
<li>
<p>
<tt>Task generator</tt>: Object part of the user interface (Waf scripts) used to create lots of task instances. The task generators handle global constraints across the tasks: access to the configuration sets, data sharing, operating system abstraction, error checking, etc
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is a sample project script to illustrate the concepts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">target</span><span style="color: #000000">=</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'  '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> obj</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The call <em>ctx(&#8230;)</em> is just a shortcut on the build context to create new task generator instances easily. The output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build build clean</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">  class 'TaskGen.task_gen' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[1/1] test.txt:  -&gt; build/default/test.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.011s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">  class 'TaskGen.task_gen' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>
<span style="color: #000000">  class 'TaskGen.task_gen' <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">'clean' finished successfully (0.002s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Print <em>obj.<em>class</em></em>.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Actual task execution, during the first build.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
This print was output during the second <tt>build</tt> execution. The target is considered up-to-date and is not rebuilt.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
This print was output during the call to <tt>clean</tt>.
</td></tr>
</table></div>
<h3 id="_finding_folders_and_files_through_node_objects">5.2. Finding folders and files through node objects</h3><div style="clear:left"></div>
<div class="paragraph"><p>In general, file system access are slow operations (listing files and folders, reading file permissions, etc). For this reason, Waf maintains an internal representation of the files and folders already explored in the form of a tree of Node instances. Two nodes may be accessed from the build context:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>root</tt>: node representing the root of the file system, or the folder containing the drive letters on win32 systems
</p>
</li>
<li>
<p>
<tt>path</tt>: node representing the path of the script being read (path to the wscript file)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Nodes are often used for low-level operations such as extending Waf, and direct node manipulation is hardly ever necessary from user scripts.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'current path %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'absolute path of the root node: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'absolute path of the current node: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>

<span style="color: #000000">        etc </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'/etc'</span><span style="color: #000000">)</span>
<span style="color: #000000">        var </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'/var'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'the node representing /etc %r: '</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> etc</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'path from /var to /etc %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> etc</span><span style="color: #000000">.</span><span style="color: #000000">relpath_gen</span><span style="color: #000000">(</span><span style="color: #000000">var</span><span style="color: #000000">))</span>

<span style="color: #000000">        fstab </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'/etc/fstab'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'path to /etc/fstab: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> fstab</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>The following results would be observed upon execution on a unix-like system:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">current path dir:///tmp/smallproject</span>
<span style="color: #000000">absolute path of the root node: '/'</span>
<span style="color: #000000">absolute path of the current node: '/tmp/smallproject'</span>
<span style="color: #000000">the node representing /etc dir:///etc:</span>
<span style="color: #000000">path from /var to /etc '../etc'</span>
<span style="color: #000000">path to /etc/fstab: '/etc/fstab'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="paragraph"><p>Listing files and folders automatically reduces the needs for updating the scripts (files may be added, removed or renamed). A Node method called <em>ant_glob</em> enables searching for folders and files on the file system. Here is an illustration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'wsc*'</span><span style="color: #000000">))</span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'w?cr?p?'</span><span style="color: #000000">))</span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'etc/**/g*'</span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span><span style="color: #000000">,</span><span style="color: #000000"> dir</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> src</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The method ant_glob is called on a node object, and not on the build context
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The patterns may contain wildcards such as * or ?, but they are <a href="http://ant.apache.org/manual/dirtasks.html">Ant patterns</a>, not regular expressions
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Calling ant_glob on the file system root may be slow, and may give different results depending on the operating system
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The <em>**</em> indicates to consider folders recursively. Use with care.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
By default, only node representing source files are returned. It is possible to obtain folder nodes and build file nodes by turning on the appropriate options.
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">wscript</span>
<span style="color: #000000">wscript</span>
<span style="color: #000000">etc/ghostscript etc/gconf etc/gconf/gconf.xml.mandatory etc/gnome-vfs-2.0 etc/gpm etc/gnupg etc/gre.d etc/gdm</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (12.873s)</span></tt></pre></div></div>
<h3 id="_installing_files">5.3. Installing files</h3><div style="clear:left"></div>
<div class="paragraph"><p>Three build context methods are provided for installing files:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
install_files: install several files in a folder
</p>
</li>
<li>
<p>
install_as: install a target with a different name
</p>
</li>
<li>
<p>
symlink_as: create a symbolic link on the platforms that support it
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/include'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'a1.h'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'a2.h'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/bar.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">symlink_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/lib/libfoo.so.1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'libfoo.so.1.2.3'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        env_foo </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">copy</span><span style="color: #000000">()</span>
<span style="color: #000000">        env_foo</span><span style="color: #000000">.</span><span style="color: #000000">PREFIX </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/opt'</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/test.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">=</span><span style="color: #000000">env_foo</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        start_dir </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src/bar'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'foo/a1.h'</span><span style="color: #000000">],</span><span style="color: #000000"> cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> start_dir</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*.png'</span><span style="color: #000000">),</span><span style="color: #000000"> cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Install various files in the target destination
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Install one file, changing its name
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Create a symbolic link
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Overridding the configuration set (<em>env</em> is optional in the three methods install_files, install_as and symlink_as)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Install src/bar/foo/a1.h as seen from the current script into <em>${PREFIX}/share/foo/a1.h</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Install the png files recursively, preserving the folder structure read from src/bar/
</td></tr>
</table></div>
<h3 id="_executing_specific_routines_before_or_after_the_build">5.4. Executing specific routines before or after the build</h3><div style="clear:left"></div>
<div class="paragraph"><p>User functions may be bound to be executed at two key moments during the build command (callbacks):</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
immediately before the build starts (bld.add_pre_fun)
</p>
</li>
<li>
<p>
immediately after the build is completed successfully (bld.add_post_fun)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is how to execute a test after the build is finished:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--exe'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store_true'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span>
<span style="color: #000000">                help</span><span style="color: #000000">=</span><span style="color: #009900">'execute the program after it is built'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pre</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'before the build is started'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">exe</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                Utils</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'/sbin/ldconfig'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_pre_fun</span><span style="color: #000000">(</span><span style="color: #000000">pre</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_post_fun</span><span style="color: #000000">(</span><span style="color: #000000">post</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The callbacks take the build context as unique parameter <em>ctx</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Access to the command-line options
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
A common scenario is to call ldconfig after the files are installed.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Scheduling the functions for later execution. Remember that in Python, functions are objects too.
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the following output will be produced:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --exe</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">before the build is started <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">/sbin/ldconfig: Can't create temporary cache file /etc/ld.so.cache~: Permission denied <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'build' finished successfully (0.008s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
output of the function bound by <em>bld.add_pre_fun</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
output of the function bound by <em>bld.add_post_fun</em>
</td></tr>
</table></div>
</div>
<h2 id="_build_copies_and_variants">6. Build copies and variants</h2>
<div class="sectionbody">
<div class="paragraph"><p>A common scenario is to duplicate the outputs for a particular build phase. The copy may be performed into another build directory, or into subfolders of the same tree called variants.</p></div>
<h3 id="_using_several_build_folders">6.1. Using several build folders</h3><div style="clear:left"></div>
<div class="paragraph"><p>It is not possible to use several Waf instances concurrently over the same build folder. Yet, several Waf instances may use the project at the same time. For this, two options must be set:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The environment variable <tt>WAFCACHE</tt>
</p>
</li>
<li>
<p>
The build directory, using a command-line option
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example for a simple project located in <em>/tmp/smallfolderr</em>`:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-debug <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure -b debug <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/debug'</span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; debug/default/foo.txt <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/debug'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-release</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure -b release</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.176s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/release' <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; release/default/foo.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/release'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- .lock-debug <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">|-- .lock-release</span>
<span style="color: #000000">|-- debug</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- default.cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- default</span>
<span style="color: #000000">|       `-- foo.txt</span>
<span style="color: #000000">|-- release</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- default.cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- default</span>
<span style="color: #000000">|       `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The environment variable <em>WAFLOCK</em> points at the configuration of the project in use.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The lockfile is created during the configuration.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The files are output in the build directory <tt>debug</tt>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The configuration <em>release</em> is used with a different lock file and a different build directory.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The contents of the project directory contain the two lock files and the two build folders.
</td></tr>
</table></div>
<div class="paragraph"><p>When waf is executed, it reads the variable <em>WAFLOCK</em> on an internal variable, which may be modified programmatically:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">Options</span><span style="color: #000000">.</span><span style="color: #000000">lockfile </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lockfilename'</span></tt></pre></div></div>
<h3 id="_defining_variants">6.2. Defining variants</h3><div style="clear:left"></div>
<div class="paragraph"><p>Using different build folders is very useful for checking at some point if a different configuration would compile properly. To create different kinds of builds at once, it is possible to use <em>Waf variants</em> to predefine the configuration sets for specific output subdirectories.</p></div>
<div class="paragraph"><p>We will now demonstrate the definition and the usage of two variants named <em>default</em> and <em>debug</em> respectively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out_bld'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">NAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'default'</span>
<span style="color: #000000">        dbg </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">copy</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        rel </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">copy</span><span style="color: #000000">()</span>

<span style="color: #000000">        dbg</span><span style="color: #000000">.</span><span style="color: #000000">set_variant</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">set_env_name</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">,</span><span style="color: #000000"> dbg</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #808080"># conf.check_tool('gcc') <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">NAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        rel</span><span style="color: #000000">.</span><span style="color: #000000">set_variant</span><span style="color: #000000">(</span><span style="color: #009900">'release'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">set_env_name</span><span style="color: #000000">(</span><span style="color: #009900">'cfg_name'</span><span style="color: #000000">,</span><span style="color: #000000"> rel</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'cfg_name'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">NAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'bar'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo ${NAME} &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target</span><span style="color: #000000">=</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo ${NAME} &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target</span><span style="color: #000000">=</span><span style="color: #009900">'test.txt'</span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span><span style="color: #000000">,</span>
<span style="color: #000000">                env</span><span style="color: #000000">=</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env_of_name</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">).</span><span style="color: #000000">copy</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo ${NAME} &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target</span><span style="color: #000000">=</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                env</span><span style="color: #000000">=</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env_of_name</span><span style="color: #000000">(</span><span style="color: #009900">'cfg_name'</span><span style="color: #000000">).</span><span style="color: #000000">copy</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a copy of the default data set.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Set the copy to use the variant named <em>debug</em>: task using it will output their files into <tt>out_bld/debug</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Bind the configuration set to the configuration. The configuration set will be saved when the configuration terminates
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Replace <em>conf.env</em> by our new debug configuration set
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Waf tools store their configuration data on conf.env, in this case the <em>debug</em> configuration set, not in the default
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Store a variable on the <em>debug</em> configuration set
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Define another variant called <em>release</em>. The variant name and the configuration set name may be different.
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
The argument <em>env</em> is given to specify the task generator configuration set. The configuration set holds the variant definition.
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Environments may be retrieved by name from the build context object. It is recommended to make copies to avoid accidental data sharing.
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, an output similar to the following will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/out_bld'</span>
<span style="color: #000000">[1/3] test.txt:  -&gt; out_bld/default/test.txt</span>
<span style="color: #000000">[2/3] test.txt:  -&gt; out_bld/debug/test.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[3/3] test.txt:  -&gt; out_bld/release/test.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/out_bld'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree out_bld/</span></span>
<span style="color: #000000">out_bld/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- cfg_name.cache.py <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   |-- debug.cache.py</span>
<span style="color: #000000">|   `-- default.cache.py</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">|-- debug</span>
<span style="color: #000000">|   `-- test.txt</span>
<span style="color: #000000">|-- default</span>
<span style="color: #000000">|   `-- test.txt <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">`-- release</span>
<span style="color: #000000">    `-- test.txt</span>

<span style="font-weight: bold"><span style="color: #993399">$ cat out_bld/default/test.txt out_bld/debug/test.txt out_bld/release/test.txt</span></span>
<span style="color: #000000">default <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">foo</span>
<span style="color: #000000">bar</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The files are output in their respective variants
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The configuration sets are stored and retrieved by names, which must be valid filenames without blanks.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The tasks output their files in the relevant variant
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The file contents are different and correspond to the configuration sets used
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">As a general rule, tasks created for a particular variant should not share data with the tasks from another variant.</td>
</tr></table>
</div>
<h3 id="_cloning_task_generators">6.3. Cloning task generators</h3><div style="clear:left"></div>
<div class="paragraph"><p>A cloning scheme is provided for duplicating task generators for several variants easily. A general design pattern is to duplicate the task generators for the desired variants immediately before the build starts. Here is an example, also available in the folder <tt>demos/cxx</tt> of the Waf distribution.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--build_kind'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #009900">'debug,release'</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'build the selected variants'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'debug'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'release'</span><span style="color: #000000">]:</span>
<span style="color: #000000">                env </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">copy</span><span style="color: #000000">()</span>
<span style="color: #000000">                env</span><span style="color: #000000">.</span><span style="color: #000000">set_variant</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">set_env_name</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> obj </span><span style="color: #000080">in</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">all_task_gen</span><span style="color: #000000">[:]:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'debug'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'release'</span><span style="color: #000000">]:</span>
<span style="color: #000000">                        cloned_obj </span><span style="color: #000000">=</span><span style="color: #000000"> obj</span><span style="color: #000000">.</span><span style="color: #000000">clone</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                        kind </span><span style="color: #000000">=</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">build_kind</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> kind</span><span style="color: #000000">.</span><span style="color: #000000">find</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000">&lt;</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000">:</span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                                cloned_obj</span><span style="color: #000000">.</span><span style="color: #000000">posted </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">                obj</span><span style="color: #000000">.</span><span style="color: #000000">posted </span><span style="color: #000000">=</span><span style="color: #000000"> True </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Add a command-line option for enabling or disabling the <em>release</em> and <em>debug</em> builds
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The configuration will create the <em>release</em> and <em>debug</em> configuration sets, bound to a variant of the same names
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Targets are declared normally for the default variant
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A copy of the existing task generators is created to avoid the creation of an infinite loop (new task generator instances get added to that list)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Clone a task generator for the configuration set <em>debug</em> or <em>release</em>. Making task generator clones is a cheap operation compared to duplicating tasks.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Look at the command-line arguments, and disable the unwanted variant(s)
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Disable the original task generator for the default configuration set (do not use it).
</td></tr>
</table></div>
<div class="paragraph"><p>Some task generators are use indexed attributes to generate unique values which may cause unnecessary rebuilds if the scripts change. To avoid problems, it is a best practice to create the task generators for the default configuration set first. Also, the method <em>clone</em> is not a substitute for creating instances for lots of nearly identical task generators. In such a situation, it will be better to use one task generator to create lots of tasks. As a reminder, creating task generator clones for the same variant will lead to build errors.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Do not create task generator clones for the same variant or for the same configuration set.</td>
</tr></table>
</div>
</div>
<h2 id="_advanced_command_definitions">7. Advanced command definitions</h2>
<div class="sectionbody">
<div class="paragraph"><p>The waf operations (commands) may be extended to perform non-trivial operations easily. This chapter demonstrates several common patterns found in real-world project scripts.</p></div>
<h3 id="_providing_a_custom_command_context">7.1. Providing a custom command context</h3><div style="clear:left"></div>
<div class="paragraph"><p>The context for a command is created automatically, and is derived from the class <em>Utils.Context</em>. Custom context instance may be provided in the following manner:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">foo_context</span><span style="color: #000000">(</span><span style="color: #000000">Utils</span><span style="color: #000000">.</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">__init__</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"a context for 'foo'"</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Custom contexts may be provided for the functions <em>configure</em> and <em>build</em>.</p></div>
<h3 id="_creating_aliases_injecting_new_commands">7.2. Creating aliases / Injecting new commands</h3><div style="clear:left"></div>
<div class="paragraph"><p>New commands may be injected in the following manner:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Scripting</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        Scripting</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">+=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'build'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'clean'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Injecting new commands is useful for writing testcases. By executing <em>waf test</em>, the following script will configure a project, create source files in the source directory, build a program, modify the sources, and rebuild the program. In this case, the program must be rebuilt because a header (implicit dependency) has changed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">VERSION </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'0.0.1'</span>
<span style="color: #000000">APPNAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_testcase'</span>

<span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Scripting</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">test</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        lst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'distclean configure setup build modify build'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">()</span>
<span style="color: #000000">        Scripting</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">+=</span><span style="color: #000000"> lst</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">setup</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        f </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">open</span><span style="color: #000000">(</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'w'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'#include "foo.h"\nint main() {return 0;}\n'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">close</span><span style="color: #000000">()</span>

<span style="color: #000000">        f </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">open</span><span style="color: #000000">(</span><span style="color: #009900">'foo.h'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'w'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'int k = 32;\n'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">close</span><span style="color: #000000">()</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target</span><span style="color: #000000">=</span><span style="color: #009900">'tprog'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">modify</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        f </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">open</span><span style="color: #000000">(</span><span style="color: #009900">'foo.h'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'w'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'int k = 34;\n'</span><span style="color: #000000">)</span>
<span style="color: #000000">        f</span><span style="color: #000000">.</span><span style="color: #000000">close</span><span style="color: #000000">()</span></tt></pre></div></div>
<h3 id="_executing_commands_as_part_of_another_command">7.3. Executing commands as part of another command</h3><div style="clear:left"></div>
<div class="paragraph"><p>In the following scenario, the build files are installed into a temporary directory for packaging. This is different from the <tt>waf dist</tt> command which only packages the source files needed for the project.</p></div>
<div class="paragraph"><p>Because the context objects usually derive from different classes, it is usually forbidden to call a command from another commands. In the following example, the commands to execute are pushed onto a stack:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Scripting</span><span style="color: #000000">,</span><span style="color: #000000"> Options</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'/tmp/foo/'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">new_task_gen</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'k.c'</span><span style="color: #000000">)</span>

<span style="color: #000000">back </span><span style="color: #000000">=</span><span style="color: #000000"> False</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">package</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> back</span>
<span style="color: #000000">        Scripting</span><span style="color: #000000">.</span><span style="color: #000000">commands</span><span style="color: #000000">.</span><span style="color: #000000">insert</span><span style="color: #000000">(</span><span style="color: #000000">0</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'create_package'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        Scripting</span><span style="color: #000000">.</span><span style="color: #000000">commands</span><span style="color: #000000">.</span><span style="color: #000000">insert</span><span style="color: #000000">(</span><span style="color: #000000">0</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'install'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        back </span><span style="color: #000000">=</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">destdir </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">destdir </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/tmp/foo'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">create_package</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> back</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"packaging"</span><span style="color: #000000">)</span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">destdir </span><span style="color: #000000">=</span><span style="color: #000000"> back </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Perform the installation
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Users will call <em>waf package</em> to create the package
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Postpone the actual package creation
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Now the next command to execute is the installation, and after the installation, the package creation will be performed
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Change the value of <em>destdir</em> for installing the files into a temporary directory
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Command for creating the package
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Restore the value of <em>destdir</em>, in case if more commands are to be executed
</td></tr>
</table></div>
<div class="paragraph"><p>Note that the <em>destdir</em> parameter is being passed between commands by means of a global option.</p></div>
<h3 id="_adding_a_new_command_from_a_waf_tool">7.4. Adding a new command from a waf tool</h3><div style="clear:left"></div>
<div class="paragraph"><p>When the top-level wscript is read, it is converted into a python module and kept in memory. To add a new command dynamically,
it is only necessary to inject the desired function into that module. We will now show how to load a waf tool to count the amount of task generators
in the project.</p></div>
<div class="paragraph"><p>The waf tools are loaded once during the configuration and during the build. To ensure that the tool is always loaded, it is necessary to load its options:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">tool_options</span><span style="color: #000000">(</span><span style="color: #009900">'some_tool'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo "hi"'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo "there"'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'b'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now our tool <em>some_tool.py</em>, located next to the <em>wscript</em> file, will contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> Environment</span><span style="color: #000000">,</span><span style="color: #000000"> Options</span><span style="color: #000000">,</span><span style="color: #000000"> Build</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">list_targets</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #808080">        """return the amount of targets"""</span>

<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> Build</span><span style="color: #000000">.</span><span style="color: #000000">BuildContext</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        proj </span><span style="color: #000000">=</span><span style="color: #000000"> Environment</span><span style="color: #000000">.</span><span style="color: #000000">Environment</span><span style="color: #000000">(</span><span style="color: #000000">Options</span><span style="color: #000000">.</span><span style="color: #000000">lockfile</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">load_dirs</span><span style="color: #000000">(</span><span style="color: #000000">proj</span><span style="color: #000000">[</span><span style="color: #009900">'top'</span><span style="color: #000000">],</span><span style="color: #000000"> proj</span><span style="color: #000000">[</span><span style="color: #009900">'out'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">load_envs</span><span style="color: #000000">()</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_subdirs</span><span style="color: #000000">([</span><span style="color: #000000">os</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">(</span><span style="color: #000000">Utils</span><span style="color: #000000">.</span><span style="color: #000000">g_module</span><span style="color: #000000">.</span><span style="color: #000000">root_path</span><span style="color: #000000">)[</span><span style="color: #000000">0</span><span style="color: #000000">]])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        names </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">set</span><span style="color: #000000">([])</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">all_task_gen</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        names</span><span style="color: #000000">.</span><span style="color: #000000">add</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">name </span><span style="color: #000080">or</span><span style="color: #000000"> x</span><span style="color: #000000">.</span><span style="color: #000000">target</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000"> AttributeError</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">pass</span>

<span style="color: #000000">        lst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">list</span><span style="color: #000000">(</span><span style="color: #000000">names</span><span style="color: #000000">)</span>
<span style="color: #000000">        lst</span><span style="color: #000000">.</span><span style="color: #000000">sort</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> name </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">)</span>
<span style="color: #000000">Utils</span><span style="color: #000000">.</span><span style="color: #000000">g_module</span><span style="color: #000000">.</span><span style="color: #000000">__dict__</span><span style="color: #000000">[</span><span style="color: #009900">'list_targets'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> list_targets </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The function <em>set_options</em> is called by <em>tool_options</em> above
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The command that will be injected dynamically from this tool
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a build context manually
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Read the project settings
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Initialize the build context
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Read the project files, executing the methods <em>build</em>
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Access the declared task generators stored in the build context attribute <em>all_task_gen</em>
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Bind the function as a new command
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/home/waf/tmp/nt/build'</span>
<span style="color: #000000">[1/2] echo "hi":</span>
<span style="color: #000000">hi</span>
<span style="color: #000000">[2/2] echo "there":</span>
<span style="color: #000000">there</span>
<span style="color: #000000">Waf: Leaving directory `/home/waf/tmp/nt/build'</span>
<span style="color: #000000">'build' finished successfully (0.015s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf list_targets</span></span>
<span style="color: #000000">a</span>
<span style="color: #000000">b</span>
<span style="color: #000000">'list_targets' finished successfully (0.003s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --targets=a</span></span>
<span style="color: #000000">Waf: Entering directory `/home/waf/tmp/nt/build'</span>
<span style="color: #000000">[1/1] a:</span>
<span style="color: #000000">hi</span>
<span style="color: #000000">Waf: Leaving directory `/home/waf/tmp/nt/build'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span></tt></pre></div></div>
<div class="paragraph"><p>Note that during the execution of <tt>num_targets</tt>, the task generator definitions have been read but no task was executed.</p></div>
</div>
<h2 id="_rule_based_task_generators_make_like">8. Rule-based task generators (Make-like)</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter illustrates how to perform common transformations used during the build phase through the use of rule-based task generators.</p></div>
<h3 id="_declaration_and_usage">8.1. Declaration and usage</h3><div style="clear:left"></div>
<div class="paragraph"><p>Rule-based task generators are a particular category of task generators producing exactly one task (transformation) at a time.</p></div>
<div class="paragraph"><p>The following example presents a simple example of a task generator producing the file <em>foobar.txt</em> from the project file <em>wscript</em> by executing a copy (the command <tt>cp</tt>). Let&#8217;s create a new project in the folder <em>/tmp/rule/</em> containing the following <em>wscript</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
To instantiate a new task generator, remember that all arguments have the form <em>key=value</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The attribute <em>rule</em> is mandatory here. It represents the command to execute in a readable manner (more on this in the next chapters).
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Source files, either in a space-delimited string, or in a list of python strings
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Target files, either in a space-delimited string, or in a list of python strings
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the following output will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript -&gt; out/default/foobar.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">16:24:21 runner system command -&gt;  cp ../wscript default/foobar.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- out</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- default.cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- default</span>
<span style="color: #000000">|       `-- foobar.txt</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf <img src="./callouts/3.png" alt="3" /></span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript → out/default/foobar.txt <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.013s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
In the first execution, the target is correctly created
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Command-lines are only displayed in <em>verbose mode</em> by using the option <em>-v</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The target are up-to-date, there is nothing to do
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Modify the source file in place by appending a space character
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Since the source has changed, the target is created once again.
</td></tr>
</table></div>
<div class="paragraph"><p>The target is created once again whenever the source files or the rule change. This is achieved by computing a signature for the targets, and storing that signature between executions. By default, the signature is computed by hashing the rule and the source files (MD5 by default).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The task (or transformation) are only executed during the build phase, after all build functions have been read</td>
</tr></table>
</div>
<h3 id="_rule_functions">8.2. Rule functions</h3><div style="clear:left"></div>
<div class="paragraph"><p>Rules may be given as expression strings or as python function. Let&#8217;s modify the previous project file with a python function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' → source is '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">                src </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">srcpath</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                tgt </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">bldpath</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">                </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span>
<span style="color: #000000">                cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">,</span><span style="color: #000000"> tgt</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> run</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'same.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Rule functions take the task instance as parameter.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task instances may access their task generator through the attribute <em>generator</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Sources and targets are represented internally as Node objects bound to the task instance.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Commands are executed from the root of the build directory. Node methods such as <em>bldpath</em> ease the command line creation.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Utils.exec_command(&#8230;) is a wrapper around subprocess.Popen(&#8230;) from the Python library. Passing a string will execute the command through the system shell (use lists to disable this behaviour). The return code for a rule function must be non-0 to indicate a failure.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Use a function instead of a string expression
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/1] same.txt: wscript -&gt; out/default/same.txt</span>
<span style="color: #000000"> → source is wscript</span>
<span style="color: #000000">cp ../wscript default/same.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span></tt></pre></div></div>
<div class="paragraph"><p>The rule function must return <em>0</em> to indicate success, and must generate the files corresponding to the outputs. The rule function must also access the task object in a read-only manner, and avoid node creation or attribute modification.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The string expression <em>cp ${SRC} ${TGT}</em> from the previous example is converted internally to a function similar to <em>run</em>.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">While a string expression may execute only one system command, functions may execute various commands at once.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Due to limitations in the cPython interpreter, only functions defined in python modules can be hashed. This means that changing a function will trigger a rebuild only if it is defined in a waf tool (not in wscript files).</td>
</tr></table>
</div>
<h3 id="_shell_usage">8.3. Shell usage</h3><div style="clear:left"></div>
<div class="paragraph"><p>The attribute <em>shell</em> is used to enable the system shell for command execution. A few points are worth keeping in mind when declaring rule-based task generators:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The Waf tools do not use the shell for executing commands
</p>
</li>
<li>
<p>
The shell is used by default for user commands and custom task generators
</p>
</li>
<li>
<p>
String expressions containing the following symbols '&gt;', '&lt;' or '&amp;' cannot be transformed into functions to execute commands without a shell, even if told to
</p>
</li>
<li>
<p>
In general, it is better to avoid the shell whenever possible to avoid quoting problems (paths having blank characters in the name for example)
</p>
</li>
<li>
<p>
The shell is creating a performance penalty which is more visible on win32 systems.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f2.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the results will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf distclean configure build --zones=runner,action <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">23:11:23 action <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        def to_list(xx):</span>
<span style="color: #000000">                if isinstance(xx, str): return [xx]</span>
<span style="color: #000000">                return xx</span>
<span style="color: #000000">        lst = []</span>
<span style="color: #000000">        lst.extend(['cp'])</span>
<span style="color: #000000">        lst.extend([a.srcpath(env) for a in task.inputs])</span>
<span style="color: #000000">        lst.extend([a.bldpath(env) for a in task.outputs])</span>
<span style="color: #000000">        lst = [x for x in lst if x]</span>
<span style="color: #000000">        return task.exec_command(lst, cwd=wd)</span>

<span style="color: #000000">23:11:23 action</span>
<span style="color: #000000">def f(task): <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        p = env.get_flat</span>
<span style="color: #000000">        cmd = ''' cp %s %s ''' % (" ".join([a.srcpath(env) for a in task.inputs]),</span>
<span style="color: #000000">                " ".join([a.bldpath(env) for a in task.outputs]))</span>
<span style="color: #000000">        return task.exec_command(cmd, cwd=wd)</span>

<span style="color: #000000">[1/2] f1.txt: wscript -&gt; out/default/f1.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt; ['cp', '../wscript', 'default/f1.txt'] <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/2] f2.txt: wscript -&gt; out/default/f2.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt;  cp ../wscript default/f2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.017s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The <em>debugging zones</em> enable the display of specific debugging information (comma-separated values) for the string expression conversion, and <em>runner</em> for command execution
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
String expressions are converted to functions (here, without the shell).
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Command execution by the shell. Notice the heavy use of string concatenation.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Commands to execute are displayed by calling <em>waf --zones=runner</em>. When called without the shell, the arguments are displayed as a list.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Whenever possible, avoid using the shell to improve both performance and maintainability</td>
</tr></table>
</div>
<h3 id="_inputs_and_outputs">8.4. Inputs and outputs</h3><div style="clear:left"></div>
<div class="paragraph"><p>Source and target arguments are optional for make-like task generators, and may point at one or several files at once. Here are a few examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath(env)} &amp;&amp; cp ${SRC} ${TGT[1].abspath(env)}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'f1.txt f2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                shell  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo ${SRC}'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.k3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo "test" &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo 1337'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"echo 'task always run'"</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Generate <em>two files</em> whenever the input or the rule change. Likewise, a rule-based task generator may have multiple input files.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The command is executed whenever the input or the rule change. There are no declared outputs.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
No input, the command is executed whenever it changes
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
No input and no output, the command is executed only when the string expression changes
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
No input and no output, the command is executed each time the build is called
</td></tr>
</table></div>
<div class="paragraph"><p>For the record, here is the output of the build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.093s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/5] echo 1337:</span>
<span style="color: #000000">1337</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">[3/5] echo ${SRC}: wscript</span>
<span style="color: #000000">../wscript</span>
<span style="color: #000000">[4/5] f1.txt f2.txt: wscript -&gt; out/default/f1.txt out/default/f2.txt</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">[5/5] test.k3:  -&gt; out/default/test.k3</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.049s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<h3 id="_sharing_data">8.5. Sharing data</h3><div style="clear:left"></div>
<div class="paragraph"><p>Data sharing is performed through the configuration set. The following example illustrates how to use it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'prefix: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">PREFIX</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'jobs:   %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">jobs</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'t1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo ${PREFIX} &gt; ${TGT}'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'t2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo ${TEST_VAR} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>
<span style="color: #000000">        obj</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">TEST_VAR </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">str</span><span style="color: #000000">(</span><span style="color: #000000">Options</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">jobs</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo "hey"'</span><span style="color: #000000">,</span>
<span style="color: #000000">                vars </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'TEST_VAR'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                env  </span><span style="color: #000000">=</span><span style="color: #000000"> obj</span><span style="color: #000000">.</span><span style="color: #000000">env </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The <em>PREFIX</em> is one of the few predefined variables. It is necessary for computing the default installation path.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The following rule will create the file <em>t2.txt</em> with the contents of <em>TEST_VAR</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The value of <em>TEST_VAR</em> will be defined now
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Use the value of a predefined command-line option (the jobs control the amount of commands which may be executed in parallel)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
By default, the variables used in string expressions <em>${&#8230;}</em> are extracted automatically and used as dependencies (rebuild the targets when the value change). They are given manually in this case.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Set the base environment. The variable TEST_VAR will be used for the dependency here.
</td></tr>
</table></div>
<div class="paragraph"><p>By turning the debugging flags on, it will be easier to understand what is happening during the build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=runner,action</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">prefix: '/usr/local' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">jobs:   2</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">15:21:29 action</span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        p = env.get_flat</span>
<span style="color: #000000">        cmd = ''' echo %s &gt; %s ''' % (p('PREFIX'), <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                " ".join([a.bldpath(env) for a in task.outputs]))</span>
<span style="color: #000000">        return task.exec_command(cmd, cwd=wd)</span>

<span style="color: #000000">[...] <img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">[1/3] t2.txt:  -&gt; out/default/t2.txt</span>
<span style="color: #000000">15:21:29 runner system command -&gt;  echo 2 &gt; default/t2.txt</span>
<span style="color: #000000">[2/3] t1.txt:  -&gt; out/default/t1.txt</span>
<span style="color: #000000">15:21:29 runner system command -&gt;  echo /usr/local &gt; default/t1.txt <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/3] echo "hey":</span>
<span style="color: #000000">18:05:26 runner system command -&gt;  echo "hey"</span>
<span style="color: #000000">hey</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.052s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --jobs=17 --zones=runner</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/3] t2.txt:  -&gt; out/default/t2.txt</span>
<span style="color: #000000">15:23:24 runner system command -&gt;  echo 17 &gt; default/t2.txt <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">[2/3] echo "hey": <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">hey</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The default values for prefix and jobs.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The function generated from the string expression will use the <em>PREFIX</em> value.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Some output was removed.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The expression <em>${PREFIX}</em> was substituted by its value.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The target is created whenever the value of a variable changes, even though the string expression has not changed.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The variable <em>TEST_VAR</em> changed, so the command was executed again.
</td></tr>
</table></div>
<h3 id="_execution_order_and_dependencies">8.6. Execution order and dependencies</h3><div style="clear:left"></div>
<div class="paragraph"><p>Although task generators will create the tasks in the relevant order, tasks are executed in parallel and the compilation order may not be the order expected. In the example from the previous section, the target <em>t2.txt</em> was processed before the target <em>t1.txt</em>. We will now illustrate two important concepts used for the build specification:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
order: sequential constraints between the tasks being executed (here, the commands)
</p>
</li>
<li>
<p>
dependency: executing a task if another task is executed
</p>
</li>
</ol></div>
<div class="paragraph"><p>For illustation purposes, let&#8217;s create the following chain <em>wscript</em> → <em>w1.txt</em> → <em>w2.txt</em>. The order constraint is given by the attribute <em>after</em> which references a task class name. For rule-based task generators, the task class name is bound to the attribute <em>name</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w2.txt'</span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> w1</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be similar to the following. Note that both files are created whenever the first source file <em>wscript</em> changes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] w1: wscript -&gt; out/default/w1.txt</span>
<span style="color: #000000">[2/2] w2.txt: out/default/w1.txt -&gt; out/default/w2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.055s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] w1: wscript -&gt; out/default/w1.txt</span>
<span style="color: #000000">[2/2] w2.txt: out/default/w1.txt -&gt; out/default/w2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.018s)</span></tt></pre></div></div>
<div class="paragraph"><p>Although the order constraint between w1 and w2 is trivial to find in this case, implicit constraints can be a source of confusion for large projects. For this reason, the default is to <em>encourage</em> the explicit order declaration. Nevertheless, a special method may be used to let the system look at all source and target files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">use_the_magic</span><span style="color: #000000">()</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'w2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">The method <em>bld.use_the_magic()</em> will not work for tasks that do not have clear input and output files and will degrade performance for large builds.</td>
</tr></table>
</div>
<h3 id="_dependencies_on_file_contents">8.7. Dependencies on file contents</h3><div style="clear:left"></div>
<div class="paragraph"><p>As a second example, we will create a file named <em>r1.txt</em> from the current date. It will be updated each time the build is executed. A second file named <em>r2.txt</em> will be created from <em>r1.txt</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Give the task generator a name, it will create a task class of the same name to execute the command
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create <em>r1.txt</em> with the date
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
There is no source file to depend on and the rule never changes. The task is then set to be executed each time the build is started by using the attribute <em>always</em>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
If no name is provided, the rule is used as a name for the task class
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Use <em>r1.txt</em> as a source for <em>r2.txt</em>. Since <em>r1.txt</em> was declared before, the dependency will be added automatically (<em>r2.txt</em> will be re-created whenever <em>r1.txt</em> changes)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Set the command generating <em>r2.txt</em> to be executed after the command generating <em>r1.txt</em>. The attribute <em>after</em> references task class names, not task generators. Here it will work because rule-based task generator tasks inherit the <em>name</em> attribute
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/default/r1.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  (date &gt; default/r1.txt) &amp;&amp; cat default/r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:39 CET 2010</span>
<span style="color: #000000">[2/2] r2: out/default/r1.txt -&gt; out/default/r2.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  cp default/r1.txt default/r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/default/r1.txt</span>
<span style="color: #000000">16:44:41 runner system command -&gt;  (date &gt; default/r1.txt) &amp;&amp; cat default/r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:41 CET 2010</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span></tt></pre></div></div>
<div class="paragraph"><p>Although r2 <strong>depends</strong> on <em>r1.txt</em>, r2 was not executed in the second build. As a matter of fact, the signature of the task r1 has not changed, and r1 was only set to be executed each time, regardless of its signature. Since the signature of the <em>r1.txt</em> does not change, the signature of r2 will not change either, and <em>r2.txt</em> is considered up-to-date.</p></div>
<div class="paragraph"><p>We will now illustrate how to make certain that the outputs reflect the file contents and trigger the rebuild for dependent tasks by enabling the attribute <em>on_results</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                on_results </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Here <em>r2.txt</em> will be re-created each time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/default/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; default/r1.txt) &amp;&amp; cat default/r1.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[2/2] r2: out/default/r1.txt -&gt; out/default/r2.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  cp default/r1.txt default/r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/default/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; default/r1.txt) &amp;&amp; cat default/r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/default/r1.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  (date &gt; default/r1.txt) &amp;&amp; cat default/r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:53 CET 2010 <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/2] r2: out/default/r1.txt -&gt; out/default/r2.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  cp default/r1.txt default/r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Start with a clean build, both <em>r1.txt</em> and <em>r2.txt</em> are created
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Notice the date and time
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The second build was executed at the same date and time, so <em>r1.txt</em> has not changed, therefore <em>r2.txt</em> is up to date
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The third build is executed at another date and time. Since <em>r1.txt</em> has changed, <em>r2.txt</em> is created once again
</td></tr>
</table></div>
</div>
<h2 id="_name_and_extension_based_file_processing">9. Name and extension-based file processing</h2>
<div class="sectionbody">
<div class="paragraph"><p>Transformations may be performed automatically based on the file name or on the extension.</p></div>
<h3 id="_refactoring_repeated_rule_based_task_generators_into_implicit_rules">9.1. Refactoring repeated rule-based task generators into implicit rules</h3><div style="clear:left"></div>
<div class="paragraph"><p>The explicit rules described in the previous chapter become limited for processing several files of the same kind. The following code may lead to unmaintainable scripts and to slow builds (for loop):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">:</span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> x</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #000000">x</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">)</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Rather, the rule should be removed from the user script, like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The equivalent logic may then be provided by using the following code. It may be located in either the same <em>wscript</em>, or in a waf tool:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        shell     </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        install   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The name for the corresponding task class to use
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The rule is the same as for any rule-based task generator
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Input file, processed by extension
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Output files extensions separated by spaces. In this case there is only one output file
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The reentrant attribute is used to add the output files as source again, for processing by another implicit rule
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
String representing the installation path for the output files, similar to the destination path from <em>bld.install_files</em>. To disable installation, set it to False.
</td></tr>
</table></div>
<h3 id="_chaining_more_than_one_command">9.2. Chaining more than one command</h3><div style="clear:left"></div>
<div class="paragraph"><p>Now consider the long chain <em>uh.in</em> → <em>uh.a</em> → <em>uh.b</em> → <em>uh.c</em>. The following implicit rules demonstrate how to generate the files while maintaining a minimal user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'a'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'b'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.c'</span><span style="color: #000000">,</span><span style="color: #000000"> reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>During the build phase, the correct compilation order is computed based on the extensions given:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.090s)</span>
<span style="color: #000000">Waf: Entering directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">[1/3] a: uh.in -&gt; build/default/uh.a</span>
<span style="color: #000000">[2/3] b: build/default/uh.a -&gt; build/default/uh.b</span>
<span style="color: #000000">[3/3] c: build/default/uh.b -&gt; build/default/uh.c</span>
<span style="color: #000000">Waf: Leaving directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span></tt></pre></div></div>
<h3 id="_scanner_methods">9.3. Scanner methods</h3><div style="clear:left"></div>
<div class="paragraph"><p>Because transformation chains rely on implicit transformations, it may be desirable to hide some files from the list of sources. Or, some dependencies may be produced conditionally and may not be known in advance. A <em>scanner method</em> is a kind of callback used to find additional dependencies just before the target is generated. For illustration purposes, let us start with an empty project containing three files: the <em>wscript</em>, <em>ch.in</em> and <em>ch.dep</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- ch.dep</span>
<span style="color: #000000">|-- ch.in</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The build will create a copy of <em>ch.in</em> called <em>ch.out</em>. Also, <em>ch.out</em> must be rebuild whenever <em>ch.dep</em> changes. This corresponds more or less to the following Makefile:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">ch.out:</span><span style="color: #000000"> ch.in ch.dep</span>
<span style="color: #000000">        cp ch.in ch.out</span></tt></pre></div></div>
<div class="paragraph"><p>The user script should only contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span>
<span style="color: #000000">out</span><span style="color: #000000">=</span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'ch.in'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The code below is independent from the user scripts and may be located in a Waf tool.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan_meth</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">        dep </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">name</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.dep'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> dep</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">raise</span><span style="color: #000000"> </span><span style="color: #000000">ValueError</span><span style="color: #000000">(</span><span style="color: #009900">"Could not find the .dep file for %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">([</span><span style="color: #000000">dep</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'copy'</span><span style="color: #000000">,</span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        scan      </span><span style="color: #000000">=</span><span style="color: #000000"> scan_meth</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The scanner method accepts a task object as input (not a task generator)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use node methods to locate the dependency (and raise an error if it cannot be found)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Scanner methods return a tuple containing two lists. The first list contains the list of node objects to depend on. The second list contains private data such as debugging information. The results are cached between build calls so the contents must be serializable.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Add the scanner method to chain declaration
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.in</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.dep <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/out'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; out/default/ch.out <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/out'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/out'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/out'</span>
<span style="color: #000000">'build' finished successfully (0.005s) <img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ echo 2 &gt; ch.dep <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/out'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; out/default/ch.out <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/out'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Initialize the file contents of <em>ch.in</em> and <em>ch.dep</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Execute a first clean build. The file <em>ch.out</em> is produced
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The target <em>ch.out</em> is up-to-date because nothing has changed
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Change the contents of <em>ch.dep</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The dependency has changed, so the target is rebuilt
</td></tr>
</table></div>
<div class="paragraph"><p>Here are a few important points about scanner methods:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
they are executed only when the target is not up-to-date.
</p>
</li>
<li>
<p>
they may not modify the <em>task</em> object or the contents of the configuration set <em>task.env</em>
</p>
</li>
<li>
<p>
they are executed in a single main thread to avoid concurrency issues
</p>
</li>
<li>
<p>
the results of the scanner (tuple of two lists) are re-used between build executions (and it is possible to access programatically those results)
</p>
</li>
<li>
<p>
the make-like rules also accept a <em>scan</em> argument (scanner methods are bound to the task rather than the task generators)
</p>
</li>
<li>
<p>
they are used by Waf internally for c/c++ support, to add dependencies dynamically on the header files (<em>.c</em> → <em>.h</em>)
</p>
</li>
</ol></div>
<h3 id="_extension_callbacks">9.4. Extension callbacks</h3><div style="clear:left"></div>
<div class="paragraph"><p>In the chain declaration from the previous sections, the attribute <em>reentrant</em> was described to control if the generated files are to be processed or not. There are cases however where one of the two generated files must be declared (because it will be used as a dependency) but where it cannot be considered as a source file in itself (like a header in c/c++). Now consider the following two chains (<em>uh.in</em> → <em>uh.a1</em> + <em>uh.a2</em>) and (<em>uh.a1</em> → <em>uh.b</em>) in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a'</span><span style="color: #000000">,</span>
<span style="color: #000000">        action    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.a2'</span><span style="color: #000000">],</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span>

<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        action    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The following error message will be produced:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject'</span>
<span style="color: #000000">Cannot guess how to process bld:///tmp/smallproject/uh.a2 (got mappings ['.a1', '.in'] in</span>
<span style="color: #000000">   class TaskGen.task_gen) -&gt; try conf.check_tool(..)?</span></tt></pre></div></div>
<div class="paragraph"><p>The error message indicates that there is no way to process <em>uh.a2</em>. Only files of extension <em>.a1</em> or <em>.in</em> can be processed. Internally, extension names are bound to callback methods. The error is raised because no such method could be found, and here is how to register an extension callback globally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.a2'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="paragraph"><p>To register an extension callback locally, a reference to the task generator object must be kept:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">callback</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">pass</span>
<span style="color: #000000">        obj</span><span style="color: #000000">.</span><span style="color: #000000">mappings</span><span style="color: #000000">[</span><span style="color: #009900">'.a2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> callback</span></tt></pre></div></div>
<div class="paragraph"><p>The exact method signature and typical usage for the extension callbacks is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">".a"</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">".b"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">my_callback</span><span style="color: #000000">(</span><span style="color: #000000">task_gen_object</span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000">):</span>
<span style="color: #000000">        task_gen_object</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span>
<span style="color: #000000">                task_name</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                node</span><span style="color: #000000">,</span><span style="color: #000000">  </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                output_nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Comma-separated list of extensions (strings)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task generator instance holding the data
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Instance of Node, representing a file (either source or build)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The first argument to create a task is the name of the task class
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The second argument is the input node (or a list of nodes for several inputs)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The last parameter is the output node (or a list of nodes for several outputs)
</td></tr>
</table></div>
<div class="paragraph"><p>The creation of new task classes will be described in the next section.</p></div>
<h3 id="_task_class_declaration">9.5. Task class declaration</h3><div style="clear:left"></div>
<div class="paragraph"><p>Waf tasks are instances of the class Task.TaskBase. Yet, the base class contains the real minimum, and the immediate subclass <em>Task.Task&#8217;is usually chosen in user scripts. We will now start over with a simple project containing only one project 'wscript</em> file and and example file named <em>ah.in</em>. A task class will be added.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'abcd'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">abcd</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'executing...'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new instance of <em>abcd</em>. The method <em>create_task</em> is a shortcut to make certain the task will keep a reference on its task generator.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Inherit the class Task located in the module Task.py
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The method run is called when the task is executed
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The task return status must be an integer, which is zero to indicate success. The tasks that have failed will be executed on subsequent builds
</td></tr>
</table></div>
<div class="paragraph"><p>The output of the build execution will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">&lt;class 'wscript_main.abcd'&gt;</span>
<span style="color: #000000">[1/1] abcd:</span>
<span style="color: #000000">executing...</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="paragraph"><p>Although it is possible to write down task classes in plain python, two functions (factories) are provided to simplify the work, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'xsubpp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        rule    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${PERL} ${XSUBPP} ${SRC} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        before  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build_it</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span>

<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">task_type_from_func</span><span style="color: #000000">(</span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'sometask'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        func    </span><span style="color: #000000">=</span><span style="color: #000000"> build_it</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">        vars    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'SRT'</span><span style="color: #000000">],</span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'RED'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new task class executing a rule string
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task class name
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Rule to execute during the build
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Color for the output during the execution
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Execute the task instance before any instance of task classes named <em>cc</em>. The opposite of <em>before</em> is <em>after</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Create a new task class from a custom python function. The <em>vars</em> attribute represents additional configuration set variables to use as dependencies
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Task class name
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Function to use
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
In this context, the extension names are meant to be used for computing the execution order with other tasks, without naming the other task classes explicitly
</td></tr>
</table></div>
<div class="paragraph"><p>Note that most attributes are common between the two function factories. More usage examples may be found in most Waf tools.</p></div>
<h3 id="_source_attribute_processing">9.6. Source attribute processing</h3><div style="clear:left"></div>
<div class="paragraph"><p>The first step in processing the source file attribute is to convert all file names into Nodes. Special methods may be mapped to intercept names by the exact file name entry (no extension). The Node objects are then added to the task generator attribute <em>allnodes</em>.</p></div>
<div class="paragraph"><p>The list of nodes is then consumed by regular extension mappings. Extension methods may re-inject the output nodes for further processing by appending them to the the attribute <em>allnodes</em> (hence the name re-entrant provided in declare_chain).</p></div>
<div class="imageblock">
<div class="content">
<img src="source.png" alt="Source attribute processing" width="850" />
</div>
</div>
</div>
<h2 id="_general_purpose_task_generators">10. General purpose task generators</h2>
<div class="sectionbody">
<div class="paragraph"><p>So far, various task generators uses have been demonstrated. This chapter provides a detailed description of task generator structure and usage.</p></div>
<h3 id="_task_generator_definition">10.1. Task generator definition</h3><div style="clear:left"></div>
<div class="paragraph"><p>The chapter on make-like rules illustrated how the attribute <em>rule</em> is processed. Then the chapter on name and extension-based file processing illustrated how the attribute <em>source</em> is processed (in the absence of the rule attribute). To process <em>any attribute</em>, the following properties should hold:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Attributes should be processed only when the task generator is set to generate the tasks (lazy processing)
</p>
</li>
<li>
<p>
There is no list of authorized attributes (task generators may be extended by user scripts)
</p>
</li>
<li>
<p>
Attribute processing should be controlable on a task generator instance basis (special rules for particular task generators)
</p>
</li>
<li>
<p>
The extensions should be split into independent files (low coupling between the Waf tools)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Implementing such a system is a difficult problem which lead to the creation of very different designs:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>A hierarchy of task generator subclasses</em> It was abandoned due to the high coupling between the Waf tools: the C tools required knowledge from the D tool for building hybrid applications
</p>
</li>
<li>
<p>
<em>Method decoration (creating linked lists of method calls)</em> Replacing or disabling a method safely was no longer possible (addition-only), so this system disappeared quickly
</p>
</li>
<li>
<p>
<em>Flat method and execution constraint declaration</em> The concept is close to aspect-oriented programming and may scare programmers.
</p>
</li>
</ol></div>
<div class="paragraph"><p>So far, the third design proved to be the most flexible and was kept. Here is how to define a task generator method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        v </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myattr </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myMethod</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">myMethod</span><span style="color: #000000">(</span><span style="color: #000000">tgen</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Attributes may be set by arguments or by accessing the object. It is set two times in this example.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Call the task generator method explicitly
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Use a python decorator
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Task generator methods have a unique argument representing the current instance
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Process the attribute <em>myattr</em> when present (the case in the example)
</td></tr>
</table></div>
<div class="paragraph"><p>The output from the build will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">hello world</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The method could be bound by using <em>setattr</em> directly, like for binding any new method on a python class.</td>
</tr></table>
</div>
<h3 id="_executing_the_method_during_the_build">10.2. Executing the method during the build</h3><div style="clear:left"></div>
<div class="paragraph"><p>So far, the task generator methods defined are only executed through explicit calls. Another decorator is necessary to have a task generator executed during the build phase automatically. Here is the updated example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">methodName</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Bind a method to the task generator class (optional when other methods such as <em>TaskGen.feature</em> are used)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Bind the method to the symbol <em>myfeature</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">23:03:44 task_gen posting &gt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 139657958706768 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; exec_rule (139657958706768) <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; apply_core (139657958706768) <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; methodName (139657958706768) <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Hello, world!</span>
<span style="color: #000000">23:03:44 task_gen posted <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The debugging zone <em>task_gen</em> is used to display the task generator methods being executed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Display which task generator is being executed
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The method <em>exec_rule</em> is used to process the <em>rule</em>. It is always executed.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The method <em>apply_core</em> is used to process the <em>source</em> attribute. It is always executed exept if the method <em>exec_rule</em> processes a <em>rule</em> attribute
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Our task generator method is executed, and prints <em>Hello, world!</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The task generator methods have been executed, the task generator is marked as done (posted)
</td></tr>
</table></div>
<h3 id="_task_generator_features">10.3. Task generator features</h3><div style="clear:left"></div>
<div class="paragraph"><p>So far, the task generator methods we added were declared to be executed by all task generator instances. Limiting the execution to specific task generators requires the use of the <em>feature</em> decorator:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping pong'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pong</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237584</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; apply_core (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237584)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237776</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; apply_core (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; pong (140631018237776)</span>
<span style="color: #000000">pong</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237776)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/out'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Although the task generator instances are processed in order, the task generator method execution requires a specific declaration for the order of execution. Here, the method <em>pong_</em> is executed before the method <em>ping_</em></td>
</tr></table>
</div>
<h3 id="_task_generator_method_execution_order">10.4. Task generator method execution order</h3><div style="clear:left"></div>
<div class="paragraph"><p>To control the execution order, two new decorators need to be added. We will now show a new example with two custom task generator methods <em>method1</em> and <em>method2</em>, executed in that order:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'apply_core'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'exec_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method1</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 1 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'apply_core'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'method1'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method2</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 2 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt> waf distclean configure build --zones=task_gen
'distclean' finished successfully (0.003s)
'configure' finished successfully (0.001s)
Waf: Entering directory `/tmp/simpleproject/out'
15:54:02 task_gen posting objects (normal)
15:54:02 task_gen posting &lt;task_gen of type task_gen defined in dir:///tmp/simpleproject&gt; 139808568487632
15:54:02 task_gen -&gt; method1 (139808568487632)
method 1 'Hello, world!'
15:54:02 task_gen -&gt; exec_rule (139808568487632)
15:54:02 task_gen -&gt; method2 (139808568487632)
method 2 'Hello, world!'
15:54:02 task_gen -&gt; apply_core (139808568487632)
15:54:02 task_gen posted
Waf: Leaving directory `/tmp/simpleproject/out'
15:54:02 task_gen posting objects (normal)
'build' finished successfully (0.005s)</tt></pre>
</div></div>
<h3 id="_adding_or_removing_a_method_for_execution">10.5. Adding or removing a method for execution</h3><div style="clear:left"></div>
<div class="paragraph"><p>The order constraints on the methods (after/before), are used to sort the list of methods in the attribute <em>meths</em>. The sorting is performed once, and the list is consumed as methods are executed. Though no new feature may be added once the first method is executed, new methods may be added dynamically in self.meths. Here is how to create an infinite loop by adding the same method at the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">infinite_loop</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'infinite_loop'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Likewise, methods may be removed from the list of methods to execute:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'apply_core'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">remove_apply_core</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">remove</span><span style="color: #000000">(</span><span style="color: #009900">'apply_core'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The task generator method workflow is represented in the following illustration:</p></div>
<div class="imageblock">
<div class="content">
<img src="posting.png" alt="Task generator workflow" width="544" />
</div>
</div>
<h3 id="_expressing_abstract_dependencies_between_task_generators">10.6. Expressing abstract dependencies between task generators</h3><div style="clear:left"></div>
<div class="paragraph"><p>We will now illustrate how task generator methods can be used to express abstract dependencies between task generator objects. Here is a new project file located under <em>/tmp/targets/</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>By executing <em>waf --targets=B</em>, only the task generator <em>B</em> will create its tasks, and the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.042s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">[1/1] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.032s)</span></tt></pre></div></div>
<div class="paragraph"><p>Here is a way to ensure that the task generator <em>A</em> has created its tasks when <em>B</em> does:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">,</span><span style="color: #000000"> depends_on</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before</span>
<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'apply_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post_the_other</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    deps </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'depends_on'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> name </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">deps</span><span style="color: #000000">):</span>
<span style="color: #000000">        other </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">name_to_obj</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (before) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        other</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (after) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
This method will be executed for all task generators, before the attribute <tt>rule</tt> is processed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Try to process the attribute <tt>depends_on</tt>, if present
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Obtain the task generator by name, and for the same variant
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Force the other task generator to create its tasks
</td></tr>
</table></div>
<div class="paragraph"><p>The output will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">other task generator tasks (before) [] <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">other task generator tasks (after) [ <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        {task: A  -&gt; }]</span>
<span style="color: #000000">[1/2] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">[2/2] A: <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">A</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The other task generator has not created any task yet
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
A task generator creates all its tasks by calling its method <tt>post()</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Although <tt>--targets=B</tt> was requested, the task from target <em>A</em> was created and executed too
</td></tr>
</table></div>
<div class="paragraph"><p>In practice, the dependencies will often re-use the task objects created by the other task generator: node, configuration set, etc. This is used by the uselib system (see the next chapter on c/c++ builds).</p></div>
</div>
<h2 id="_the_task_system">11. The Task system</h2>
<div class="sectionbody">
<div class="paragraph"><p>Task objects are created by task generators. They represent atomic transformations performed in the build phase.</p></div>
<h3 id="_task_creation_and_execution">11.1. Task creation and execution</h3><div style="clear:left"></div>
<div class="paragraph"><p>Creating all tasks by hand is a tedious process that the task generators may automate. Before starting the build, Waf asks each task generator to produce the corresponding tasks. If Waf is launched from a sub folder inside the source directory, it will try to avoid the creation of the tasks that are not relevant for that particular sub folder (optimization).</p></div>
<div class="paragraph"><p>Here are a few motives for using the task generators to create the tasks instead of creating them manually:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Lazy creation: building only a part of the project is a common scenario
</p>
</li>
<li>
<p>
Filesystem access: the filesystem requirements such as new folders will be created ahead of time
</p>
</li>
<li>
<p>
Concurrency issues: tasks are executed in parallel and may lead to complex bugs if initialized improperly
</p>
</li>
</ol></div>
<div class="paragraph"><p>A summary can be found on the following diagram:</p></div>
<div class="imageblock">
<div class="content">
<img src="task_execution.png" alt="Flowchart model" width="629" />
</div>
</div>
<h3 id="_task_execution">11.2. Task execution</h3><div style="clear:left"></div>
<div class="paragraph"><p>Executing a task consists in calling the method <em>run</em> on that task, and setting the task execution state.
The following diagram is a summary of the process:</p></div>
<div class="imageblock">
<div class="content">
<img src="task_run.png" alt="Task execution" width="425" />
</div>
</div>
<div class="paragraph"><p>The method <em>post_run</em> can be used to check if the files have been produced, it must throw an OSError if the task has not completed properly.</p></div>
<h3 id="_task_execution_in_parallel">11.3. Task execution in parallel</h3><div style="clear:left"></div>
<div class="paragraph"><p>Tasks may be executed in parallel to take advantage of the hardware (multi-core) or the environment (distributed builds). By default Waf does not execute immediately the tasks that are ready. Instead, tasks are added to a queue which is consumed by threads. Waf detects the number of installed processors. For uni-processor only one task is executed at a time, for dual-processors two tasks are executed at a time, and so on. To disable task parallelization, use the option <em>-j1</em>. To enhance parallelization, use the option <em>-j</em> with the amount of consumers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -j3</span></span></tt></pre></div></div>
<div class="paragraph"><p>By default, Waf does not allow consumer threads to access the tasks directly:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
There is little need for parallelizing the computation of the next task to execute, choosing the next task is fast enough
</p>
</li>
<li>
<p>
The thread issues are limited to a very small section of the code
</p>
</li>
<li>
<p>
The producer-consumer scheme prevents <em>busy waiting</em> for the next task
</p>
</li>
<li>
<p>
A simple global error handler can be used for processing the errors and to decide to stop the build
</p>
</li>
</ol></div>
<div class="paragraph"><p>The following illustrates the relationship producer-consumer performed for the builds:</p></div>
<div class="imageblock">
<div class="content">
<img src="parallel.png" alt="Parallel execution" width="850" />
</div>
</div>
<h3 id="_task_execution_order">11.4. Task execution order</h3><div style="clear:left"></div>
<div class="paragraph"><p>Running tasks in parallel is a simple problem, but in practice it is more complicated:
. Dependencies can be discovered during the build (dynamic task creation)
. New ordering constraints can be discovered after files are compiled
. The amount of tasks and ordering constraints (graph size) can be huge and performance may be a problem</p></div>
<div class="paragraph"><p>To make the problem more simple, it is divided by the different concerns, and the ordering constraints can be given on three different levels:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
groups of tasks may run only after another group of tasks has finished to run, this represents a strict sequential order between groups of tasks, for example a compiler is produced and used to compile the tasks in the next group
</p>
</li>
<li>
<p>
task types to indicate the instance will run after other task type instances, for example linking object files may only occur after compiling the source files
</p>
</li>
<li>
<p>
specific constraints for task instances that can only run after a few other task instances
</p>
</li>
</ol></div>
<h4 id="_task_groups">11.4.1. Task groups</h4>
<div class="paragraph"><p>In some circumstances it is necessary to build a compiler and all its dependencies before using it for executing some other tasks (bootstrapping). The following demonstrates how declare groups of tasks to be executed after other groups of tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'mycompiler'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'user.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'someotherapp'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The effect of task groups when running tasks in parallel is illustrated by the following diagram. Three groups of tasks have been added, and the execution of the next group only starts when the execution of the tasks in the previous group is complete.</p></div>
<div class="imageblock">
<div class="content">
<img src="output-ADDGROUP.png" alt="Task groups" width="595" />
</div>
</div>
<div class="paragraph"><p>It is possible to create groups at any point in the scripts, and to add the task generators to any group previously created. Adding groups for specific folders or scripts enables a behaviour similar to projects organized in recursive Makefiles.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'test1'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'test2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'test3'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'test4'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'adding task generators'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'test3'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main3.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'g3'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'test1'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main1.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'g1'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'test2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        obj2 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main2.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'g2'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'test4'</span><span style="color: #000000">)</span>
<span style="color: #000000">        obj2</span><span style="color: #000000">.</span><span style="color: #000000">clone</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Because task groups prevent parallelization, they reduce performance. On the other hand, they make projects more structured and improve the maintainance.</p></div>
<h4 id="_precedence_constraints">11.4.2. Precedence constraints</h4>
<div class="paragraph"><p>The attributes <em>before</em> and <em>after</em> are used to declare ordering constraints between tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">        before </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'task_test_b'</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">        after </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'task_test_a'</span></tt></pre></div></div>
<div class="paragraph"><p>Another way to declare precedence constraints is to declare a file extension production, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">        ext_in </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.c'</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.c'</span></tt></pre></div></div>
<div class="paragraph"><p>The <em>extensions</em> ext_in and ext_out have to match to add a valid precedence constraint, but they are only symbols in this context. They do not mean the tasks actually have to produce files of that type.</p></div>
<h4 id="_precedence_constraints_on_task_instances">11.4.3. Precedence constraints on task instances</h4>
<div class="paragraph"><p>The method <em>set_run_after</em> is used to declare ordering constraints between tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">task1</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">task2</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>unlike the previous constraints, it is used on the instances of class <em>Task</em> which is a subclass of class <em>TaskBase</em></p></div>
<h3 id="_executing_tasks_only_when_something_changes">11.5. Executing tasks only when something changes</h3><div style="clear:left"></div>
<div class="paragraph"><p>The direct instances of TaskBase are quite limited and do not track the changes to the source files. The class <em>Task</em> provides the necessary features for the most common builds in which source files are used to produce target files. The idea is to create a unique signature for tasks, and to represent the dependencies on files or other tasks by including them in the signature. A hashing function is used for computing the signature, by default it is md5.</p></div>
<div class="paragraph"><p>The following diagram illustrates the task processing including the signature, it is only valid for Task instance (not TaskBase instances):</p></div>
<div class="imageblock">
<div class="content">
<img src="task_signature.png" alt="Signatures" width="544" />
</div>
</div>
<div class="paragraph"><p>The signature computation uses the following data:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
explicit dependencies: input files and dependencies set explicitly using task.deps_man or bld.depends_on
</p>
</li>
<li>
<p>
implicit dependencies: dependencies searched by the task itself (like source files included from other source files).
</p>
</li>
<li>
<p>
parameters: compilation flags and command-line parameters.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example illustrating the different kinds of dependencies:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_demo</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        vars </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'CXXFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LINKFLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">[[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'.svn/entries'</span><span style="color: #000000">)],</span><span style="color: #000000"> </span><span style="color: #000000">[]]</span>

<span style="color: #000000">task </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">task_demo</span><span style="color: #000000">()</span>
<span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">inputs </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'test.cxx'</span><span style="color: #000000">)]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">deps_man </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">add_manual_dependency</span><span style="color: #000000">(</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'an arbitrary string value'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">add_manual_dependency</span><span style="color: #000000">(</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'test_c_program'</span><span style="color: #000000">),</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'bbb'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Environment variable dependencies (compilation flags)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Implicit dependencies: a method returns a list containing the list of additional nodes to take into account, and the list of the files that could not be found (cache)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Explicit dependencies as input files (nodes)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Explicit dependencies as manual dependencies
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Manual dependencies on source files, the second parameter can be a string, a node object or a function returning a string
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Manual dependencies with nodes, the first node represents a target (which may or may not exist in the build), and the second parameter represents a file in the source directory.
</td></tr>
</table></div>
</div>
<h2 id="_the_scheduler_for_executing_the_tasks">12. The scheduler for executing the tasks</h2>
<div class="sectionbody">
<div class="paragraph"><p>Tasks are executed in parallel during the build phase, yet with a few restrictions.</p></div>
<h3 id="_the_task_execution_model">12.1. The task execution model</h3><div style="clear:left"></div>
<div class="paragraph"><p>Task dependencies and task ordering specify the exact order in which tasks must be executed. When tasks are executed in parallel, different algorithms may be used to improve the compilation times. For example, tasks that are known to last longer may be launched first. Linking tasks that use a lot of ram (in the context of c++ applications) may be launched alone to avoid disk thrashing by saving RAM.</p></div>
<div class="paragraph"><p>To make this possible, the task execution is organized in the following manner:</p></div>
<div class="imageblock">
<div class="content">
<img src="task_grouping.png" alt="Execution model" width="374" />
</div>
</div>
<h3 id="_job_control">12.2. Job control</h3><div style="clear:left"></div>
<div class="paragraph"><p>Job control is related to the parallelization algorithms used for launching the tasks. While the aim of parallelization is to maximize the amount of tasks executed in parallel, different algorithms may be used</p></div>
<div class="paragraph"><p>In the NORMAL ordering, task groups are created, and a topological sort is performed on the task class types. The overall performance penalty for complete builds is usually small, like a few seconds on builds during minutes.</p></div>
<div class="imageblock">
<div class="content">
<img src="output-NORMAL.png" alt="NORMAL" width="595" />
</div>
</div>
<div class="paragraph"><p>In the JOBCONTROL ordering, groups are created in advance, and a flag indicates the maximum amount of jobs to be used when the consumer threads execute the tasks. This prevents parallelization of tasks which use a lot of resources. For example, linking c++ object files uses a lot of RAM.</p></div>
<div class="imageblock">
<div class="content">
<img src="output-JOBCONTROL.png" alt="JOBCONTROL" width="595" />
</div>
</div>
<div class="paragraph"><p>In the MAXPARALLEL ordering, Each task holds a list of tasks it must run after (there is only one list of tasks waiting to be executed). Though this version parallelizes tasks very well, it consumes more memory and processing. In practice, Waf may last 20% more on builds when all tasks are up-to-date.</p></div>
<div class="imageblock">
<div class="content">
<img src="output-MAXPARALLEL.png" alt="MAXPARALLEL" width="595" />
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Because most task classes use ordering constraints, the maximum parallelization can only be achieved if the constraints between task classes are relaxed, and if all task instances know their predecessors. In the example graph, this was achieved by removing the ordering constraints between the compilation tasks classes and the link tasks classes.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #009900">'cxx'</span><span style="color: #000000">].</span><span style="color: #000000">ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Runner</span>
<span style="color: #000000">old_refill </span><span style="color: #000000">=</span><span style="color: #000000"> Runner</span><span style="color: #000000">.</span><span style="color: #000000">Parallel</span><span style="color: #000000">.</span><span style="color: #000000">refill_task_list</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">refill_task_list</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000000">old_refill</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span>
<span style="color: #000000">    lst </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outstanding</span>
<span style="color: #000000">    </span><span style="color: #000080">if</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">            </span><span style="color: #000080">for</span><span style="color: #000000"> y </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> x</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                    </span><span style="color: #000080">for</span><span style="color: #000000"> j </span><span style="color: #000080">in</span><span style="color: #000000"> y</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> i</span><span style="color: #000000">.</span><span style="color: #000000">id </span><span style="color: #000000">==</span><span style="color: #000000"> j</span><span style="color: #000000">.</span><span style="color: #000000">id</span><span style="color: #000000">:</span>
<span style="color: #000000">                            x</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Runner</span><span style="color: #000000">.</span><span style="color: #000000">Parallel</span><span style="color: #000000">.</span><span style="color: #000000">refill_task_list </span><span style="color: #000000">=</span><span style="color: #000000"> refill_task_list</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
relax the constraints between cxx and cxx_link (in the build section)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
override the definition of Runner.Parallel.refill_task_list
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
consider all task instances
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
infer the task orderings from input and output nodes
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
apply the constraint order
</td></tr>
</table></div>
<div class="paragraph"><p>From this, we can immediately notice the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
An assumption is made that all tasks have input and output nodes, and that ordering constraints can be deduced from them
</p>
</li>
<li>
<p>
Deducing the constraints from the input and output nodes exhibits a n^2 behaviour
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">In practice, the NORMAL algorithm should be used whenever possible, and the MAXPARALLEL should be used if substantial gains are expected and if the ordering is specified between all tasks. The JOBCONTROL system may be useful for tasks that consume a vast amount of resources.</td>
</tr></table>
</div>
<h3 id="_weak_task_order_constraints">12.3. Weak task order constraints</h3><div style="clear:left"></div>
<div class="paragraph"><p>Tasks that are known to take a lot of time may be launched first to improve the build times. The general problem of finding an optimal order for launching tasks in parallel and with constraints is called <a href="http://en.wikipedia.org/wiki/Job-shop_problem">Job Shop</a>. In practice this problem can often be reduced to a critical path problem (approximation).</p></div>
<div class="paragraph"><p>The following pictures illustrate the difference in scheduling a build with different independent tasks, in which a slow task is clearly identified, and launched first:</p></div>
<div class="imageblock">
<div class="content">
<img src="duration-1.png" alt="Random order" width="527" />
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="duration-2.png" alt="Slowest task first" width="527" />
</div>
</div>
<div class="paragraph"><p>Waf provides a function for reordering the tasks before they are launched in the module Runner, the default reordering may be changed by dynamic method replacement in Python:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Runner</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">get_next</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #808080"># reorder the task list by a random function</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">outstanding</span><span style="color: #000000">.</span><span style="color: #000000">sort</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #808080"># return the next task</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outstanding</span><span style="color: #000000">.</span><span style="color: #000000">pop</span><span style="color: #000000">()</span>
<span style="color: #000000">Runner</span><span style="color: #000000">.</span><span style="color: #000000">Parallel</span><span style="color: #000000">.</span><span style="color: #000000">get_next </span><span style="color: #000000">=</span><span style="color: #000000"> get_next</span></tt></pre></div></div>
<div class="paragraph"><p>If the reordering is not to be performed each time a task is retrieved, the list of task may be reordered when the next group is retrieved:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Runner</span>
<span style="color: #000000">old_refill </span><span style="color: #000000">=</span><span style="color: #000000"> Runner</span><span style="color: #000000">.</span><span style="color: #000000">Parallel</span><span style="color: #000000">.</span><span style="color: #000000">refill_task_list</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">refill_task_list</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">old_refill</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">outstanding</span><span style="color: #000000">.</span><span style="color: #000000">sort</span><span style="color: #000000">()</span>
<span style="color: #000000">Runner</span><span style="color: #000000">.</span><span style="color: #000000">Parallel</span><span style="color: #000000">.</span><span style="color: #000000">refill_task_list </span><span style="color: #000000">=</span><span style="color: #000000"> refill_task_list</span></tt></pre></div></div>
<div class="paragraph"><p>It is possible to measure the task execution times by intercepting the function calls. The task execution times may be re-used for optimizing the schedule for subsequent builds:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> time</span>
<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">old_call_run </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">call_run</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">new_call_run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        t1 </span><span style="color: #000000">=</span><span style="color: #000000"> time</span><span style="color: #000000">.</span><span style="color: #000000">time</span><span style="color: #000000">()</span>
<span style="color: #000000">        ret </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">old_call_run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span>
<span style="color: #000000">        t2 </span><span style="color: #000000">=</span><span style="color: #000000"> time</span><span style="color: #000000">.</span><span style="color: #000000">time</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> ret</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"execution time %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">t2 </span><span style="color: #000000">-</span><span style="color: #000000"> t1</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> ret</span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">call_run </span><span style="color: #000000">=</span><span style="color: #000000"> new_call_run</span></tt></pre></div></div>
</div>
<h2 id="_build_context_and_nodes">13. Build context and nodes</h2>
<div class="sectionbody">
<div class="paragraph"><p>Node objects are only visible through a few object (bld.path), and are used internally by task objects. Although their usage is somewhat restricted, there are a few useful applications from user scripts.</p></div>
<h3 id="_node_types">13.1. Node types</h3><div style="clear:left"></div>
<div class="paragraph"><p>Although nodes are use for representing the filesystem, there are only 3 node types:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Source nodes represent source files present on the file system. The signature for a source node is the hash of the file contents.
</p>
</li>
<li>
<p>
Build nodes represent files created under the build directory. While build nodes are not bound to the build variant, the build nodes may have several signatures corresponding to the variants in which the files have been created (the signature is the signature of the task that created the file).
</p>
</li>
<li>
<p>
Directory nodes represent the folders from the project directory. During the build phase, the folders corresponding to the source directory are automatically created for each variant into the build directory. Directory nodes have no associated signatures.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For example, for a project located in /tmp/nodes, using the rule <em>source.in</em> &#8594; <em>target.out</em> with three variants <em>default</em>, <em>debug</em> and <em>release</em>, the filesystem contents will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   |-- debug.cache.py</span>
<span style="color: #000000">|   |   |-- default.cache.py</span>
<span style="color: #000000">|   |   `-- release.cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   |-- debug</span>
<span style="color: #000000">|   |   `-- target.out</span>
<span style="color: #000000">|   |-- default</span>
<span style="color: #000000">|   `-- release</span>
<span style="color: #000000">|       `-- target.out</span>
<span style="color: #000000">|-- source.in</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>And the filesystem representation will consist in only three nodes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">dir:///tmp/nodes <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">src:///tmp/nodes/source.in <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">bld:///tmp/nodes/target.out <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The project directory. Directory nodes are represented by <em>dir://</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The source node for <em>source.in</em>. Source nodes are represented by <em>src://</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The build node for the outputs <em>target.out</em>. Build nodes are represented by <em>bld://</em>
</td></tr>
</table></div>
<div class="paragraph"><p>There can be only one node of a name for a given directory node. Because of this restriction, it is not possible to copy a file from the source directory to the corresponding build directory (for a given variant):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.png'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.png'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${SRC[0].parent.abspath(env)}/${SRC[0].name}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.png'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Forbidden
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Discouraged, but Ok.
</td></tr>
</table></div>
<h3 id="_build_context_creation_and_access">13.2. Build context creation and access</h3><div style="clear:left"></div>
<div class="paragraph"><p>For testing purposes, a function created from a build context instance could create another build context. Therefore, the build context is not a singleton. The task signatures and the dependent nodes are then bound to the build context instance that created them.</p></div>
<div class="paragraph"><p>Here is how to create a build context inside another build context:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">do_it</span><span style="color: #000000">():</span>

<span style="color: #000000">                </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Environment</span><span style="color: #000000">,</span><span style="color: #000000"> Build</span>
<span style="color: #000000">                bld </span><span style="color: #000000">=</span><span style="color: #000000"> Build</span><span style="color: #000000">.</span><span style="color: #000000">BuildContext</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">load_dirs</span><span style="color: #000000">(</span><span style="color: #009900">'/tmp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/tmp/build'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                env </span><span style="color: #000000">=</span><span style="color: #000000"> Environment</span><span style="color: #000000">.</span><span style="color: #000000">Environment</span><span style="color: #000000">()</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">all_envs</span><span style="color: #000000">[</span><span style="color: #009900">'default'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> env </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">init_variants</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">                </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo hi from the nested context!'</span><span style="color: #000000">,</span>
<span style="color: #000000">                        always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">)</span>

<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">compile</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo hi from the main buildcontext'</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">do_it</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new build context.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Set the project and the output folders
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Set the configuration data set
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Create the folder(s) <em>/tmp/build/variant</em> and initialize the build node signature cache
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Declare a task generator
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Execute a build
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Create a task generator for the main build context
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Call the function <em>do_it</em> to create immediately a new build context and to execute it
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/nested/build'</span>
<span style="color: #000000">[1/1] echo hi from the nested context!: <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">hi from the nested context!</span>
<span style="color: #000000">[1/1] echo hi from the main buildcontext:</span>
<span style="color: #000000">hi from the main buildcontext <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/nested/build'</span>
<span style="color: #000000">'build' finished successfully (0.018s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The nested build is executed immediately
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Trace from the normal build
</td></tr>
</table></div>
<div class="paragraph"><p>The task generators, the tasks, and the node objects are all bound to a particular build context. Here is how to access the different objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'root %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'path %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'path %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'bld %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">fun</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"task %r %r -&gt; %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span>
<span style="color: #000000">            </span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">),</span>
<span style="color: #000000">            task</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">            task</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">    obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #000000">fun</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'tgen %r -&gt; %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">obj</span><span style="color: #000000">),</span><span style="color: #000000"> obj</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">name_to_obj</span><span style="color: #000000">(</span><span style="color: #009900">'foo'</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Filesystem root
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Current path
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Project directory (top-level)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Access the build context instance from the class
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Get a reference to the task generator that created the task instance
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Get the build context corresponding to the task instance
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
The attribute <em>bld</em> of a task generator is the build context
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Obtain a task generator from the build context
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/nested/build'</span>
<span style="color: #000000">root &lt;class 'Node.Nodu'&gt;</span>
<span style="color: #000000">path dir:///tmp/nested</span>
<span style="color: #000000">src  dir:///tmp/nested</span>
<span style="color: #000000">bld &lt;Build.BuildContext object at 0x7f5472764490&gt;</span>
<span style="color: #000000">tgen &lt;class 'TaskGen.task_gen'&gt; -&gt; &lt;Build.BuildContext object at 0x7f5472764490&gt;</span>
<span style="color: #000000">&lt;task_gen 'foo' of type task_gen defined in dir:///tmp/nested&gt;</span>
<span style="color: #000000">[1/1] 1:</span>
<span style="color: #000000">task &lt;class 'Task.1'&gt; &lt;TaskGen.task_gen object at 0x7f547277b610&gt;</span>
<span style="color: #000000">     -&gt; &lt;Build.BuildContext object at 0x7f5472764490&gt;</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/nested/build'</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Tasks created by task generators are somehow private objects. They should not be manipulated directly in the <em>build</em> function, but rather by task generator methods.</td>
</tr></table>
</div>
<h3 id="_using_nodes">13.3. Using nodes</h3><div style="clear:left"></div>
<h4 id="_obtaining_nodes">13.3.1. Obtaining nodes</h4>
<div class="paragraph"><p>Three main Node methods are commonly used for accessing the file system:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
find_dir: return a directory node or None if the folder cannot be found on the system. By calling this method, the corresponding folders in the build directory will be created for each variant.
</p>
</li>
<li>
<p>
find_resource: return a source node, or a build node if a build node with the given name exist, or None if no such node exists. Compute and store the node signature (by hashing the file). This method may call <em>find_dir</em> internally.
</p>
</li>
<li>
<p>
find_or_declare: Return a build node. If no corresponding build node exist, it will be created first. This method may call <em>find_dir</em> internally.
</p>
</li>
</ol></div>
<div class="paragraph"><p>These methods interact with the filesystem, and may create other nodes such as intermediate folders. It is important to avoid their usage in a context of concurrency (threading). In general, this means avoiding node manipulations in the methods that execute the tasks.</p></div>
<div class="paragraph"><p>Although nodes have an attribute named <em>parent</em>, it is usually better to access the hierarchy by calling <em>find_dir</em> with a relative path. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'../src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Bad, do not use.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Recommended. Separators such as <em>/</em> are converted automatically and does not need to be the os separator.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Node instances must not be created manually.</td>
</tr></table>
</div>
<h4 id="_the_absolute_path">13.3.2. The absolute path</h4>
<div class="paragraph"><p>The method <em>abspath</em> is used to obtain the absolute path for a node. In the following example, three nodes are used:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        dir </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        src </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'out.out'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Directory node, source node and build node
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Computing the absolute path for source node or a build node takes a configuration set as parameter
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Computing the absolute path for a directory may use a configuration set or not
</td></tr>
</table></div>
<div class="paragraph"><p>Here is the execution trace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/nested/build'</span>
<span style="color: #000000">/tmp/nested/wscript <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">/tmp/nested/build/default/out.out <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">/tmp/nested/build/default/ <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">/tmp/nested <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/nested/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Absolute path for the source node
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The absolute path for the build node depends on the variant in use
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
When a configuration set is provided, the absolute path for a directory node is the build directory representation including the variant
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
When no configuration set is provided, the directory node absolute path is the one for the source directory
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Several other methods such as <em>relpath_gen</em> or <em>srcpath</em> are provided. See the <a href="http://freehackers.org/~tnagy/wafdoc/index.html">api documentation</a></td>
</tr></table>
</div>
<h3 id="_searching_for_nodes">13.4. Searching for nodes</h3><div style="clear:left"></div>
<h4 id="_ant_glob">13.4.1. ant_glob</h4>
<div class="paragraph"><p>The <a href="http://ant.apache.org/manual/dirtasks.html">Ant-like</a> Node method <em>ant_glob</em> is used for finding nodes or files.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*'</span><span style="color: #000000">,</span><span style="color: #000000"> src</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> dir</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> flat</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*'</span><span style="color: #000000">,</span><span style="color: #000000"> src</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> dir</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> flat</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The results will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">wscript .lock-wscript</span>
<span style="color: #000000">[src:///tmp/ant/wscript, src:///tmp/ant/.lock-wscript]</span></tt></pre></div></div>
<div class="paragraph"><p>The behaviour of <em>ant_glob</em> will be recursive if the expression contains <em>**</em>. It is therefore a good idea to limit the expression to what is strictly necessary.</p></div>
<h4 id="_update_build_dir">13.4.2. update_build_dir</h4>
<div class="paragraph"><p>By default, <em>ant_glob</em> will only find the files for folders that exist in the build directory. If new folders are created manually in the build directory, they must be declared somehow. Here is an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'mkdir -p default/a/b/c/ &amp;&amp; touch default/a/b/c/foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'blah'</span><span style="color: #000000">)</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">printi</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' before update %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">))</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">update_build_dir</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' after update  %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> bld</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">))</span>

<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">add_post_fun</span><span style="color: #000000">(</span><span style="color: #000000">printi</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The tree generated during the build will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- default.cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- default</span>
<span style="color: #000000">|       `-- a</span>
<span style="color: #000000">|           `-- b</span>
<span style="color: #000000">|               `-- c</span>
<span style="color: #000000">|                   `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The output from the execution will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">Checking for program touch               : ok /usr/bin/touch</span>
<span style="color: #000000">'configure' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/comp/waf/demos/simple_scenarios/magic_outputs/build'</span>
<span style="color: #000000">[1/1] blah:</span>
<span style="color: #000000">Waf: Leaving directory `/comp/waf/demos/simple_scenarios/magic_outputs/build'</span>
<span style="color: #000000"> before update '' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000"> after update  'a/b/c/foo.txt' <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'build' finished successfully (0.018s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Files created in the build directory by a foreign process are ignored
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Read the contents from the build directory
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">In <em>update_build_dir</em>, the parameter <em>env</em> is optional. When unset, all variants are considered.</td>
</tr></table>
</div>
</div>
<h2 id="_c_and_c_projects">14. C and C++ projects</h2>
<div class="sectionbody">
<div class="paragraph"><p>Although Waf is language neutral, it is commonly used for C and C++ projects. This chapter describes the waf tools used for this purpose.</p></div>
<h3 id="_common_script_for_c_c_applications">14.1. Common script for C/C++ applications</h3><div style="clear:left"></div>
<div class="paragraph"><p>The c/c++ builds consist in transforming source files into object files, and to assemble the object files at the end. In theory a single programming language should be sufficient for writing any application, but in practice this does not scale:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Applications may be divided in dynamic or static libraries
</p>
</li>
<li>
<p>
Additional files may enter in the link step (libraries, object files)
</p>
</li>
<li>
<p>
Source files may be generated by other compilers
</p>
</li>
<li>
<p>
Differnt platforms require different processing rules (manifest files on windows, etc)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The construction of c/c++ applications can be quite complicated, and several measures must be taken to ensure coherent interaction with new compilation rules. The canonical code for a task generator building a c/c++ application is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">set_options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">tool_options</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_cc'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_cc'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        t </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'cc'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'cprogram'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'appname'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                install_path </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${SOME_PATH}/bin'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                vnum         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'1.2.3'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                includes     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                defines      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'LINUX=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'BIDULE'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                ccflags      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-Wall'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>
<span style="color: #000000">                lib          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/10.png" alt="10" /></span>
<span style="color: #000000">                libpath      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">],</span>
<span style="color: #000000">                linkflags    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">],</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>
<span style="color: #000000">        t</span><span style="color: #000000">.</span><span style="color: #000000">rpath          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Load the c/c++ support routines (such as the features below) and try to find a suitable compiler for the build. The support for c++ is loaded by <em>compiler_cxx</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task generator declaration; each element in the list represent a feature; it is possible to add several languages at once (<em>ocaml and c++</em> for example), but the one of <em>cstaticlib, cshlib or cprogram</em> must be chosen.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
List of source, it may be either a python list, or a string containing the file names separated with spaces. This list may contain file names of different extensions to make hybrid applications.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Target name, it is concerted to the name of the binary <em>name.so</em> or <em>name.exe</em> depending on the platform and the features.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Installation directory, this is where to install the library or program produced. The <em>${}</em> expression is a reference to a variable to be extracted from <em>tgen.env</em>. By default it is set to <em>${PREFIX}/bin</em> for programs and <em>${PREFIX}/lib</em> for libraries. To disable the installation, set it to <em>None</em>.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Version number for shared libraries. It is not used for programs or static libraries.
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
List of include paths, it may be either a python list, or a string containing the paths separated by spaces. The paths are used for both the command-line and for finding the implicit dependencies (headers). In general, include paths must be relative to the wscript folder and given explicitly.
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Command-line defines: list of defines to add to the command-line with the <em>-D</em> prefix. To reduce the size of the command-line, it is possible to use a configuration header, see the following section for more details.
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Command-line compilation flags, for the c++ language the attribute is called <em>cxxflags</em>
</td></tr>
<tr><td><img src="./callouts/10.png" alt="10" /></td><td>
Shared libraries may be given directly (use <em>staticlib</em> and <em>staticlibpath</em> for static libraries)
</td></tr>
</table></div>
<div class="paragraph"><p>Additional pararameters may be added from a task generator reference. The next section describes a technique to gather the conditions into the configuration section.</p></div>
<h3 id="_include_processing">14.2. Include processing</h3><div style="clear:left"></div>
<h4 id="_execution_path_and_flags">14.2.1. Execution path and flags</h4>
<div class="paragraph"><p>Include paths are used by the c/c++ compilers for finding the headers. When one header changes, the files are recompiled automatically. For example on a project having the following structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- foo.h</span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   |-- main.c</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The file <em>src/wscript</em> will contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">        features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.. .'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The command-line (output by <tt>waf -v</tt>) will have the following form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cc -Idefault -I.. -Idefault/src -I../src ../src/main.c -c -o default/src/main_1.o</span></tt></pre></div></div>
<div class="paragraph"><p>Because commands are executed from the build directory, the folders have been converted to include flags in the following way:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">.. -&gt; -I..      -Idefault</span>
<span style="color: #000000">.  -&gt; -I../src  -Idefault/src</span></tt></pre></div></div>
<div class="paragraph"><p>There are the important points to remember:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The includes are always given relative to the directory containing the wscript file
</p>
</li>
<li>
<p>
The includes add both the source directory and the corresponding build directory for the task generator variant
</p>
</li>
<li>
<p>
Commands are executed from the build directory, so the include paths must be converted
</p>
</li>
<li>
<p>
System include paths should be defined during the configuration and added to CPPPATH variables (uselib)
</p>
</li>
</ol></div>
<h4 id="_the_waf_preprocessor">14.2.2. The Waf preprocessor</h4>
<div class="paragraph"><p>Waf uses a preprocessor written in Python for adding the dependencies on the headers. A simple parser looking at #include statements would miss constructs such as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> mymacro </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> mymacro</span></tt></pre></div></div>
<div class="paragraph"><p>Using the compiler for finding the dependencies would not work for applications requiring file preprocessing such as Qt. For Qt, special include files having the <em>.moc</em> extension must be detected by the build system and produced ahead of time. The c compiler could not parse such files.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.moc"</span></tt></pre></div></div>
<div class="paragraph"><p>Since system headers are not tracked by default, the waf preprocessor may miss dependencies written in the following form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#if</span></span><span style="color: #000000"> SOMEMACRO</span>
<span style="color: #000000">        </span><span style="color: #808080">/* an include in the project */</span>
<span style="font-weight: bold"><span style="color: #008080">        #include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#endif</span></span></tt></pre></div></div>
<div class="paragraph"><p>To write portable code and to ease debugging, it is strongly recommended to put all the conditions used within a project into a <em>config.h</em> file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span>
<span style="color: #000000">                fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main() { return 0; }\n'</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name</span><span style="color: #000000">=</span><span style="color: #009900">'FOO'</span><span style="color: #000000">,</span>
<span style="color: #000000">                mandatory</span><span style="color: #000000">=</span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>For performance reasons, the dependencies are not added onto system headers by default. The following code may be used to enable this behaviour:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> preproc</span>
<span style="color: #000000">preproc</span><span style="color: #000000">.</span><span style="color: #000000">go_absolute </span><span style="color: #000000">=</span><span style="color: #000000"> True</span></tt></pre></div></div>
<h4 id="_debugging_dependencies">14.2.3. Debugging dependencies</h4>
<div class="paragraph"><p>The Waf preprocessor contains a specific debugging zone:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=preproc</span></span></tt></pre></div></div>
<div class="paragraph"><p>To display the dependencies obtained or missed, use the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=deps</span></span>

<span style="color: #000000">23:53:21 deps deps for src:///comp/waf/demos/qt4/src/window.cpp: <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">  [src:///comp/waf/demos/qt4/src/window.h, bld:///comp/waf/demos/qt4/src/window.moc]; <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">  unresolved ['QtGui', 'QGLWidget', 'QWidget'] <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
File being preprocessed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Headers found
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
System headers discarded
</td></tr>
</table></div>
<div class="paragraph"><p>The dependency computation is performed only when the files are not up-to-date, so these commands will display something only when there is a file to compile.</p></div>
<h3 id="_library_interaction_uselib">14.3. Library interaction (uselib)</h3><div style="clear:left"></div>
<h4 id="_local_libraries">14.3.1. Local libraries</h4>
<div class="paragraph"><p>To link a library against another one created in the same Waf project, the attribute <em>uselib_local</em> may be used. The include paths, the link path and the library name are automatically exported, and the dependent binary is recompiled when the library changes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        staticlib </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cstaticlib'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'teststaticlib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                export_incdirs </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        main </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_c_program'</span><span style="color: #000000">,</span>
<span style="color: #000000">                includes       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                uselib_local   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'teststaticlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
A static library
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Include paths to export for use with uselib_local (include paths are not added automatically). These folders are taken relatively to the current target.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
A program using the static library declared previously
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A list of references to existing libraries declared in the project (either a python list or a string containing the names space-separated)
</td></tr>
</table></div>
<div class="paragraph"><p>The library does not need to actually declare a target. Header-only libraries may be created to add common include paths to several targets:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                uselib         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">''</span><span style="color: #000000">,</span>
<span style="color: #000000">                export_incdirs </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name           </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'common_includes'</span><span style="color: #000000">)</span>

<span style="color: #000000">        main </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'some_app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                uselib_local   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'common_includes'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Include paths are only propagated when <em>export_incdirs</em> is provided. The include paths are relative to the path of the task generator that declared them.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The local shared libraries and the uselib variables are propagated transitively, but the static libraries are not.</td>
</tr></table>
</div>
<h4 id="_system_libraries">14.3.2. System libraries</h4>
<div class="paragraph"><p>To link an application against various <em>system libraries</em>, several compilation flags and link flags must be given at once. To reduce the maintenance, a system called <em>uselib</em> can be used to give all the flags at the same time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CPPPATH_TEST </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> sys</span><span style="color: #000000">.</span><span style="color: #000000">platform </span><span style="color: #000000">!=</span><span style="color: #000000"> win32</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CCDEFINES_TEST </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'TEST'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CCFLAGS_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O0'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIB_TEST       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test'</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIBPATH_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LINKFLAGS_TEST </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CPPPATH_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt/gnome/include'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        mylib </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cstaticlib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'teststaticlib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                uselib   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'TEST'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> mylib</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CC_NAME </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'gcc'</span><span style="color: #000000">:</span>
<span style="color: #000000">                mylib</span><span style="color: #000000">.</span><span style="color: #000000">cxxflags </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
For portability reasons, it is recommended to use CPPPATH instead of giving flags of the form -I/include. Note that the CPPPATH use used by both c and c++
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Variables may be left undefined in platform-specific settings, yet the build scripts will remain identical.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a few variables during the configuration, the variables follow the convention VAR_NAME
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Values should be declared as lists excepts for LIB and STATICLIB
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Add all the VAR_NAME corresponding to the uselib NAME, which is <em>TEST</em> in this example
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
<em>Model to avoid</em>: setting the flags and checking for the configuration must be performed in the configuration section
</td></tr>
</table></div>
<div class="paragraph"><p>The variables used for c/c++ are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Uselib variables and task generator attributes for c/c++</caption>
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top">Uselib variable </th>
<th align="left" valign="top"> Attribute </th>
<th align="left" valign="top"> Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">LIB</p></td>
<td align="left" valign="top"><p class="table">lib</p></td>
<td align="left" valign="top"><p class="table">list of sharedlibrary names to use, without prefix or extension</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">STATICLIB</p></td>
<td align="left" valign="top"><p class="table">staticlib</p></td>
<td align="left" valign="top"><p class="table">list of static library names to use, without prefix or extension</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LIBPATH</p></td>
<td align="left" valign="top"><p class="table">libpath</p></td>
<td align="left" valign="top"><p class="table">list of search path for shared and static libraries</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RPATH</p></td>
<td align="left" valign="top"><p class="table">rpath</p></td>
<td align="left" valign="top"><p class="table">list of paths to hard-code into the binary during linking time</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXFLAGS</p></td>
<td align="left" valign="top"><p class="table">cxxflags</p></td>
<td align="left" valign="top"><p class="table">flags to use during the compilation of c++ files</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CCFLAGS</p></td>
<td align="left" valign="top"><p class="table">ccflags</p></td>
<td align="left" valign="top"><p class="table">flags to use during the compilation of c files</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CPPPATH</p></td>
<td align="left" valign="top"><p class="table">includes</p></td>
<td align="left" valign="top"><p class="table">include paths</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">a variable to trigger c++ file recompilations when it changes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CCDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">same as above, for c</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CCDEFINES,CXXDEFINES</p></td>
<td align="left" valign="top"><p class="table">defines</p></td>
<td align="left" valign="top"><p class="table">list of defines in the form [<em>key=value</em>, <em>key</em>, &#8230;]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORK</p></td>
<td align="left" valign="top"><p class="table">framework</p></td>
<td align="left" valign="top"><p class="table">list of frameworks to use, requires the waf tool <em>osx</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORKPATH</p></td>
<td align="left" valign="top"><p class="table">frameworkpath</p></td>
<td align="left" valign="top"><p class="table">list of framework paths to use, requires the waf tool <em>osx</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The variables may be left empty for later use, and will not cause errors. During the development, the configuration cache files (for example, default.cache.py) may be modified from a text editor to try different configurations without forcing a whole project reconfiguration. The files affected will be rebuilt however.</p></div>
<h4 id="_specific_settings_by_object_files">14.3.3. Specific settings by object files</h4>
<div class="paragraph"><p>In some cases, it is necessary to re-use object files generated by another task generator to avoid recompilations. This is similar to copy-pasting code, so it is discouraged in general. Another use for this is to enable some compilation flags for specific files. Although it is not exactly part of the library prossing, the attribute "add_objects" can be used for this purpose:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        some_objects </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                ccflags        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span>

<span style="color: #000000">        main </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                ccflags        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_c_program'</span><span style="color: #000000">,</span>
<span style="color: #000000">                add_objects    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Files will be compiled in c mode, but no program or library will be produced
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Different compilation flags may be used
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The objects will be added automatically in the link stage
</td></tr>
</table></div>
<h3 id="_configuration_helpers">14.4. Configuration helpers</h3><div style="clear:left"></div>
<h4 id="_configuration_tests">14.4.1. Configuration tests</h4>
<div class="paragraph"><p>The method <em>check</em> is used to detect parameters using a small build project. The main parameters are the following</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
msg: title of the test to execute
</p>
</li>
<li>
<p>
okmsg: message to display when the test succeeds
</p>
</li>
<li>
<p>
errmsg: message to display when the test fails
</p>
</li>
<li>
<p>
mandatory: when true, raise a configuration exception if the test fails
</p>
</li>
<li>
<p>
env: environment to use for the build (conf.env is used by default)
</p>
</li>
<li>
<p>
compile_mode: <em>cc</em> or <em>cxx</em>
</p>
</li>
<li>
<p>
define_name: add a define for the configuration header when the test succeeds (in most cases it is calculated automatically)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Besides the main parameters, the attributes from c/c++ task generators may be used. Here is a concrete example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">header_name</span><span style="color: #000000">=</span><span style="color: #009900">'time.h'</span><span style="color: #000000">,</span><span style="color: #000000"> compile_mode</span><span style="color: #000000">=</span><span style="color: #009900">'cc'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">function_name</span><span style="color: #000000">=</span><span style="color: #009900">'printf'</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">"stdio.h"</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main() {2+2==4;}\n'</span><span style="color: #000000">,</span><span style="color: #000000"> define_name</span><span style="color: #000000">=</span><span style="color: #009900">"boobah"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'m'</span><span style="color: #000000">,</span><span style="color: #000000"> ccflags</span><span style="color: #000000">=</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">,</span><span style="color: #000000"> defines</span><span style="color: #000000">=[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">],</span>
<span style="color: #000000">                uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cxx</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'linux'</span><span style="color: #000000">,</span><span style="color: #000000"> uselib</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">,</span><span style="color: #000000"> cxxflags</span><span style="color: #000000">=</span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'''</span>
<span style="color: #009900">                        #include &lt;stdio.h&gt;</span>
<span style="color: #009900">                        int main() { printf("4"); return 0; } '''</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"booeah"</span><span style="color: #000000">,</span>
<span style="color: #000000">                execute     </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_ret  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                msg         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"Checking for something"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Try to compile a program using the configuration header time.h, if present on the system, if the test is successful, the define HAVE_TIME_H will be added
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Try to compile a program with the function printf, adding the header stdio.h (the header_name may be a list of additional headers). The parameter mandatory will make the test raise an exception if it fails. Note that convenience methods <em>check_cc</em> and <em>check_cxx</em> only define the compilation mode <em>compile_mode</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Try to compile a piece of code, and if the test is successful, define the name boobah
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Modifications made to the task generator environment are not stored. When the test is successful and when the attribute uselib_store is provided, the names lib, cflags and defines will be converted into uselib variables LIB_M, CCFLAGS_M and DEFINE_M and the flag values are added to the configuration environment.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Try to compile a simple c program against a library called <em>linux</em>, and reuse the previous parameters for libm (uselib)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Execute a simple program, collect the output, and put it in a define when successful
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
After all the tests are executed, write a configuration header in the build directory (optional). The configuration header is used to limit the size of the command-line.
</td></tr>
</table></div>
<div class="paragraph"><p>Here is an example of a <em>config.h</em> produced with the previous test code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_PRINTF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_TIME_H </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> boobah </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> booeah </span><span style="color: #009900">"4"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<div class="paragraph"><p>The file <tt>default.cache.py</tt> will contain the following variables:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">CCDEFINES_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">]</span>
<span style="color: #000000">CXXDEFINES_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">]</span>
<span style="color: #000000">CXXFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">CCFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">LIB_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">]</span>
<span style="color: #000000">boobah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">booeah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'4'</span>
<span style="color: #000000">defines </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'booeah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'"4"'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'boobah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_TIME_H'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_PRINTF'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">}</span>
<span style="color: #000000">dep_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'config.h'</span><span style="color: #000000">]</span>
<span style="color: #000000">waf_config_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/compilation/waf/demos/adv/build/default/config.h'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The methods <em>conf.check</em> all use task generators internally. This means that the attributes <em>includes</em>, <em>defines</em>, <em>cxxflags</em> may be used (not all shown here).</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The attribute <em>compile_mode</em> may also contain user-defined task generator features.</td>
</tr></table>
</div>
<h4 id="_creating_configuration_headers">14.4.2. Creating configuration headers</h4>
<div class="paragraph"><p>Adding lots of command-line define values increases the size of the command-line and conceals the useful information (differences). Some projects use headers which are generated during the configuration, they are not modified during the build and they are not installed or redistributed. This system is useful for huge projects, and has been made popular by autoconf-based projects.</p></div>
<div class="paragraph"><p>Writing configuration headers can be performed using the following methods:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">undefine</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF_VERSION'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'1.0.2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The code snipped will produce the following <em>config.h</em> in the build directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">build/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- default.cache.py</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">`-- default</span>
<span style="color: #000000">    `-- config.h</span></tt></pre></div></div>
<div class="paragraph"><p>The contents of the config.h for this example are</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="color: #808080">/* #undef NOLIBF */</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF_VERSION </span><span style="color: #009900">"1.0.2"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<h4 id="_pkg_config">14.4.3. Pkg-config</h4>
<div class="paragraph"><p>Instead of duplicating the configuration detection in all dependent projects, configuration files may be written when libraries are installed. To ease the interaction with build systems based on Make (cannot query databases or apis), small applications have been created for reading the cache files and to interpret the parameters (with names traditionally ending in <em>-config</em>): <a href="http://pkg-config.freedesktop.org/wiki/">pkg-config</a>, wx-config, sdl-config, etc.</p></div>
<div class="paragraph"><p>The method <em>check_cfg</em> is provided to ease the interaction with these applications. Here are a few examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">atleast_pkgconfig_version</span><span style="color: #000000">=</span><span style="color: #009900">'0.0.0'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        pango_version </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">modversion</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'MYPANGO'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span>
<span style="color: #000000">                args</span><span style="color: #000000">=</span><span style="color: #009900">'"pango &gt;= 1.0.0" "pango &lt; 9.9.9" --cflags --libs'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                msg</span><span style="color: #000000">=</span><span style="color: #009900">"Checking for pango 1.0.0"</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'sdl-config'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--cflags --libs'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'SDL'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'mpicc'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--showme:compile --showme:link'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'OPEN_MPI'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Check for the pkg-config version
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Retrieve the module version for a package. The returned object is a string containing the version number or an empty string in case of any errors. If there were no errors, <em>PANGO_VERSION</em> is defined, can be overridden with the attribute "uselib_store=<em>MYPANGO</em>".
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Obtain the flags for a package and assign them to the uselib PANGO (calculated automatically from the package name)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Store the flags to the uselib variable <em>MYPANGO</em>, and raise a configuration error if the package cannot be found
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Use pkg-config clauses to ensure a particular version number. The arguments and the command are joined into a string and executed by the shell.
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Display a custom message on the output.
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Obtain the flags for a different configuration program (sdl-config). The example is applicable for other configuration programs such as wx-config, pcre-config, etc
</td></tr>
</table></div>
<div class="paragraph"><p>Due to the amount of flags, the lack of standards between config applications, and to the output changing for different operating systems (-I for gcc, /I for msvc), the output of pkg-config is parsed, and the variables for the corresponding uselib are set in a go. The function <em>parse_flags(line, uselib, env)</em> in the Waf module config_c.py performs the output analysis.</p></div>
<div class="paragraph"><p>The outputs are written in the build directory into the file <em>config.log</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399"># project cpp_test (0.0.1) configured on Fri Feb 26 20:51:39 2010 by</span></span>
<span style="font-weight: bold"><span style="color: #993399"># waf 1.5.19 (abi 7, python 20602f0 on linux2)</span></span>
<span style="font-weight: bold"><span style="color: #993399"># using /home/waf/bin/waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">#</span></span>
<span style="color: #000000">Checking for pkg-config version &gt;= 0.0.0</span>
<span style="color: #000000">pkg-config --errors-to-stdout --print-errors --atleast-pkgconfig-version=0.0.0</span>

<span style="color: #000000">pkg-config --errors-to-stdout --print-errors --modversion pango</span>

<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">pkg-config --errors-to-stdout --print-errors  pango</span>

<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">pkg-config --errors-to-stdout --print-errors  pango</span>

<span style="color: #000000">Checking for pango 1.0.0</span>
<span style="color: #000000">pkg-config --errors-to-stdout --print-errors "pango &gt;= 1.0.0" --cflags --libs pango</span>

<span style="color: #000000">Checking for sdl-config</span>
<span style="color: #000000">sdl-config --cflags --libs</span>

<span style="color: #000000">Checking for mpicc</span>
<span style="color: #000000">mpicc --showme:compile --showme:link</span></tt></pre></div></div>
<div class="paragraph"><p>After such a configuration, the configuration set contents will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">CCFLAGS_OPEN_MPI </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #000000">CPPPATH_OPEN_MPI </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib64/mpi/gcc/openmpi/include/openmpi'</span><span style="color: #000000">]</span>
<span style="color: #000000">CPPPATH_PANGO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include/pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/include/glib-2.0'</span><span style="color: #000000">]</span>
<span style="color: #000000">CXXFLAGS_OPEN_MPI </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #000000">HAVE_MYPANGO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">HAVE_OPEN_MPI </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">HAVE_PANGO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">LIB_PANGO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gobject-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gmodule-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'glib-2.0'</span><span style="color: #000000">]</span>
<span style="color: #000000">LINKFLAGS_OPEN_MPI </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #000000">PANGO_VERSION </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'1.25.3'</span>
<span style="color: #000000">PREFIX </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/local'</span>
<span style="color: #000000">defines </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'HAVE_OPEN_MPI'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_PANGO'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #009900">'PANGO_VERSION'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'"1.25.3"'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_MYPANGO'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">}</span></tt></pre></div></div>
</div>
<h2 id="_advanced_scenarios">15. Advanced scenarios</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter demonstrates a few examples of the waf library for more complicated and less common scenarios.</p></div>
<h3 id="_building_the_compiler_first">15.1. Building the compiler first</h3><div style="clear:left"></div>
<div class="paragraph"><p>The example below demonstrates how to build a compiler which is used for building the remaining targets. The requirements are the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create the compiler and all its intermediate tasks
</p>
</li>
<li>
<p>
Re-use the compiler in a second build step
</p>
</li>
<li>
<p>
The compiler will transform <em>.src</em> files into <em>.cpp</em> files, which will be processed too
</p>
</li>
</ol></div>
<div class="paragraph"><p>The first thing to do is to write the expected user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.cpp a.src'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Build the compiler first, it will result in a binary named <em>comp</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Give this task generator a name to access it by reference easily
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Add a new build group to make certain the compiler is complete before processing the next tasks
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Provide a file <em>a.src</em> to be transformed by <em>comp</em> into <em>a.cpp</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The code to support this scenario may be added in the wscript file or into a waf tool:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #009900">'${COMP} ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> before</span><span style="color: #000000">=</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>
<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.src'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_src</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        tg </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">name_to_obj</span><span style="color: #000000">(</span><span style="color: #009900">'comp'</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        tg</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">allnodes</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">])</span>

<span style="color: #000000">        name </span><span style="color: #000000">=</span><span style="color: #000000"> tg</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COMP </span><span style="color: #000000">=</span><span style="color: #000000"> name </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Declare a new task class for processing the source file by our compiler
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The tasks of this class must be executed before c++ tasks
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Files of extension <em>.src</em> are to be processed by this method
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Obtain a reference on the task generator producing the compiler
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Ensure that the compiler tasks are created, else calling <tt>waf --targets=foo</tt> would produce an error
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Create the task <em>a.src</em> &#8594; <em>a.cpp</em>
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Get the node corresponding to the program <em>comp</em> and obtain its absolute path
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Bind the path to <em>comp</em> for use in the rule
</td></tr>
</table></div>
<div class="paragraph"><p>The compilation results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">Checking for program g++,c++             : ok /usr/bin/g++</span>
<span style="color: #000000">Checking for program cpp                 : ok /usr/bin/cpp</span>
<span style="color: #000000">Checking for program ar                  : ok /usr/bin/ar</span>
<span style="color: #000000">Checking for program ranlib              : ok /usr/bin/ranlib</span>
<span style="color: #000000">'configure' finished successfully (0.034s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/comp/build'</span>
<span style="color: #000000">[1/5] cxx: comp.cpp -&gt; build/default/comp_1.o</span>
<span style="color: #000000">16:22:50 runner system command -&gt; ['/usr/bin/g++', '../comp.cpp', '-c', '-o', 'default/comp_1.o']</span>
<span style="color: #000000">[2/5] cxx_link: build/default/comp_1.o -&gt; build/default/comp <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">16:22:50 runner system command -&gt; ['/usr/bin/g++', 'default/comp_1.o', '-o', '/tmp/comp/build/default/comp']</span>
<span style="color: #000000">[3/5] src2cpp: a.src -&gt; build/default/a.cpp</span>
<span style="color: #000000">16:22:50 runner system command -&gt;  /tmp/comp/build/default/comp ../a.src default/a.cpp <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[4/5] cxx: main.cpp -&gt; build/default/main_2.o</span>
<span style="color: #000000">16:22:50 runner system command -&gt; ['/usr/bin/g++', '../main.cpp', '-c', '-o', 'default/main_2.o']</span>
<span style="color: #000000">[5/5] cxx_link: build/default/main_2.o -&gt; build/default/foo</span>
<span style="color: #000000">16:22:50 runner system command -&gt; ['/usr/bin/g++', 'default/main_2.o', '-o', '/tmp/comp/build/default/foo'] <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/comp/build'</span>
<span style="color: #000000">'build' finished successfully (0.194s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Creation of the <em>comp</em> program
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use the compiler to generate <em>a.cpp</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Compile and link <em>a.cpp</em> and <em>main.cpp</em> into the program <em>foo</em>
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">In the example above, the task generator <em>foo</em> depends on the tasks created by the task generator <em>tg</em> (get the path to the binary). Calling <em>tg.post()</em> used to force <em>tg</em> to create its tasks, and is only called during the processing of <em>foo</em>. Doing it from the top-level would break the behaviour of <tt>waf --targets=xyz</tt></td>
</tr></table>
</div>
<h3 id="_mixing_extensions_and_c_c_features">15.2. Mixing extensions and c/c++ features</h3><div style="clear:left"></div>
<h4 id="_files_processed_by_a_single_task_generator">15.2.1. Files processed by a single task generator</h4>
<div class="paragraph"><p>Now let&#8217;s illustrate the @extension decorator on idl file processing. Files with .idl extension are processed to produce .c and .h files (<tt>foo.idl</tt> → <tt>foo.c</tt> + <tt>foo.h</tt>). The .c files must be compiled after being generated.</p></div>
<div class="paragraph"><p>First, here is the declaration expected in user scripts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo.idl main.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span>
<span style="color: #000000">                </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The file <em>foo.idl</em> is listed as a source. It will be processed to <em>foo.cpp</em> and compiled and linked with <em>main.cpp</em></p></div>
<div class="paragraph"><p>Here is the code to support this scenario:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> before</span><span style="color: #000000">=</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        cc_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">node</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cc_node</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">allnodes</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">cc_node</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The ext_out symbol is to force the idl execution before any c++ file is processed. In practice the rule to use would be like <tt>omniidl -bcxx ${SRC} -C${TGT}</tt>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create the task from the <em>.idl</em> extension. If the task produces other files (headers, &#8230;), more nodes should be added along with <em>cc_node</em>.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Reinject the c++ node to the list of nodes to process
</td></tr>
</table></div>
<div class="paragraph"><p>The compilation results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">Checking for program g++,c++             : ok /usr/bin/g++</span>
<span style="color: #000000">Checking for program cpp                 : ok /usr/bin/cpp</span>
<span style="color: #000000">Checking for program ar                  : ok /usr/bin/ar</span>
<span style="color: #000000">Checking for program ranlib              : ok /usr/bin/ranlib</span>
<span style="color: #000000">'configure' finished successfully (0.033s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/idl/build'</span>
<span style="color: #000000">[1/4] idl: foo.idl -&gt; build/default/foo.cc</span>
<span style="color: #000000">[2/4] cxx: build/default/foo.cc -&gt; build/default/foo_1.o</span>
<span style="color: #000000">[3/4] cxx: main.cpp -&gt; build/default/main_1.o</span>
<span style="color: #000000">[4/4] cxx_link: build/default/main_1.o build/default/foo_1.o -&gt; build/default/myapp</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/idl/build'</span>
<span style="color: #000000">'build' finished successfully (0.119s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The drawback of this declaration is that the source files produced by the idl transformation are used by only one task generator.</td>
</tr></table>
</div>
<h4 id="_resources_shared_by_several_task_generators">15.2.2. Resources shared by several task generators</h4>
<div class="paragraph"><p>Now suppose that the idl processing outputs will be shared by several task generators. We will first start by writing the expected user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                source     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'notify.idl'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                features   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'testprog'</span><span style="color: #000000">,</span>
<span style="color: #000000">                add_source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Process an idl file in a first task generator. Name this task generator <em>idl_gen</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Somewhere else (maybe in another script), another task generator will use the source generated by the idl processing
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Reference the idl processing task generator by the name <em>idl_gen</em>. This declaration is is similar to <em>add_objects</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The code to support this scenario will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> before</span><span style="color: #000000">=</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">compile_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        c_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> c_node</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">more_source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">c_node</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'apply_core'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_add_source</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'add_source'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span>

<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">add_source</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">name_to_obj</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                y</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'more_source'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">allnodes</span><span style="color: #000000">.</span><span style="color: #000000">extend</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">.</span><span style="color: #000000">more_source</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The idl processing must be performed before any c++ task is executed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
This is the standard way to process a file by extension
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Bind the output nodes to a new task generator attribute <em>more_source</em>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A new task generator method is added to process the attribute <em>add_source</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Process each reference in <em>add_source</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Get the task generator from the reference, and for the current variant. In the example above this is the name <em>idl_gen</em>
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Force the task generator we depend on to create its tasks
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Add the sources from the other task generator to the current list of source
</td></tr>
</table></div>
<div class="paragraph"><p>The task execution output will be very similar to the output from the first example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">Checking for program g++,c++             : ok /usr/bin/g++</span>
<span style="color: #000000">Checking for program cpp                 : ok /usr/bin/cpp</span>
<span style="color: #000000">Checking for program ar                  : ok /usr/bin/ar</span>
<span style="color: #000000">Checking for program ranlib              : ok /usr/bin/ranlib</span>
<span style="color: #000000">'configure' finished successfully (0.041s)</span>
<span style="color: #000000">Waf: Entering directory `/home/waf/Descargas/blah/out'</span>
<span style="color: #000000">[1/4] idl: notify.idl -&gt; out/default/notify.cpp</span>
<span style="color: #000000">[2/4] cxx: out/default/notify.cpp -&gt; out/default/notify_2.o</span>
<span style="color: #000000">[3/4] cxx: main.cpp -&gt; out/default/main_2.o</span>
<span style="color: #000000">[4/4] cxx_link: out/default/notify_2.o out/default/main_2.o -&gt; out/default/testprog</span>
<span style="color: #000000">Waf: Leaving directory `/home/waf/Descargas/blah/out'</span>
<span style="color: #000000">'build' finished successfully (0.124s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">This technique is used by the waf library for processing the <em>add_objects</em> attribute.</td>
</tr></table>
</div>
<h3 id="_inserting_special_include_flags">15.3. Inserting special include flags</h3><div style="clear:left"></div>
<div class="paragraph"><p>A scenario that appears from times to times in C/C++ projects is the need to insert specific flags before others, regardless of how flags are usually processed. We will now consider the following case: execute all c++ compilations with the flag '-I.' in first position (before any other include).</p></div>
<div class="paragraph"><p>First, a look at the definition of the c++ compilation rule shows that the variable <em>_CXXINCFLAGS</em> contains the include flags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cxx_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${CXX} ${CXXFLAGS} ${CPPFLAGS} ${_CXXINCFLAGS} ${_CXXDEFFLAGS} ${CXX_SRC_F}${SRC} ${CXX_TGT_F}${TGT}'</span>
<span style="color: #000000">cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">,</span><span style="color: #000000"> cxx_str</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.o'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.cxx'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Those include flags are set by the method <em>apply_obj_vars_cxx</em>. The trick is then to modify <em>_CXXINCFLAGS</em> after that method has been executed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">new_task_gen</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> after</span><span style="color: #000000">,</span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'apply_obj_vars_cxx'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_myflags</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'_CXXINCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-I.'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>A related case is how to add the top-level directory containing a configuration header:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'apply_obj_vars_cxx'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_myflags</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        dir </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">relpath_gen</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'_CXXINCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-I'</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> dir</span><span style="color: #000000">)</span></tt></pre></div></div>
<h3 id="_simple_file_transformations">15.4. Simple file transformations</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Waf tool <em>misc</em> contains various routines to ease file manipulations such as substituting parameters or executing custom compilers. The objective of this section is to illustrate the principles of the current apis.</p></div>
<div class="paragraph"><p>The following example illustrates how to produce a pkg-config file from a template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'misc'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'subst'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.pc.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.pc'</span><span style="color: #000000">)</span>
<span style="color: #000000">        obj</span><span style="color: #000000">.</span><span style="color: #000000">dict     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'LIBS'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'-lm'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'-Wall'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'VERSION'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'1.0'</span><span style="color: #000000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Any kind of map will work for <em>obj.dict</em>, for example env.get_merged_dict(). The variables must be declared in the template file by enclosing the names between <em>@ characters</em> (m4 syntax):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Name: test</span>
<span style="color: #000000">Description: @CFLAGS@</span>
<span style="color: #000000">Version: @VERSION@</span>
<span style="color: #000000">Libs: -L${libdir} @LIBS@</span>
<span style="color: #000000">Cflags: -I${includedir} @CFLAGS@</span></tt></pre></div></div>
<div class="paragraph"><p>The default substitution function may be replaced by changing the attribute <em>func</em> of the task generator.</p></div>
<h3 id="_a_compiler_producing_source_files_with_names_unknown_in_advance">15.5. A compiler producing source files with names unknown in advance</h3><div style="clear:left"></div>
<div class="paragraph"><p>The example below demonstrates how to tackle the following requirements:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
A compiler <em>produces source files</em> (.c files) which are to be processed
</p>
</li>
<li>
<p>
The source file names are <strong>not known in advance</strong>
</p>
</li>
<li>
<p>
The task must be <strong>run only if necessary</strong>
</p>
</li>
<li>
<p>
Other tasks <strong>may depend on the tasks</strong> processing the source produced (compile and link the .c files)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The main difficulty in this scenario is to store the information on the source file produced and to create the corresponding tasks each time.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">VERSION</span><span style="color: #000000">=</span><span style="color: #009900">'0.0.1'</span>
<span style="color: #000000">APPNAME</span><span style="color: #000000">=</span><span style="color: #009900">'unknown_outputs'</span>
<span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #808080"># used only when configured from the same folder</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">SHPIP_COMPILER </span><span style="color: #000000">=</span><span style="color: #000000"> os</span><span style="color: #000000">.</span><span style="color: #000000">getcwd</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> os</span><span style="color: #000000">.</span><span style="color: #000000">sep </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">"bad_compiler.py"</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        staticlib </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">()</span>
<span style="color: #000000">        staticlib</span><span style="color: #000000">.</span><span style="color: #000000">features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc cstaticlib'</span>
<span style="color: #000000">        staticlib</span><span style="color: #000000">.</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'x.c foo.shpip'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        staticlib</span><span style="color: #000000">.</span><span style="color: #000000">target</span><span style="color: #000000">=</span><span style="color: #009900">'teststaticlib'</span>
<span style="color: #000000">        staticlib</span><span style="color: #000000">.</span><span style="color: #000000">includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>


<span style="color: #808080">## INTERNAL CODE BELOW ##</span>

<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span><span style="color: #000000">,</span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> Build</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> taskgen</span><span style="color: #000000">,</span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before</span><span style="color: #000000">,</span><span style="color: #000000"> after</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> logging </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> debug</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> Constants </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> </span><span style="color: #000000">*</span>

<span style="color: #000000">@taskgen</span>
<span style="color: #000000">@</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'apply_link'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.shpip'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_shpip</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">shpip_task</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">,</span><span style="color: #000000"> generator</span><span style="color: #000000">=</span><span style="color: #000000">self</span><span style="color: #000000">)</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">task_gen </span><span style="color: #000000">=</span><span style="color: #000000"> self</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">shpip_task</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #808080">        """</span>
<span style="color: #808080">        A special task, which finds its outputs once it has run</span>
<span style="color: #808080">        It outputs cpp files that must be compiled too</span>
<span style="color: #808080">        """</span>

<span style="color: #000000">        color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'PINK'</span>
<span style="color: #000000">        quiet </span><span style="color: #000000">=</span><span style="color: #000000"> True </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #808080"># important, no link before all shpip are done</span>
<span style="color: #000000">        before </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'cc_link'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'cxx_link'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'ar_link_static'</span><span style="color: #000000">]</span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">__init__</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">                Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">__init__</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #808080">                "runs a program that creates cpp files, capture the output to compile them"</span>
<span style="color: #000000">                node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>

<span style="color: #000000">                dir </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">bldpath</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">                cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cd %s &amp;&amp; %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">SHPIP_COMPILER</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #808080"># read the contents of the file and create cpp files from it</span>
<span style="color: #000000">                        files </span><span style="color: #000000">=</span><span style="color: #000000"> os</span><span style="color: #000000">.</span><span style="color: #000000">popen</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">).</span><span style="color: #000000">read</span><span style="color: #000000">().</span><span style="color: #000000">strip</span><span style="color: #000000">()</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #808080"># comment the following line to disable debugging</span>
<span style="color: #000000">                        </span><span style="color: #808080">#raise</span>
<span style="color: #000000">                        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000"> </span><span style="color: #808080"># error</span>

<span style="color: #000000">                </span><span style="color: #808080"># the variable lst should contain a list of paths to the files produced</span>
<span style="color: #000000">                lst </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">files</span><span style="color: #000000">)</span>

<span style="color: #000000">                </span><span style="color: #808080"># Waf does not know "magically" what files are produced</span>
<span style="color: #000000">                </span><span style="color: #808080"># In the most general case it may be necessary to run os.listdir() to see them</span>
<span style="color: #000000">                </span><span style="color: #808080"># In this demo the command outputs is giving us this list</span>

<span style="color: #000000">                </span><span style="color: #808080"># the files exist in the build dir only so we do not use find_or_declare</span>
<span style="color: #000000">                build_nodes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">exclusive_build_node</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">]</span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000">=</span><span style="color: #000000"> build_nodes</span>

<span style="color: #000000">                </span><span style="color: #808080"># create the cpp tasks, in the thread</span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">more_tasks </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">add_cpp_tasks</span><span style="color: #000000">(</span><span style="color: #000000">build_nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">                </span><span style="color: #808080"># cache the file names and the task signature</span>
<span style="color: #000000">                node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">                sig </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">()</span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">unique_id</span><span style="color: #000000">()]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">sig</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> lst</span>

<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #808080"># no error</span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #808080"># look at the cache, if the shpip task was already run</span>
<span style="color: #000000">                </span><span style="color: #808080"># and if the source has not changed, create the corresponding cpp tasks</span>

<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> t </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">run_after</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> t</span><span style="color: #000000">.</span><span style="color: #000000">hasrun</span><span style="color: #000000">:</span>
<span style="color: #000000">                                </span><span style="color: #000080">return</span><span style="color: #000000"> ASK_LATER</span>

<span style="color: #000000">                tree </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span>
<span style="color: #000000">                node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                        sig </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">()</span>
<span style="color: #000000">                        key </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">unique_id</span><span style="color: #000000">()</span>
<span style="color: #000000">                        deps </span><span style="color: #000000">=</span><span style="color: #000000"> tree</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">key</span><span style="color: #000000">]</span>
<span style="color: #000000">                        prev_sig </span><span style="color: #000000">=</span><span style="color: #000000"> tree</span><span style="color: #000000">.</span><span style="color: #000000">task_sigs</span><span style="color: #000000">[</span><span style="color: #000000">key</span><span style="color: #000000">][</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000"> KeyError</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">pass</span>
<span style="color: #000000">                </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #808080"># if the file has not changed, create the cpp tasks</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> prev_sig </span><span style="color: #000000">==</span><span style="color: #000000"> sig</span><span style="color: #000000">:</span>
<span style="color: #000000">                                lst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">task_gen</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">exclusive_build_node</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000080">for</span><span style="color: #000000"> y </span><span style="color: #000080">in</span><span style="color: #000000"> deps</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">:]]</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">)</span>
<span style="color: #000000">                                lst </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">add_cpp_tasks</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                                </span><span style="color: #000080">for</span><span style="color: #000000"> tsk </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">                                        generator </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">generator</span>
<span style="color: #000000">                                        generator</span><span style="color: #000000">.</span><span style="color: #000000">outstanding</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span>


<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">return</span><span style="color: #000000"> RUN_ME</span>

<span style="color: #000000">                </span><span style="color: #808080"># this is a part of Task.Task:runnable_status: first node does not exist -&gt; run</span>
<span style="color: #000000">                </span><span style="color: #808080"># this is necessary after a clean</span>
<span style="color: #000000">                env </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span>
<span style="color: #000000">                node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">                variant </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">variant</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">)</span>

<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        time </span><span style="color: #000000">=</span><span style="color: #000000"> tree</span><span style="color: #000000">.</span><span style="color: #000000">node_sigs</span><span style="color: #000000">[</span><span style="color: #000000">variant</span><span style="color: #000000">][</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">id</span><span style="color: #000000">]</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000"> KeyError</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #009900">"run task #%d - the first node does not exist"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">idx</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'task'</span><span style="color: #000000">)</span>
<span style="color: #000000">                        </span><span style="color: #000080">try</span><span style="color: #000000">:</span><span style="color: #000000"> new_sig </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">()</span>
<span style="color: #000000">                        </span><span style="color: #000080">except</span><span style="color: #000000"> KeyError</span><span style="color: #000000">:</span>
<span style="color: #000000">                                </span><span style="color: #000080">return</span><span style="color: #000000"> RUN_ME</span>

<span style="color: #000000">                        ret </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">can_retrieve_cache</span><span style="color: #000000">(</span><span style="color: #000000">new_sig</span><span style="color: #000000">)</span>
<span style="color: #000000">                        </span><span style="color: #000080">return</span><span style="color: #000000"> ret </span><span style="color: #000080">and</span><span style="color: #000000"> SKIP_ME </span><span style="color: #000080">or</span><span style="color: #000000"> RUN_ME</span>

<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> SKIP_ME</span>

<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">add_cpp_tasks</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> lst</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>
<span style="color: #808080">                "creates cpp tasks after the build has started"</span>
<span style="color: #000000">                tgen </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">task_gen</span>
<span style="color: #000000">                tsklst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span>

<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> node </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">                        TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">task_gen</span><span style="color: #000000">.</span><span style="color: #000000">mapped</span><span style="color: #000000">[</span><span style="color: #009900">'c_hook'</span><span style="color: #000000">](</span><span style="color: #000000">tgen</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">                        task </span><span style="color: #000000">=</span><span style="color: #000000"> tgen</span><span style="color: #000000">.</span><span style="color: #000000">compiled_tasks</span><span style="color: #000000">[-</span><span style="color: #000000">1</span><span style="color: #000000">]</span>
<span style="color: #000000">                        task</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span>

<span style="color: #000000">                        </span><span style="color: #808080"># important, no link before compilations are all over</span>
<span style="color: #000000">                        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">)</span>
<span style="color: #000000">                        </span><span style="color: #000080">except</span><span style="color: #000000"> AttributeError</span><span style="color: #000000">:</span>
<span style="color: #000000">                                </span><span style="color: #000080">pass</span>

<span style="color: #000000">                        tgen</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">])</span>
<span style="color: #000000">                        tsklst</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">)</span>

<span style="color: #000000">                        </span><span style="color: #808080"># if headers are produced something like this can be done</span>
<span style="color: #000000">                        </span><span style="color: #808080"># to add the include paths</span>
<span style="color: #000000">                        dir </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span>
<span style="color: #000000">                        </span><span style="color: #808080"># include paths for c++ and c</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_unique</span><span style="color: #000000">(</span><span style="color: #009900">'_CXXINCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-I%s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_unique</span><span style="color: #000000">(</span><span style="color: #009900">'_CCINCFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-I%s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'INC_PATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> dir</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #808080"># for the waf preprocessor</span>

<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> tsklst</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
An example. The source line contains a directive <em>foo.shpip</em> which triggers the creation of a shpip task (it does not represent a real file)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
This method is used to create the shpip task when a file ending in <em>.shpip</em> is found
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Create the new task type
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Disable the warnings raised because the task has no input and outputs
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Execute the task
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Retrieve the information on the source files created
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Create the c++ tasks used for processing the source files found
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
f the tasks are created during a task execution (in an execution thread), the tasks must be re-injected by adding them to the attribute <em>more_tasks</em>
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
If the tasks are created during the task examination (runnable_status), the tasks can be injected directly in the build by using the attribute <em>outstanding</em> of the scheduler
</td></tr>
</table></div>
</div>
<h2 id="_using_the_development_version">16. Using the development version</h2>
<div class="sectionbody">
<div class="paragraph"><p>A few notes on the waf development follow.</p></div>
<h3 id="_tracing_the_execution">16.1. Tracing the execution</h3><div style="clear:left"></div>
<div class="paragraph"><p>The generic flags to add more information to the stack traces or to the messages is <em>-v</em> (verbosity), it is used to display the command-lines executed during a build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span></tt></pre></div></div>
<div class="paragraph"><p>To display all the traces (useful for bug reports), use the following flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -vvv</span></span></tt></pre></div></div>
<div class="paragraph"><p>Debugging information can be filtered easily with the flag <em>zones</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action</span></span></tt></pre></div></div>
<div class="paragraph"><p>Tracing zones must be comma-separated, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action,envhash,task_gen</span></span></tt></pre></div></div>
<div class="paragraph"><p>The Waf module <em>Logs</em> replaces the Python module logging. In the source code, traces are provided by using the <em>debug</em> function, they must obey the format "zone: message" like in the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Logs</span><span style="color: #000000">.</span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #009900">"task: task %r must run as it was never run before or the task code changed"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The following zones are used in Waf:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. Debugging zones</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Zone    </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">runner</p></td>
<td align="left" valign="top"><p class="table">command-lines executed (enabled when -v is provided without debugging zones)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">deps</p></td>
<td align="left" valign="top"><p class="table">implicit dependencies found (task scanners)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_gen</p></td>
<td align="left" valign="top"><p class="table">task creation (from task generators) and task generator method execution</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">action</p></td>
<td align="left" valign="top"><p class="table">functions to execute for building the targets</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">env</p></td>
<td align="left" valign="top"><p class="table">environment contents</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">envhash</p></td>
<td align="left" valign="top"><p class="table">hashes of the environment objects - helps seeing what changes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">build</p></td>
<td align="left" valign="top"><p class="table">build context operations such as filesystem access</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">preproc</p></td>
<td align="left" valign="top"><p class="table">preprocessor execution</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">group</p></td>
<td align="left" valign="top"><p class="table">groups and task generators</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Debugging information can be displayed only after the command-line has been parsed. For example, no debugging information will be displayed when a waf tool is being by <em>tool_options</em></td>
</tr></table>
</div>
<h3 id="_benchmarking">16.2. Benchmarking</h3><div style="clear:left"></div>
<div class="paragraph"><p>The script <tt>utils/genbench.py</tt> generates a simple benchmark for Waf. The habitual use is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ utils/genbench.py /tmp/build 50 100 15 5</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/build</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf -p -j2</span></span></tt></pre></div></div>
<div class="paragraph"><p>The project created contains 50 libraries with 100 classes for each, each source file having 15 include headers pointing to the same library and 5 headers pointing to the headers of other libraries in the project.</p></div>
<div class="paragraph"><p>The time taken to create the tasks and to resolve the dependencies can be obtained by injecting code to disable the actual compilation, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">touch_func</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000000">open</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">),</span><span style="color: #000000"> </span><span style="color: #009900">'w'</span><span style="color: #000000">).</span><span style="color: #000000">close</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">.</span><span style="color: #000000">keys</span><span style="color: #000000">():</span>
<span style="color: #000000">                cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #000000">x</span><span style="color: #000000">]</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">func </span><span style="color: #000000">=</span><span style="color: #000000"> touch_func</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'CYAN'</span></tt></pre></div></div>
<h3 id="_profiling">16.3. Profiling</h3><div style="clear:left"></div>
<div class="paragraph"><p>Profiling information is obtained by calling the module cProfile and by injecting specific code. The two most interesting methods to profile are <em>flush</em> and <em>compile</em>. The most important number from the profiling information is the amount of function calls, and reducing it results in noticeable speedups. Here is an example on the method compile:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Build</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ncomp</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> cProfile</span><span style="color: #000000">,</span><span style="color: #000000"> pstats</span>
<span style="color: #000000">        cProfile</span><span style="color: #000000">.</span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #009900">'import Build; Build.bld.rep_compile()'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p </span><span style="color: #000000">=</span><span style="color: #000000"> pstats</span><span style="color: #000000">.</span><span style="color: #000000">Stats</span><span style="color: #000000">(</span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p</span><span style="color: #000000">.</span><span style="color: #000000">sort_stats</span><span style="color: #000000">(</span><span style="color: #009900">'time'</span><span style="color: #000000">).</span><span style="color: #000000">print_stats</span><span style="color: #000000">(</span><span style="color: #000000">150</span><span style="color: #000000">)</span>

<span style="color: #000000">Build</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">rep_compile </span><span style="color: #000000">=</span><span style="color: #000000"> Build</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">compile</span>
<span style="color: #000000">Build</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">compile </span><span style="color: #000000">=</span><span style="color: #000000"> ncomp</span></tt></pre></div></div>
<div class="paragraph"><p>Here the output obtained on a benchmark build created as explained in the previous section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Sun Nov  9 19:22:59 2008    prof.txt</span>

<span style="color: #000000">         959695 function calls (917845 primitive calls) in 3.195 CPU seconds</span>

<span style="color: #000000">   Ordered by: internal time</span>
<span style="color: #000000">   List reduced from 187 to 10 due to restriction 10</span>

<span style="color: #000000">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
<span style="color: #000000">        1    0.531    0.531    0.531    0.531 {cPickle.dump}</span>
<span style="color: #000000">73950/42150    0.223    0.000    0.276    0.000 Environment.py:66(__getitem__)</span>
<span style="color: #000000">     5000    0.215    0.000    0.321    0.000 Task.py:770(compute_sig_implicit_deps)</span>
<span style="color: #000000">   204434    0.180    0.000    0.180    0.000 {method 'update' of '_hashlib.HASH' objects}</span>
<span style="color: #000000">     5050    0.170    0.000    0.551    0.000 Task.py:706(sig_vars)</span>
<span style="color: #000000">    10000    0.144    0.000    0.301    0.000 Utils.py:98(h_file)</span>
<span style="color: #000000">25255/15205    0.113    0.000    0.152    0.000 Node.py:329(abspath)</span>
<span style="color: #000000">    15050    0.107    0.000    0.342    0.000 Task.py:481(unique_id)</span>
<span style="color: #000000">    15301    0.102    0.000    0.102    0.000 Environment.py:50(variant)</span>
<span style="color: #000000">   132062    0.097    0.000    0.097    0.000 {method 'get' of 'dict' objects}</span></tt></pre></div></div>
<div class="paragraph"><p>From the profile information, it appears that the hot spots are, in order:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The persistence implemented by the cPickle module (the cache file to serialize takes about 3Mb)
</p>
</li>
<li>
<p>
Accessing configuration data from the Environment instances
</p>
</li>
<li>
<p>
Computing implicit dependencies (the test project contains lots of interleaved dependencies)
</p>
</li>
</ol></div>
<div class="paragraph"><p>In practice, the time taken by these methods is not significant enough to justify code changes. Also, profiling must be carried out on builds which last at least several seconds.</p></div>
<h3 id="_tracing_parallel_task_execution">16.4. Tracing parallel task execution</h3><div style="clear:left"></div>
<div class="paragraph"><p>A special Waf tool named <em>ParallelDebug</em> is used to inject code in Waf modules and obtain information on the execution. This module is provided in the folder <tt>playground</tt> and must be imported in one&#8217;s project before use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_tool</span><span style="color: #000000">(</span><span style="color: #009900">'ParallelDebug'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>After executing a full build, a trace of the execution is output in <tt>/tmp/test.dat</tt>; it may be processed by other applications such as Gnuplot:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">set terminal png</span>
<span style="color: #000000">set output "output.png"</span>
<span style="color: #000000">set ylabel "Amount of jobs running in parallel"</span>
<span style="color: #000000">set xlabel "Time in seconds"</span>
<span style="color: #000000">set title "Amount of jobs running in parallel (waf -j5)"</span>
<span style="color: #000000">unset label</span>
<span style="color: #000000">set yrange [-0.1:5.2]</span>
<span style="color: #000000">set ytic 1</span>
<span style="color: #000000">plot 'test.dat' using 1:3 with lines title "" lt 2</span></tt></pre></div></div>
<div class="imageblock">
<div class="content">
<img src="dev.png" alt="Tracing the threads being executed" width="680" />
</div>
</div>
<h3 id="_obtaining_the_latest_source_code">16.5. Obtaining the latest source code</h3><div style="clear:left"></div>
<div class="paragraph"><p>Waf is hosted on <a href="http://code.google.com/p/waf/source">Google code</a>, and uses Subversion for source control. To obtain the development copy, use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ svn checkout http://waf.googlecode.com/svn/trunk/ waf-read-only</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd waf-read-only</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf-light --make-waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>To avoid regenerating Waf each time, the environment variable WAFDIR can be used to point to the directory containing wafadmin:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFDIR=/path/to/directory/</span></span></tt></pre></div></div>
<div class="paragraph"><p>Although the Waf binary depends on Python 2.3, the Waf source code depends on Python 2.4. When generating Waf, a parser modifies the source code and performs the following operations:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Move the decorators into simple function calls
</p>
</li>
<li>
<p>
Add the imports for the module sets
</p>
</li>
<li>
<p>
Eliminate redundant spaces
</p>
</li>
<li>
<p>
Strip comments to reduce the size
</p>
</li>
</ol></div>
<h3 id="_programming_constraints">16.6. Programming constraints</h3><div style="clear:left"></div>
<div class="paragraph"><p>Though Waf is written in Python, additional restrictions apply to the source code:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Identation is tab-only, and the maximum line length should be about 200 characters
</p>
</li>
<li>
<p>
The development code is kept compatible with Python 2.3, to the exception of decorators in the Tools directory. In particular, the Waf binary can be generated using Python 2.3
</p>
</li>
<li>
<p>
The <tt>wafadmin</tt> modules must be insulated from the <tt>Tools</tt> modules to keep the Waf core small and language independent
</p>
</li>
<li>
<p>
Api compatibility is maintained in the cycle of a minor version (from 1.5.0 to 1.5.n)
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">More code always means more bugs. Whenever possible, unnecessary code must be removed, and the existing code base should be simplified.</td>
</tr></table>
</div>
</div>
<h2 id="_overview_of_the_waf_architecture">17. Overview of the Waf architecture</h2>
<div class="sectionbody">
<div class="paragraph"><p>A very open architecture is provided, in which all classes are open for extensions.</p></div>
<h3 id="_the_core_library">17.1. The core library</h3><div style="clear:left"></div>
<div class="paragraph"><p>Waf is based on only 12 modules which constitute the core library. They are located in the directory <tt>wafadmin/</tt>. The modules located under <tt>wafadmin/Tools</tt> add support for programming languages and more tools, but are not essential for the Waf core.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 3. The core library</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Module    </th>
<th align="left" valign="top"> Role</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Build</p></td>
<td align="left" valign="top"><p class="table">Defines the build context class, which holds the data for one build (paths, configuration data)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Configure</p></td>
<td align="left" valign="top"><p class="table">Contains the configuration context class, which is used for launching configuration tests, and the extension system</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Constants</p></td>
<td align="left" valign="top"><p class="table">Provides the constants used in the project</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Environment</p></td>
<td align="left" valign="top"><p class="table">Contains a dictionary class which supports a lightweight copy scheme and provides persistence services</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Logs</p></td>
<td align="left" valign="top"><p class="table">Loggging system</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Node</p></td>
<td align="left" valign="top"><p class="table">Contains the file system representation class</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Options</p></td>
<td align="left" valign="top"><p class="table">Provides a custom command-line option processing system based on optparse</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Runner</p></td>
<td align="left" valign="top"><p class="table">Contains the task execution system (thread-based producer-consumer)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Scripting</p></td>
<td align="left" valign="top"><p class="table">Constitutes the entry point of the Waf application, executes the user commands such as build, configuration and installation</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TaskGen</p></td>
<td align="left" valign="top"><p class="table">Provides the task generator system, and its extension system based on method addition</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Task</p></td>
<td align="left" valign="top"><p class="table">Contains the task classes, and the task containers</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Utils</p></td>
<td align="left" valign="top"><p class="table">Contains the support functions and classes re-used in other Waf modules</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The essential classes and methods from the core library are represented on the following diagram:</p></div>
<div class="imageblock">
<div class="content">
<img src="classes.png" alt="Main classes" width="850" />
</div>
</div>
<h3 id="_build_context_instances">17.2. Build context instances</h3><div style="clear:left"></div>
<div class="paragraph"><p>Executing tasks, accessing the file system and consulting the results of a previous build are very different concerns which have to be encapsulated properly. The core class representing a build is a build context.</p></div>
<h4 id="_build_context_and_persistence">17.2.1. Build context and persistence</h4>
<div class="paragraph"><p>The build context holds all the information necessary for a build. To accelerate the start-up, a part of the information is stored and loaded between the runs. The persistent attributes are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 4. Build context persistence</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Attribute    </th>
<th align="left" valign="top"> Information</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">root</p></td>
<td align="left" valign="top"><p class="table">Node representing the root of the file system</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">srcnode</p></td>
<td align="left" valign="top"><p class="table">Node representing the source directory</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">bldnode</p></td>
<td align="left" valign="top"><p class="table">Node representing the build directory (rarely used)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">node_sigs</p></td>
<td align="left" valign="top"><p class="table">File hashes (dict mapping Node ids to hashes)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">node_deps</p></td>
<td align="left" valign="top"><p class="table">Implicit dependencies (dict mapping Node ids)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">raw_deps</p></td>
<td align="left" valign="top"><p class="table">Implicit file dependencies which could not be resolved (dict mapping Node ids to lists of strings)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_sigs</p></td>
<td align="left" valign="top"><p class="table">Signature of the tasks previously run (dict mapping a Task id to a hash)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">id_nodes</p></td>
<td align="left" valign="top"><p class="table">Sequence for generating unique node instance ids (id of the last Node created)</p></td>
</tr>
</tbody>
</table>
</div>
<h4 id="_parallelization_concerns">17.2.2. Parallelization concerns</h4>
<div class="paragraph"><p>Build contexts perform an <em>os.chdir</em> call before starting to execute the tasks. When running build contexts within build contexts (tasks), the current working directory may cause various problems. To work around them, it may be necessary to change the compilation rules (compile from the file system root) and to inject code (replace bld.compile).</p></div>
<div class="paragraph"><p>Direct <em>Node</em> instances are not used anywhere in the Waf code. Instead, each build context creates a new Node subclass (bld.node_class), on which the build context instance is attached as a class attribute.</p></div>
<h4 id="_threading_concerns">17.2.3. Threading concerns</h4>
<div class="paragraph"><p>Nearly all the code is executed in the main thread. The other threads are merely waiting for new tasks, and executing the methods <em>run</em> and <em>install</em> from the task instances. As a consequence, such methods should contain as little code as possible, and access the BuildContext in a read-only manner. If such tasks must declare new nodes while executing the build (find_dir, find_resource, ..), then locks must be used to prevent concurrent access (concurrent directory and node creation).</p></div>
<div class="paragraph"><p>If the run methods have to modify the build context, it is recommended to overload the method <em>get_out</em> of the scheduler and to execute methods in an event-like manner (data is attached to the task, and the method get_out executes the code). Adding more tasks from a running task is demonstrated &lt;xref linkend="runtime_discovered_outputs"/&gt;.</p></div>
<h3 id="_execution_overview">17.3. Execution overview</h3><div style="clear:left"></div>
<h4 id="_file_system_access">17.3.1. File system access</h4>
<div class="paragraph"><p>File system access is performed through an abstraction layer formed by the build context and <em>Node</em> instances. The data structure was carefully designed to maximize performance, so it is unlikely that it will change again in the future. The idea is to represent one file or one directory by a single Node instance. Dependent data such as file hashes are stored on the build context object and allowed to be persisted. Three kinds of nodes are declared: files, build files and folders. The nodes in a particular directory are unique, but build files used in several variant add duplicate entry on the build context cache.</p></div>
<div class="paragraph"><p>To access a file, the methods <em>Node::find_resource</em>, <em>Node::find_build</em> (find an existing resource or declare a build node) and <em>Node::find_dir</em> must be used. While searching for a particular node, the folders are automatically searched once for the files. Old nodes (which do not have a corresponding file) are automatically removed, except for the build nodes. In some cases (lots of files added and removed), it may be necessary to perform a <em>Waf clean</em> to eliminate the information on build files which do not exist anymore.</p></div>
<h4 id="_task_classes">17.3.2. Task classes</h4>
<div class="paragraph"><p>The whole process of generating tasks through Waf is performed by methods added on the class task_gen by code injection. This often puzzles the programmers used to static languages where new functions or classes cannot be defined at runtime.</p></div>
<div class="paragraph"><p>The task generators automatically inherit the build context attribute <em>bld</em> when created from bld(&#8230;). Likewise, tasks created from a task generator (create_task) automatically inherit their generator, and their build context. Direct instantiation may result in problems when running Waf as a library.</p></div>
<div class="paragraph"><p>The tasks created by task generator methods are automatically stored on the build context task manager, which stores the task into a task group. The task groups are later used by the scheduler to obtain the task which may run (state machine). Target (un)installation is performed right after a task has run, using the method <em>install</em>.</p></div>
<h3 id="_performance_and_build_accuracy">17.4. Performance and build accuracy</h3><div style="clear:left"></div>
<div class="paragraph"><p>From the experience with tools such as SCons, users may be concerned about performance and think that all build systems based on interpreted languages such as Python would not scale. We will now describe why this is not the case for Waf and why Waf should be chosen for building very large projects.</p></div>
<h4 id="_comparing_waf_against_other_build_systems">17.4.1. Comparing Waf against other build systems</h4>
<div class="paragraph"><p>Since Waf considers the file contents in the build process, it is often thought that Waf would be much slower than make. For a test project having 5000 files (generated from the script located in <tt>tools/genbench.py</tt>), on a 1.5Ghz computer, the Waf runtime is actually slightly faster than the Gnu/Make one (less than one second). The reason is the time to launch a new process - make is usually called recursively, once by directory.</p></div>
<div class="paragraph"><p>For huge projects, calling make recursively is necessary for flexibility, but it hurts performance (launch many processes), and CPU utilization (running tasks in parallel). Make-based build systems such as CMake or Autotools inherit the limitations of Make.</p></div>
<div class="paragraph"><p>Though Waf uses a similar design as SCons, Waf is about 15 times faster for similar features and without sacrificing build accuracy. The main reasons for this are the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The Waf data structures (file system representation, tasks) have been carefully chosen to minimize memory usage and data duplication
</p>
</li>
<li>
<p>
For a project of the same size, SCons requires at least 10 times as many function calls
</p>
</li>
</ol></div>
<div class="paragraph"><p>A few benchmarks are maintained at <a href="http://freehackers.org/~tnagy/bench_ug.txt">this location</a></p></div>
<h4 id="_waf_hashing_schemes_and_build_accuracy">17.4.2. Waf hashing schemes and build accuracy</h4>
<div class="paragraph"><p>To rebuild targets when source file change, the file contents are hashed and compared. The hashes are used to identify the tasks, and to retrieve the files from a cache (folder defined by the environment variable <em>WAFCACHE</em>). Besides command-lines, this scheme also takes file dependencies into account: it is more accurate than caching systems such as <em>ccache</em>.</p></div>
<div class="paragraph"><p>The Waf hashing scheme uses the md5 algorithm provided by the Python distribution. It is fast enough for up to about 100Mb of data and about 10000 files and very safe (virtually no risk of collision).</p></div>
<div class="paragraph"><p>If more than 100Mb of data is present in the project, it may be necessary to use a faster hashing algorithm. An implementation of the fnv algorithm is present in the Waf distribution, and can replace md5 without really degrading accuracy.</p></div>
<div class="paragraph"><p>If more than 10000 files are present, it may be necessary to replace the hashing system by a <em>file name+size+timestamp hash scheme</em>. An example is provided in the comment section of the module <tt>Utils.py</tt>. That scheme is more efficient but less accurate: the Waf cache should not be used with this scheme.</p></div>
</div>
<h2 id="_further_reading">18. Further reading</h2>
<div class="sectionbody">
<div class="paragraph"><p>Due to the amount of features provided by Waf, this book is forcibly incomplete. For greater understanding and practice the following links are recommended to the reader:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 5. Recommended links</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Link</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://freehackers.org/~tnagy/wafdoc/index.html">http://freehackers.org/~tnagy/wafdoc/index.html</a></p></td>
<td align="left" valign="top"><p class="table">The apidocs</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf">http://code.google.com/p/waf</a></p></td>
<td align="left" valign="top"><p class="table">The Waf project page</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf/w/list">http://code.google.com/p/waf/w/list</a></p></td>
<td align="left" valign="top"><p class="table">The Waf wiki, including the frequently asked questions (FAQ)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://groups.google.com/group/waf-users">http://groups.google.com/group/waf-users</a></p></td>
<td align="left" valign="top"><p class="table">The Waf mailing-list</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h2 id="_glossary">19. Glossary</h2>
<div class="sectionbody">
<div class="dlist glossary"><dl>
<dt>
Task generator
</dt>
<dd>
<p>
        A task generator is an object instance of the class Task.task_gen. The task generators encapsulate the creation of various task instances at a time, and simplify the creation of ordering constraints between them (for example, compilation tasks are executed before link tasks).
</p>
</dd>
<dt>
Task
</dt>
<dd>
<p>
        A Waf task is an object instance of the class Task.TaskBase. Waf tasks may be simple (Task.TaskBase) or related to the filesystem (Task.Task). Tasks represent the production of something during the build (files in general), and may be executed in sequence (with ordering constraints) or in parallel.
</p>
</dd>
<dt>
Tool
</dt>
<dd>
<p>
        A Waf tool is a python module containing Waf-specific extensions. The Waf tools are located in the folder <tt>wafadmin/Tools/</tt> and usually contain a global variable <em>detect</em> which may reference functions to execute in the configuration.
</p>
</dd>
<dt>
Node
</dt>
<dd>
<p>
        The Node class is a data structure used to represent the filesystem in an efficient manner. The node objects may represent source files, folders, or build files. Non-directory nodes may associated to signatures containing the source file hash for source nodes or the task signature that produced the node.
</p>
</dd>
</dl></div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2010-11-13 12:17:28 CET
</div>
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19942299-1']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
