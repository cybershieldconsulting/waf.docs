<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<title>The Waf Book</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #dddddd;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }
div.imageblock.latex div.image-title { margin-top: 0.5em; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  div#footer-badges { display: none; }
}

div#toc {
  margin-bottom: 2.5em;
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

pre.verseblock-content {
  font-family: inherit;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
div.tableblock > table {
  border: 1px solid gray;
}

div#header h1 {
       background: url('waf-64x64.png') no-repeat left center;
       padding-left: 80px;
       line-height: 80px;
       height: 80px;
}

div.title, caption.title {
	text-align: center;
	margin-bottom: 0.2em;
}

div.tableblock > table th {
	background-color: #F4F4F4;
}

h1, h2, h3, h4, h5, h6, span#author, div.title, caption.title, div.admonitionblock .icon, div#toctitle, div.sidebar-title, div.image-title {
	color: #333;
}

body, div.sectionbody, div#toctitle {
	font-family: 'Lucida Grande', Verdana, Arial, sans-serif;
}

</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){asciidoc.footnotes(); asciidoc.toc(2);}
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  var cont = document.getElementById("content");
  var noteholder = document.getElementById("footnotes");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      // Use [\s\S] in place of . so multi-line matches work.
      // Because JavaScript has no s (dotall) regex flag.
      note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      spans[i].innerHTML =
        "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
        "' title='View footnote' class='footnote'>" + n + "</a>]";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
}

}
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>The Waf Book</h1>
<span id="author">Thomas Nagy</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p></p></div>
</div>
</div>
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Copyright &#169; 2010-2011 Thomas Nagy</p></div>
<div class="paragraph"><p>Copies of this book may be redistributed, verbatim, and for non-commercial
purposes. The license for this book is
 <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">by-nc-nd license</a>.</p></div>
<h3 id="_a_word_on_build_systems">A word on build systems</h3><div style="clear:left"></div>
<div class="paragraph"><p>As software is becoming increasingly complex, the process of creating software is becoming more complex too. Today&#8217;s software uses various languages, requires various compilers, and the input data is spread into many files.</p></div>
<div class="paragraph"><p>Software is now used to express the process of building software, it can take the form of simple scripts (shell scripts, makefiles), or compilers (CMake, Qmake), or complete applications (SCons, Maven, Waf). The term &#8216;build system&#8217; is used to design the tools used to build applications.</p></div>
<h3 id="_the_waf_framework">The Waf framework</h3><div style="clear:left"></div>
<div class="paragraph"><p>Build systems make assumptions on software it is trying to build, and are typically limited where it comes to processing other languages or different projects. For example, Ant is better suited than Make for managing Java projects, but is more limited than Make for managing simple c projects. The programming tools are evolving constantly, making the creation of a complete build system for end-users impossible.</p></div>
<div class="paragraph"><p>The Waf framework is somewhat different from traditional build systems in the sense that it does not provide support for a specific language. Rather, the focus is to support the major usecases encountered when working on a software project. As such, it is essentially a library of components that are suitable for use in a build system, with an emphasis on extensibility. Although the default distribution contains various plugins for several programming languages and different tools (c, d, ocaml, java, etc), it is by no means a frozen product. Creating new extensions is both a standard and a recommended practice.</p></div>
<h3 id="_objectives_of_this_book">Objectives of this book</h3><div style="clear:left"></div>
<div class="paragraph"><p>The objective of this book is to expose the use of the Waf build system though the use of Waf in practice, the description of the Waf extension system, and an overview of the Waf internals. We hope that this book will serve as a reference for both new and advanced users. Although this book does not deal with build systems in general, a secondary objective is to illustrate quite a few new techniques and patterns through numerous examples.</p></div>
<div class="paragraph"><p>The chapters are ordered by difficulty, starting from the basic use of Waf and Python, and diving gradually into the most difficult topics. It is therefore recommended to read the chapters in order. It is also possible to start by looking at the <a href="http://code.google.com/p/waf/source/browse/#git%2Fdemos">examples</a> from the Waf distribution before starting the reading.</p></div>
</div>
<h2 id="_download_and_installation">1. Download and installation</h2>
<div class="sectionbody">
<h3 id="_obtaining_the_waf_file">1.1. Obtaining the Waf file</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Waf project is located on <a href="http://code.google.com/p/waf">Google Code</a>.
The current Waf version requires an interpreter for the Python programming language such as <a href="http://www.python.org">cPython</a> 2.3 to 3.1 or <a href="http://www.jython.org">Jython</a> &gt;= 2.5.</p></div>
<h4 id="_downloading_and_using_the_waf_binary">1.1.1. Downloading and using the Waf binary</h4>
<div class="paragraph"><p>The Waf binary is a python script which does not require any installation whatsoever. It may be executed directly from a writable folder. Just rename it as <tt>waf</tt> if necessary:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.7.11</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ mv waf-1.7.11 waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ python waf --version</span></span>
<span style="color: #000000">waf 1.7.11 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>waf</tt> file has its own library compressed in a binary stream in the same file. Upon execution, the library is uncompressed in a hidden folder in the current directory. The folder will be re-created if removed. This scheme enables different Waf versions to be executed from the same folders:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ ls -ld .waf*</span></span>
<span style="color: #000000">.waf-1.7.11-2c924e3f453eb715218b9cc852291170</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The binary file requires <a href="http://docs.python.org/library/bz2.html">bzip2</a> compression support, which may be unavailable in some self-compiled cPython installations.</td>
</tr></table>
</div>
<h4 id="_building_waf_from_the_source_code">1.1.2. Building Waf from the source code</h4>
<div class="paragraph"><p>Building Waf requires a Python interpreter having a version number in the range 2.6-3.1. The source code is then processed to support Python 2.3, 2.4 and 2.5.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.7.11.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tar xjvf waf-1.7.11.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd waf-1.7.11</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ python waf-light</span></span>
<span style="color: #000000">Configuring the project</span>
<span style="color: #000000">'build' finished successfully (0.001s)</span>
<span style="color: #000000">Checking for program python              : /usr/bin/python</span>
<span style="color: #000000">Checking for python version              : (2, 6, 5, 'final', 0)</span>
<span style="color: #000000">'configure' finished successfully (0.176s)</span>
<span style="color: #000000">Waf: Entering directory `/waf-1.7.11/build'</span>
<span style="color: #000000">[1/1] create_waf:  -&gt; waf</span>
<span style="color: #000000">Waf: Leaving directory `/waf-1.7.11/build'</span>
<span style="color: #000000">'build' finished successfully (2.050s)</span></tt></pre></div></div>
<div class="paragraph"><p>For older interpreters, it is possible to build the <tt>waf</tt> file with gzip compression instead of bzip2:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --zip-type=gz</span></span></tt></pre></div></div>
<div class="paragraph"><p>The files present in the folder <em>waflib/extras</em> represent extensions (Waf tools) that are in a testing phase. They may be added to the Waf binary by using the <em>--tools</em> switch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --tools=compat15,swig,doxygen</span></span></tt></pre></div></div>
<div class="paragraph"><p>The tool <em>compat15</em> is required to provide some compatibility with previous Waf versions.
To remove it, it is necessary to modify the initialization by changing the <em>--prelude</em> switch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --make-waf --prelude='' --tools=swig</span></span></tt></pre></div></div>
<div class="paragraph"><p>Finally, here is how to import an external tool and load it in the initialization. Assuming the file <tt>aba.py</tt> is present in the current directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">():</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> WAFVERSION</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"This is Waf %s"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> WAFVERSION</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The following will create a custom waf file which will import and execute <em>foo</em> whenever it is executed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --make-waf --tools=compat15,$PWD/aba.py</span></span>
<span style="color: #000000">   --prelude=$'\tfrom waflib.extras import aba\n\taba.foo()'</span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf --help</span></span>
<span style="color: #000000">This is Waf 1.7.11</span>
<span style="color: #000000">[...]</span></tt></pre></div></div>
<div class="paragraph"><p>Foreign files to add into the folder <em>extras</em> must be given by absolute paths in the <em>--tools</em> switch.
Such files do not have to be Python files, yet, a typical scenario is to add an initializer to modify existing
functions and classes from the Waf modules. Various from the <a href="http://code.google.com/p/waf/source/browse/trunk/build_system_kit/">build system kit</a> illustrate how to create custom
build systems derived from Waf.</p></div>
<h3 id="_using_the_waf_file">1.2. Using the Waf file</h3><div style="clear:left"></div>
<h4 id="_permissions_and_aliases">1.2.1. Permissions and aliases</h4>
<div class="paragraph"><p>Because the waf script is a python script, it is usually executed by calling <tt>python</tt> on it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>On unix-like systems, it is usually much more convenient to set the executable permissions and avoid calling <tt>python</tt> each time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ chmod 755 waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf --version</span></span>
<span style="color: #000000">waf 1.7.11 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>If the command-line interpreter supports aliases, it is recommended to set the alias once:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ alias waf=$PWD/waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf --version</span></span>
<span style="color: #000000">waf 1.7.11 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>Or, the execution path may be modified to point at the location of the waf binary:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export PATH=$PWD:$PATH</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf --version</span></span>
<span style="color: #000000">waf 1.7.11 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>In the next sections of the book, we assume that either an alias or the execution path have been set in a way that <tt>waf</tt> may be called directly.</p></div>
<h4 id="_local_waflib_folders">1.2.2. Local waflib folders</h4>
<div class="paragraph"><p>Although the waf library is unpacked automatically from the waf binary file, it is sometimes necessary to keep the files in a visible folder, which may even be kept in a source control tool (subversion, git, etc). For example, the <tt>waf-light</tt> script does not contain the waf library, yet it is used to create the <tt>waf</tt> script by using the directory <tt>waflib</tt>.</p></div>
<div class="paragraph"><p>The following diagram represents the process used to find the <tt>waflib</tt> directory:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="waflib.png" alt="Waflib discovery" />
</div>
</div>
<h4 id="_portability_concerns">1.2.3. Portability concerns</h4>
<div class="paragraph"><p>By default, the recommended Python interpreter is cPython, for which the supported versions are 2.3 to 3.1. For maximum convenience for the user, a copy of the <a href="http://www.jython.org">Jython</a> interpreter in the version 2.5 may be redistributed along with a copy of the Waf executable.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">A project containing <em>waf</em>, <em>jython2.5.jar</em> and the source code may be used almost anywhere.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">The <em>waf</em> script must reside in a writable folder to unpack its cache files.</td>
</tr></table>
</div>
</div>
<h2 id="_projects_and_commands">2. Projects and commands</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <em>waf</em> script is meant to build software projects, and is of little use when taken alone. This chapter describes what is necessary to set up a waf project and how to use the <em>waf</em> script.</p></div>
<h3 id="_waf_commands">2.1. Waf commands</h3><div style="clear:left"></div>
<div class="paragraph"><p>Waf projects use description files of the name <em>wscript</em> which are python scripts containing functions and variables that may be used by Waf. Particular functions named <em>waf commands</em> may be used by Waf on the command-line.</p></div>
<h4 id="_declaring_waf_commands">2.1.1. Declaring Waf commands</h4>
<div class="paragraph"><p>Waf commands are really simple functions and may execute arbitrary python code such as calling other functions.
They take a single parameter as input and do not have to return any particular value as in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">#! /usr/bin/env python</span>
<span style="color: #808080"># encoding: utf-8</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span><span style="color: #000000"> </span><span style="color: #000000">hello</span><span style="color: #000000">(</span><span style="color: #000000">ctx </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'hello world'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The <em>waf command</em> <strong>hello</strong>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
A waf context, used to share data between scripts
</td></tr>
</table></div>
<div class="paragraph"><p>And here is how to have <tt>waf</tt> call the function hello from the command-line:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf hello</span></span>
<span style="color: #000000">hello world</span>
<span style="color: #000000">'hello' finished successfully (0.001s)</span></tt></pre></div></div>
<h4 id="_chaining_waf_commands">2.1.2. Chaining Waf commands</h4>
<div class="paragraph"><p>Several commands may be declared in the same <em>wscript</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' ping! %d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pong</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' pong! %d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>And may be chained for execution by Waf:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf ping pong ping ping</span></span>
<span style="color: #000000"> ping! 140704847272272</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>
<span style="color: #000000"> pong! 140704847271376</span>
<span style="color: #000000">'pong' finished successfully (0.001s)</span>
<span style="color: #000000"> ping! 140704847272336</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>
<span style="color: #000000"> ping! 140704847272528</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The context parameter is a new object for each command executed. The classes are also different: ConfigureContext for configure, BuildContext for build, OptionContext for option, and Context for any other command.</td>
</tr></table>
</div>
<h4 id="_using_several_scripts_and_folders">2.1.3. Using several scripts and folders</h4>
<div class="paragraph"><p>Although a Waf project must contain a top-level <em>wscript</em> file, the contents may be split into several sub-project files. We will now illustrate this concept on a small project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The commands in the top-level <em>wscript</em> will call the same commands from a subproject <em>wscript</em> file by calling a context method named <em>recurse</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>And here is the contents of <em>src/wscript</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the results will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_recurse</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_recurse</span>
<span style="color: #000000">→ ping from /tmp/execution_recurse/src</span>
<span style="color: #000000">'ping' finished successfully (0.002s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ cd src</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_recurse/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The method <em>recurse</em>, and the attribute <em>path</em> are available on all waf context classes</td>
</tr></table>
</div>
<h3 id="_waf_project_definition">2.2. Waf project definition</h3><div style="clear:left"></div>
<h4 id="_configuring_a_project_the_em_configure_em_command">2.2.1. Configuring a project (the <em>configure</em> command)</h4>
<div class="paragraph"><p>Although Waf may be called from any folder containing a <em>wscript</em> file, it is usually a good idea to have a single entry point in the scripts.
Besides ensuring a consistent behaviour, it also saves the redefinition of the same imports and function redefinitions in all wscript files.
The following concepts help to structure a Waf project:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Project directory: directory containing the source files that will be packaged and redistributed to other developers or to end users
</p>
</li>
<li>
<p>
Build directory: directory containing the files generated by the project (configuration sets, build files, logs, etc)
</p>
</li>
<li>
<p>
System files: files and folders which do not belong to the project (operating system files, etc)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The predefined command named <em>configure</em> is used to gather and store the information about these folders.
We will now extend the example from the previous section with the following top-level wscript file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
string representing the project directory. In general, top is set to <em>.</em>, except for some proprietary projects where the wscript cannot be added to the top-level, top may be set to <em>../..</em> or even some other folder such as <em>/checkout/perforce/project</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
string representing the build directory. In general, it is set to <em>build</em>, except for some proprietary projects where the build directory may be set to an absolute path such as <em>/tmp/build</em>. It is important to be able to remove the build directory safely, so it should never be given as <em>.</em> or <em>..</em>.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
the <em>configure</em> function is called by the <em>configure</em> command
</td></tr>
</table></div>
<div class="paragraph"><p>The script in <em>src/wscript</em> is left unchanged:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_configure <img src="./callouts/1.png" alt="1" /></span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_configure</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/ <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">|   |-- c4che/ <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">|   |   |-- build.config.py <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">|   |   `-- _cache.py <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">|   `-- config.log <img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">|--.lock-wafbuild <img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_configure</span>
<span style="color: #000000">→ ping from /tmp/execution_configure/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ cd src</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf ping <img src="./callouts/9.png" alt="9" /></span></span>
<span style="color: #000000">→ ping from /tmp/execution_configure</span>
<span style="color: #000000">→ ping from /tmp/execution_configure/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
To configure the project, change to the directory containing the top-level project file
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The execution is called by calling <em>waf configure</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The build directory was created
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The configuration data is stored in the folder <em>c4che/</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The command-line options and environment variables in use are stored in <em>build.config.py</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The user configuration set is stored in <em>_cache.py</em>
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Configuration log (duplicate of the output generated during the configuration)
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Hidden file pointing at the relevant project file and build directory
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Calling <em>waf</em> from a subfolder will execute the commands from the same wscript file used for the configuration
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content"><em>waf configure</em> is always called from the directory containing the wscript file</td>
</tr></table>
</div>
<h4 id="_removing_generated_files_the_em_distclean_em_command">2.2.2. Removing generated files (the <em>distclean</em> command)</h4>
<div class="paragraph"><p>A command named <em>distclean</em> is provided to remove the build directory and the lock file created during the configuration. On the example from the previous section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_configure</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/</span>
<span style="color: #000000">|   |-- c4che/</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   `-- config.log</span>
<span style="color: #000000">|--.lock-wafbuild</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The <em>distclean</em> command definition is implicit (no declaration in the wscript file)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The tree is reverted to its original state: no build directory and no lock file
</td></tr>
</table></div>
<div class="paragraph"><p>The behaviour of <em>distclean</em> is fairly generic and the corresponding function does not have to be defined in the wscript files. It may be defined to alter its behaviour though, see for example the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">distclean</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' Not cleaning anything!'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean</span></span>
<span style="color: #000000"> Not cleaning anything!</span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span></tt></pre></div></div>
<h4 id="_packaging_the_project_sources_the_em_dist_em_command">2.2.3. Packaging the project sources (the <em>dist</em> command)</h4>
<div class="paragraph"><p>The <em>dist</em> command is provided to create an archive of the project. By using the script presented previously:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>Execute the <em>dist</em> command to get:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_dist</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_dist</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: noname-1.0.tar.bz2 (sha='a4543bb438456b56d6c89a6695f17e6cb69061f5')</span>
<span style="color: #000000">'dist' finished successfully (0.035s)</span></tt></pre></div></div>
<div class="paragraph"><p>By default, the project name and version are set to <em>noname</em> and <em>1.0</em>. To change them, it is necessary to provide two additional variables in the top-level project file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">APPNAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'webe'</span>
<span style="color: #000000">VERSION </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'2.0'</span>

<span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>Because the project was configured once, it is not necessary to configure it once again:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: webe-2.0.tar.bz2 (sha='7ccc338e2ff99b46d97e5301793824e5941dd2be')</span>
<span style="color: #000000">'dist' finished successfully (0.006s)</span></tt></pre></div></div>
<div class="paragraph"><p>More parameters may be given to alter the archive by adding a function <em>dist</em> in the script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dist</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">base_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo_2.0'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">algo      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'zip'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">excl      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">' **/.waf-1* **/*~ **/*.pyc **/*.swp **/.lock-w*'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">files     </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The archive name may be given directly instead of computing from <em>APPNAME</em> and <em>VERSION</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The default compression format is <em>tar.bz2</em>. Other valid formats are <em>zip</em> and <em>tar.gz</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Exclude patterns passed to give to <em>ctx.path.ant_glob()</em> which is used to find the files
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The files to add to the archive may be given as Waf node objects (<em>excl</em> is therefore ignored)
</td></tr>
</table></div>
<h4 id="_defining_command_line_options_the_em_options_em_command">2.2.4. Defining command-line options (the <em>options</em> command)</h4>
<div class="paragraph"><p>The Waf script provides various default command-line options, which may be consulted by executing <tt>waf --help</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --help</span></span>
<span style="color: #000000">waf [command] [options]</span>

<span style="color: #000000">Main commands (example: ./waf build -j4)</span>
<span style="color: #000000">  build    : executes the build</span>
<span style="color: #000000">  clean    : cleans the project</span>
<span style="color: #000000">  configure: configures the project</span>
<span style="color: #000000">  dist     : makes a tarball for redistributing the sources</span>
<span style="color: #000000">  distcheck: checks if the project compiles (tarball from 'dist')</span>
<span style="color: #000000">  distclean: removes the build directory</span>
<span style="color: #000000">  install  : installs the targets on the system</span>
<span style="color: #000000">  list     : lists the targets to execute</span>
<span style="color: #000000">  step     : executes tasks in a step-by-step fashion, for debugging</span>
<span style="color: #000000">  uninstall: removes the targets installed</span>

<span style="color: #000000">Options:</span>
<span style="color: #000000">  --version             show program's version number and exit</span>
<span style="color: #000000">  -h, --help            show this help message and exit</span>
<span style="color: #000000">  -j JOBS, --jobs=JOBS  amount of parallel jobs (2)</span>
<span style="color: #000000">  -k, --keep            keep running happily even if errors are found</span>
<span style="color: #000000">  -v, --verbose         verbosity level -v -vv or -vvv [default: 0]</span>
<span style="color: #000000">  --nocache             ignore the WAFCACHE (if set)</span>
<span style="color: #000000">  --zones=ZONES         debugging zones (task_gen, deps, tasks, etc)</span>

<span style="color: #000000">  configure options:</span>
<span style="color: #000000">    -o OUT, --out=OUT   build dir for the project</span>
<span style="color: #000000">    -t TOP, --top=TOP   src dir for the project</span>
<span style="color: #000000">    --prefix=PREFIX     installation prefix [default: '/usr/local/']</span>
<span style="color: #000000">    --download          try to download the tools if missing</span>

<span style="color: #000000">  build and install options:</span>
<span style="color: #000000">    -p, --progress      -p: progress bar; -pp: ide output</span>
<span style="color: #000000">    --targets=TARGETS   task generators, e.g. "target1,target2"</span>

<span style="color: #000000">  step options:</span>
<span style="color: #000000">    --files=FILES       files to process, by regexp, e.g. "*/main.c,*/test/main.o"</span>

<span style="color: #000000">  install/uninstall options:</span>
<span style="color: #000000">    --destdir=DESTDIR   installation root [default: '']</span>
<span style="color: #000000">    -f, --force         force file installation</span></tt></pre></div></div>
<div class="paragraph"><p>Accessing a command-line option is possible from any command. Here is how to access the value <em>prefix</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ prefix is '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">prefix</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the following will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ prefix is /usr/local/</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>To define project command-line options, a special command named <em>options</em> may be defined in user scripts. This command will be called once before any other command executes.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ the value of foo is %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the following will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure --foo=test</span></span>
<span style="color: #000000">→ the value of foo is 'test'</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>The command context for options is a shortcut to access the optparse functionality. For more information on the optparse module, consult the <a href="http://docs.python.org/library/optparse.html">Python documentation</a></p></div>
<h3 id="_the_em_build_em_commands">2.3. The <em>build</em> commands</h3><div style="clear:left"></div>
<h4 id="_building_targets_the_em_build_em_command">2.3.1. Building targets (the <em>build</em> command)</h4>
<div class="paragraph"><p>The <em>build</em> command is used for building targets. We will now create a new project in <em>/tmp/execution_build/</em>, and add a script to create an empty file <tt>foo.txt</tt> and then copy it into another file <tt>bar.txt</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Calling <em>waf build</em> directly results in an error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_build/</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">The project was not configured: run "waf configure" first!</span></tt></pre></div></div>
<div class="paragraph"><p>The build requires a configured folder to know where to look for source files and where to output the created files. Let&#8217;s try again:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure build</span></span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">[1/2] foo.txt:  -&gt; build_directory/foo.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[2/2] bar.txt: build_directory/foo.txt -&gt; build_directory/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.041s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/</span>
<span style="color: #000000">|   |-- bar.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|   |-- c4che/</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- foo.txt</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- .wafpickle <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">|--.lock-wafbuild</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.008s) <img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Note that the build <em>deduced</em> that <tt>bar.txt</tt> has to be created after <tt>foo.txt</tt>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The targets are created in the build directory
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
A pickle file is used to store the information about the targets
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Since the targets are up-to-date, they do not have to be created once again
</td></tr>
</table></div>
<div class="paragraph"><p>Since the command <em>waf build</em> is usually executed very often, a shortcut is provided to call it implicitly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span></tt></pre></div></div>
<h4 id="_cleaning_the_targets_the_em_clean_em_command">2.3.2. Cleaning the targets (the <em>clean</em> command)</h4>
<div class="paragraph"><p>The <em>clean</em> command is used to remove the information about the files and targets created during the build. It uses the same function <em>build</em> from the wscript files so there is no need to add a function named <em>clean</em> in the wscript file.</p></div>
<div class="paragraph"><p>After cleaning, the targets will be created once again even if they were up-to-date:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build -v</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[1/2] foo.txt:  -&gt; build_directory/foo.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">14:58:34 runner 'touch foo.txt' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[2/2] bar.txt: build_directory/foo.txt -&gt; build_directory/bar.txt</span>
<span style="color: #000000">14:58:34 runner 'cp foo.txt bar.txt'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.040s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
All commands are executed from the build directory by default
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The information about the files <tt>foo.txt</tt> was lost so it is rebuilt
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
By using the <em>-v</em> flag, the command-lines executed are displayed
</td></tr>
</table></div>
<h4 id="_more_build_commands">2.3.3. More build commands</h4>
<div class="paragraph"><p>The following commands all use the same function <em>build</em> from the wscript file:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>build:</tt> process the source code to create the object files
</p>
</li>
<li>
<p>
<tt>clean:</tt> remove the object files that were created during a build (unlike distclean, do not remove the configuration)
</p>
</li>
<li>
<p>
<tt>install:</tt> check that all object files have been generated and copy them on the system (programs, libraries, data files, etc)
</p>
</li>
<li>
<p>
<tt>uninstall:</tt> undo the installation, remove the object files from the system without touching the ones in the build directory
</p>
</li>
<li>
<p>
<tt>list:</tt> list the task generators in the build section (to use with waf --targets=name)
</p>
</li>
<li>
<p>
<tt>step:</tt> force the rebuild of particular files for debugging purposes
</p>
</li>
</ol></div>
<div class="paragraph"><p>The attribute <em>cmd</em> holds the name of the command being executed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'clean'</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'cleaning!'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure clean build</span></span>
<span style="color: #000000">Setting top to : /tmp/execution_cmd</span>
<span style="color: #000000">Setting out to : /tmp/execution_cmd/build_directory</span>
<span style="color: #000000">configure</span>
<span style="color: #000000">'configure' finished successfully (0.002s)</span>
<span style="color: #000000">cleaning!</span>
<span style="color: #000000">'clean' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_cmd/build_directory'</span>
<span style="color: #000000">build</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_cmd/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>The build command usage will be described in details in the next chapters.</p></div>
</div>
<h2 id="_project_configuration">3. Project configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <em>configuration</em> command is used to check if the requiremements for working on a project are met and to store the information. The parameters are then stored for use by other commands, such as the build command.</p></div>
<h3 id="_using_persistent_data">3.1. Using persistent data</h3><div style="clear:left"></div>
<h4 id="_sharing_data_with_the_build">3.1.1. Sharing data with the build</h4>
<div class="paragraph"><p>The configuration context is used to store data which may be re-used during the build. Let&#8217;s begin with the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> var</span><span style="color: #000000">=</span><span style="color: #009900">'TOUCH'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">TOUCH</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'${TOUCH} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Store the option <em>foo</em> into the variable <em>env</em> (dict-like structure)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Configuration routine used to find the program <em>touch</em> and to store it into <em>ctx.env.TOUCH</em> <span class="footnote"><br />[<em>find_program</em> may use the same variable from the OS environment during the search, for example <em>CC=gcc waf configure</em>]<br /></span>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Print the value of <em>ctx.env.FOO</em> that was set during the configuration
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The variable <em>${TOUCH}</em> corresponds to the variable <em>ctx.env.TOUCH</em>.
</td></tr>
</table></div>
<div class="paragraph"><p>Here is the execution output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --foo=abcd -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Checking for program touch               : /usr/bin/touch <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/configuration_build/build'</span>
<span style="color: #000000">/usr/bin/touch <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">abcd</span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; build/foo.txt</span>
<span style="color: #000000">10:56:41 runner '/usr/bin/touch foo.txt' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/configuration_build/build'</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Output of the configuration test <em>find_program</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The value of <em>TOUCH</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Command-line used to create the target <em>foo.txt</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The variable <em>ctx.env</em> is called a <strong>Configuration set</strong>, and is an instance of the class <em>ConfigSet</em>. The class is a wrapper around Python dicts to handle serialization. For this reason it should be used for simple variables only (no functions or classes). The values are stored in a python-like format in the build directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">build/</span>
<span style="color: #000000">|-- foo.txt</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">`-- config.log</span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/c4che/_cache.py</span></span>
<span style="color: #000000">FOO = 'abcd'</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>
<span style="color: #000000">TOUCH = '/usr/bin/touch'</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Reading and writing values to <em>ctx.env</em> is possible in both configuration and build commands. Yet, the values are stored to a file only during the configuration phase.</td>
</tr></table>
</div>
<h4 id="_configuration_set_usage">3.1.2. Configuration set usage</h4>
<div class="paragraph"><p>We will now provide more examples of the configuration set usage. The object <strong>ctx.env</strong> provides convenience methods to access its contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">[</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'CXXFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-g'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_unique</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">])</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O3'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Key-based access; storing a list
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Attribute-based access (the two forms are equivalent)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Append each element to the list <em>ctx.env.CXXFLAGS</em>, assuming it is a list
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Insert the values at the beginning. Note that there is no such method as <em>prepend_unique</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">&lt;class 'waflib.ConfigSet.ConfigSet'&gt; <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'CFLAGS' ['-O3', '-g', '-O2'] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'CXXFLAGS' ['-O2', '-g']</span>
<span style="color: #000000">'PREFIX' '/usr/local'</span>
<span style="color: #000000">[] <img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/c4che/_cache.py <img src="./callouts/4.png" alt="4" /></span></span>
<span style="color: #000000">CFLAGS = ['-O3', '-g', '-O2']</span>
<span style="color: #000000">CXXFLAGS = ['-O2', '-g']</span>
<span style="color: #000000">PREFIX = '/usr/local'</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The object <em>conf.env</em> is an instance of the class ConfigSet defined in <em>waflib/ConfigSet.py</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The contents of <em>conf.env</em> after the modifications
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
When a key is undefined, it is assumed that it is a list (used by <strong>append_value</strong> above)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The object <em>conf.env</em> is stored by default in this file
</td></tr>
</table></div>
<div class="paragraph"><p>Copy and serialization apis are also provided:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'TEST'</span>

<span style="color: #000000">        env_copy </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        env_copy</span><span style="color: #000000">.</span><span style="color: #000000">store</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">ConfigSet </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> ConfigSet</span>
<span style="color: #000000">        env2 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ConfigSet</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        env2</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Make a copy of <em>ctx.env</em> - this is a shallow copy
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use <strong>ctx.path</strong> to create a node object representing the file <tt>test.txt</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Store the contents of <strong>env_copy</strong> into <tt>test.txt</tt>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Create a new empty ConfigSet object
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Load the values from <tt>test.txt</tt>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Print the contents of <tt>test.txt</tt>
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">FOO = 'TEST'</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span></tt></pre></div></div>
<h3 id="_configuration_utilities">3.2. Configuration utilities</h3><div style="clear:left"></div>
<h4 id="_configuration_methods">3.2.1. Configuration methods</h4>
<div class="paragraph"><p>The method <em>ctx.find_program</em> seen previously is an example of a configuration method. Here are more examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> var</span><span style="color: #000000">=</span><span style="color: #009900">'TOUCH'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">check_waf_version</span><span style="color: #000000">(</span><span style="color: #000000">mini</span><span style="color: #000000">=</span><span style="color: #009900">'1.7.11'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_file</span><span style="color: #000000">(</span><span style="color: #009900">'fstab'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/etc'</span><span style="color: #000000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Although these methods are provided by the context class <em>waflib.Configure.ConfigurationContext</em>, they will not appear on it in <a href="http://docs.waf.googlecode.com/git/apidocs_17/index.html">API documentation</a>. For modularity reasons, they are defined as simple functions and then bound dynamically:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@conf </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">hi</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ hello, world!'</span><span style="color: #000000">)</span>

<span style="color: #808080"># hi = conf(hi) <img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">hi</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Import the decorator <strong>conf</strong>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use the decorator to bind the method <em>hi</em> to the configuration context and build context classes. In practice, the configuration methods are only used during the configuration phase.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Decorators are simple python function. Python 2.3 does not support the <strong>@</strong> syntax so the function has to be called after the function declaration
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Use the method previously bound to the configuration context class
</td></tr>
</table></div>
<div class="paragraph"><p>The execution will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ hello, world!</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span></tt></pre></div></div>
<h4 id="_loading_and_using_waf_tools">3.2.2. Loading and using Waf tools</h4>
<div class="paragraph"><p>For efficiency reasons, only a few configuration methods are present in the Waf core. Most configuration methods are loaded by extensions called <strong>Waf tools</strong>.
The main tools are located in the folder <tt>waflib/Tools</tt>, and the tools in testing phase are located under the folder <tt>waflib/extras</tt>.
Yet, Waf tools may be used from any location on the filesystem.</p></div>
<div class="paragraph"><p>We will now demonstrate a very simple Waf tool named <tt>dang.py</tt> which will be used to set <em>ctx.env.DANG</em> from a command-line option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">#! /usr/bin/env python</span>
<span style="color: #808080"># encoding: utf-8</span>

<span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ loading the dang tool'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--dang'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">=</span><span style="color: #009900">'dang'</span><span style="color: #000000">)</span>

<span style="color: #000000">@conf</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">read_dang</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">start_msg</span><span style="color: #000000">(</span><span style="color: #009900">'Checking for the variable DANG'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">dang</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">dang </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">end_msg</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">end_msg</span><span style="color: #000000">(</span><span style="color: #009900">'DANG is not set'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">read_dang</span><span style="color: #000000">()</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Provide command-line options
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Bind the function <em>read_dang</em> as a new configuration method to call ctx.read_dang() below
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Set an persistent value from the current command-line options
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Provide a command named <em>configure</em> accepting a build context instance as parameter
</td></tr>
</table></div>
<div class="paragraph"><p>For loading a tool, the method <em>load</em> must be used during the configuration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Load the options defined in <em>dang.py</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Load the tool dang.py. By default, load calls the method <em>configure</em> defined in the tools.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The tool modifies the value of <em>ctx.env.DANG</em> during the configuration
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure --dang=hello</span></span>
<span style="color: #000000">→ loading the dang tool</span>
<span style="color: #000000">Checking for DANG                        : hello <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ loading the dang tool <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Entering directory `/tmp/configuration_dang/build'</span>
<span style="color: #000000">hello</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/configuration_dang/build'</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
First the tool is imported as a python module, and then the method <em>configure</em> is called by <em>load</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The tools loaded during the configuration will be loaded during the build phase
</td></tr>
</table></div>
<h4 id="_multiple_configurations">3.2.3. Multiple configurations</h4>
<div class="paragraph"><p>The <em>conf.env</em> object is an important point of the configuration which is accessed and modified by Waf tools and by user-provided configuration functions. The Waf tools do not enforce a particular structure for the build scripts, so the tools will only modify the contents of the default object. The user scripts may provide several <em>env</em> objects in the configuration and pre-set or post-set specific values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        env </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">env </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CC </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'gcc'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'release'</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'msvc'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/O2'</span><span style="color: #000000">]</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">all_envs</span><span style="color: #000000">[</span><span style="color: #009900">'debug'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Save a reference to <em>conf.env</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Copy and replace <em>conf.env</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Modify <em>conf.env</em>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Copy and replace <em>conf.env</em> again, from the initial data
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Recall a configuration set by its name
</td></tr>
</table></div>
<h3 id="_exception_handling">3.3. Exception handling</h3><div style="clear:left"></div>
<h4 id="_launching_and_catching_configuration_exceptions">3.3.1. Launching and catching configuration exceptions</h4>
<div class="paragraph"><p>Configuration helpers are methods provided by the conf object to help find parameters, for example the method <em>conf.find_program</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>When a test cannot complete properly, an exception of the type <em>waflib.Errors.ConfigurationError</em> is raised. This often occurs when something is missing in the operating system environment or because a particular condition is not satisfied. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Checking for program some_app         : not found</span>
<span style="color: #000000"> error: The program some_app could not be found</span></tt></pre></div></div>
<div class="paragraph"><p>These exceptions may be raised manually by using <em>conf.fatal</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">"I'm sorry Dave, I'm afraid I can't do that"</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Which will display the same kind of error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000"> error: I'm sorry Dave, I'm afraid I can't do that</span>
<span style="font-weight: bold"><span style="color: #993399">$ echo $?</span></span>
<span style="color: #000000">1</span></tt></pre></div></div>
<div class="paragraph"><p>Here is how to catch configuration exceptions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">except</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">errors</span><span style="color: #000000">.</span><span style="color: #000000">ConfigurationError</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">to_log</span><span style="color: #000000">(</span><span style="color: #009900">'some_app was not found (ignoring)'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
For convenience, the module <em>waflib.Errors</em> is bound to <em>ctx.errors</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Adding information to the log file
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">Checking for program some_app            : not found</span>
<span style="color: #000000">'configure' finished successfully (0.029s) <img src="./callouts/1.png" alt="1" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/config.log <img src="./callouts/2.png" alt="2" /></span></span>
<span style="font-weight: bold"><span style="color: #993399"># project  configured on Tue Jul 13 19:15:04 2010 by</span></span>
<span style="font-weight: bold"><span style="color: #993399"># waf 1.7.11 (abi 98, python 20605f0 on linux2)</span></span>
<span style="font-weight: bold"><span style="color: #993399"># using /home/waf/bin/waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">#</span></span>
<span style="color: #000000">Checking for program some_app</span>
<span style="color: #000000">not found</span>
<span style="color: #000000">find program=['some_app'] paths=['/usr/local/bin', '/usr/bin'] var=None -&gt; ''</span>
<span style="color: #000000">from /tmp/configuration_exception: The program ['some_app'] could not be found</span>
<span style="color: #000000">some_app was not found (ignoring) <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The configuration completes without errors
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The log file contains useful information about the configuration execution
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Our log entry
</td></tr>
</table></div>
<div class="paragraph"><p>Catching the errors by hand can be inconvenient. For this reason, all <strong>@conf</strong> methods accept a parameter named <em>mandatory</em> to suppress configuration errors. The code snippet is therefore equivalent to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>As a general rule, clients should never rely on exit codes or returned values and must catch configuration exceptions. The tools should always raise configuration errors to display the errors and to give a chance to the clients to process the exceptions.</p></div>
<h4 id="_transactions">3.3.2. Transactions</h4>
<div class="paragraph"><p>Waf tools called during the configuration may use and modify the contents of <em>conf.env</em> at will. Those changes may be complex to track and to undo. Fortunately, the configuration exceptions make it possible to simplify the logic and to go back to a previous state easily. The following example illustrates how to use a transaction to to use several tools at once:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> compiler </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'msvc'</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">stash</span><span style="color: #000000">()</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #000000">compiler</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">errors</span><span style="color: #000000">.</span><span style="color: #000000">ConfigurationError</span><span style="color: #000000">:</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">revert</span><span style="color: #000000">()</span>
<span style="color: #000000">                </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">break</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">'Could not find a compiler'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Though several calls to <em>stash</em> can be made, the copies made are shallow, which means that any complex object (such as a list) modification will be permanent. For this reason, the following is a configuration anti-pattern:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The methods should always be used instead:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
<h2 id="_builds">4. Builds</h2>
<div class="sectionbody">
<div class="paragraph"><p>We will now provide a detailed description of the build phase, which is used for processing the build targets.</p></div>
<h3 id="_essential_build_concepts">4.1. Essential build concepts</h3><div style="clear:left"></div>
<h4 id="_build_order_and_dependencies">4.1.1. Build order and dependencies</h4>
<div class="paragraph"><p>To illustrate the various concepts that are part of the build process, we are now going to use a new example.
The files <tt>foo.txt</tt> and <tt>bar.txt</tt> will be created by copying the file <tt>wscript</tt>, and the file <tt>foobar.txt</tt> will be created from the concatenation of the generated files. Here is a summary: <span class="footnote"><br />[It is actually considered a best practice to avoid copying files. When this is required, consider installing files or re-using the examples provided under the folder <tt>demos/subst</tt> of the source ditribution.]<br /></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cp: wscript -&gt; foo.txt</span>
<span style="color: #000000">cp: wscript -&gt; bar.txt</span>
<span style="color: #000000">cat: foo.txt, bar.txt -&gt; foobar.txt</span></tt></pre></div></div>
<div class="paragraph"><p>Each of the three lines represents a command to execute. While the <em>cp</em> commands may be executed in any order or even in parallel, the <em>cat</em> command may only be executed after all the others are done. The constraints on <strong>the build order</strong> are represented on the following <a href="http://en.wikipedia.org/wiki/Directed_acyclic_graph">Directed acyclic graph</a>:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dag_tasks.png" alt="Task representation of the same build" />
</div>
</div>
<div class="paragraph"><p>When the <tt>wscript</tt> input file changes, the <tt>foo.txt</tt> output file has to be created once again. The file <tt>foo.txt</tt> is said to depend on the <tt>wscript</tt> file. The <strong>file dependencies</strong> can be represented by a Direct acyclic graph too:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dag_nodes.png" alt="File dependencies on a simple build" />
</div>
</div>
<div class="paragraph"><p>Building a project consists in executing the commands according to a schedule which will respect these constraints. Faster build will be obtained when commands are executed in parallel (by using the build order), and when commands can be skipped (by using the dependencies).</p></div>
<div class="paragraph"><p>In Waf, the commands are represented by <strong>task objects</strong>. The dependencies are used by the task classes, and may be file-based or abstract to enforce particular constraints.</p></div>
<h4 id="_direct_task_declaration">4.1.2. Direct task declaration</h4>
<div class="paragraph"><p>We will now represent the build from the previous section by declaring the tasks directly in the build section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">                        </span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cat</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cat %s %s &gt; %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">                        </span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">        cp_1 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        cp_1</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        cp_1</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cp_1</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        cp_2 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        cp_2</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">        cp_2</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cp_2</span><span style="color: #000000">)</span>

<span style="color: #000000">        cat_1 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cat</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        cat_1</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">cp_1</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000">+</span><span style="color: #000000"> cp_2</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span>
<span style="color: #000000">        cat_1</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cat_1</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Task class declaration
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Waf tasks have a method named <strong>run</strong> to generate the targets
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Instances of <em>waflib.Task.Task</em> have input and output objects representing the files to use (Node objects)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Create a new task instance manually
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Set input and output files represented as <em>waflib.Node.Node</em> objects
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Add the task to the build context for execution (but do not execute them immediately)
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">[1/3] cp: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">[2/3] cp: wscript -&gt; build/bar.txt</span>
<span style="color: #000000">[3/3] cat: build/foo.txt build/bar.txt -&gt; build/foobar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.047s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/3.png" alt="3" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">[1/3] cp: wscript -&gt; build/foo.txt <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/3] cp: wscript -&gt; build/bar.txt</span>
<span style="color: #000000">[3/3] cat: build/foo.txt build/bar.txt -&gt; build/foobar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.043s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The tasks are not executed in the <em>clean</em> command
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The build keeps track of the files that were generated to avoid generating them again
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Modify one of the source files
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Rebuild according to the dependency graph
</td></tr>
</table></div>
<div class="paragraph"><p>Please remember:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The execution order was <strong>computed automatically</strong>, by using the file inputs and outputs set on the task instances
</p>
</li>
<li>
<p>
The dependencies were <strong>computed automatically</strong> (the files were rebuilt when necessary), by using the node objects (hashes of the file contents were stored between the builds and then compared)
</p>
</li>
<li>
<p>
The tasks that have no order constraints are executed in parallel by default
</p>
</li>
</ol></div>
<h4 id="_task_encapsulation_by_task_generators">4.1.3. Task encapsulation by task generators</h4>
<div class="paragraph"><p>Declaring the tasks directly is tedious and results in lengthy scripts. Feature-wise, the following is equivalent to the previous example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cat ${SRC} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt bar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The <strong>ctx(&#8230;)</strong> call is a shortcut to the class <em>waflib.TaskGen.task_gen</em>, instances of this class are called <strong>task generator objects</strong>. The task generators are lazy containers and will only create the tasks and the task classes when they are actually needed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        tg </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        tg</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>Here is the output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf configure build</span>
<span style="color: #000000">Setting top to   : /tmp/build_lazy_tg</span>
<span style="color: #000000">Setting out to   : /tmp/build_lazy_tg/build</span>
<span style="color: #000000">'configure' finished successfully (0.204s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_lazy_tg/build'</span>
<span style="color: #000000">&lt;class 'waflib.TaskGen.task_gen'&gt; <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[{task: foo  -&gt; foo}] <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">&lt;class 'waflib.Task.foo'&gt; <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[1/1] foo:  -&gt; build/foo</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_lazy_tg/build'</span>
<span style="color: #000000">'build' finished successfully (0.023s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Task generator type
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The tasks created are stored in the list <em>tasks</em> (0..n tasks may be added)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Tasks are created after calling the method post() - it is usually called automatically internally
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A new task class was created dynamically for the target <tt>foo</tt>
</td></tr>
</table></div>
<h4 id="_overview_of_the_build_phase">4.1.4. Overview of the build phase</h4>
<div class="paragraph"><p>A high level overview of the build process is represented on the following diagram:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="build_overview.png" alt="Overview of the build phase" />
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The tasks are all created before any of them is executed. New tasks may be created after the build has started, but the dependencies have to be set by using low-level apis.</td>
</tr></table>
</div>
<h3 id="_more_build_options">4.2. More build options</h3><div style="clear:left"></div>
<div class="paragraph"><p>Although any operation can be executed as part of a task, a few scenarios are typical and it makes sense to provide convenience functions for them.</p></div>
<h4 id="_executing_specific_routines_before_or_after_the_build">4.2.1. Executing specific routines before or after the build</h4>
<div class="paragraph"><p>User functions may be bound to be executed at two key moments during the build command (callbacks):</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
immediately before the build starts (bld.add_pre_fun)
</p>
</li>
<li>
<p>
immediately after the build is completed successfully (bld.add_post_fun)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is how to execute a test after the build is finished:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--exe'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store_true'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span>
<span style="color: #000000">                help</span><span style="color: #000000">=</span><span style="color: #009900">'execute the program after it is built'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pre</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'before the build is started'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'after the build is complete'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'install'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">exe</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'/sbin/ldconfig'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_pre_fun</span><span style="color: #000000">(</span><span style="color: #000000">pre</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_post_fun</span><span style="color: #000000">(</span><span style="color: #000000">post</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The callbacks take the build context as unique parameter <em>ctx</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Access the command type
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Access to the command-line options
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A common scenario is to call ldconfig after the files are installed.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Scheduling the functions for later execution. Python functions are objects too.
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the following output will be produced:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build install --exe</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">'configure' finished successfully (0.011s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">before the build is started <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">after the build is complete <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">before the build is started</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">after the build is complete</span>
<span style="color: #000000">/sbin/ldconfig: Can't create temporary cache file /etc/ld.so.cache~: Permission denied <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">'install' finished successfully (15.730s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
output of the function bound by <em>bld.add_pre_fun</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
output of the function bound by <em>bld.add_post_fun</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
execution at installation time
</td></tr>
</table></div>
<h4 id="_installing_files">4.2.2. Installing files</h4>
<div class="paragraph"><p>Three build context methods are provided for installing files created during or after the build:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
install_files: install several files in a folder
</p>
</li>
<li>
<p>
install_as: install a target with a different name
</p>
</li>
<li>
<p>
symlink_as: create a symbolic link on the platforms that support it
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/include'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'a1.h'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'a2.h'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/bar.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">symlink_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/lib/libfoo.so.1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'libfoo.so.1.2.3'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        env_foo </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span>
<span style="color: #000000">        env_foo</span><span style="color: #000000">.</span><span style="color: #000000">PREFIX </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/opt'</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/test.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">=</span><span style="color: #000000">env_foo</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        start_dir </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src/bar'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'foo/a1.h'</span><span style="color: #000000">],</span>
<span style="color: #000000">                cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> start_dir</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*.png'</span><span style="color: #000000">),</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Install various files in the target destination
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Install one file, changing its name
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Create a symbolic link
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Overridding the configuration set (<em>env</em> is optional in the three methods install_files, install_as and symlink_as)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Install src/bar/foo/a1.h as seen from the current script into <em>${PREFIX}/share/foo/a1.h</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Install the png files recursively, preserving the folder structure read from src/bar/
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">the methods <em>install_files</em>, <em>install_as</em> and <em>symlink_as</em> will do something only during <em>waf install</em> or <em>waf uninstall</em>, they have no effect in other build commands</td>
</tr></table>
</div>
<h4 id="_listing_the_task_generators_and_forcing_specific_task_generators">4.2.3. Listing the task generators and forcing specific task generators</h4>
<div class="paragraph"><p>The <em>list</em> command is used to display the task generators that are declared:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'bar'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>By default, the name of the task generator is computed from the <em>target</em> attribute:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure list</span></span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">bar</span>
<span style="color: #000000">'list' finished successfully (0.008s)</span></tt></pre></div></div>
<div class="paragraph"><p>The main usage of the name values is to force a partial build with the <em>--targets</em> option. Compare the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_list/build'</span>
<span style="color: #000000">[1/2] foo.txt: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">[2/2] bar:  -&gt; build/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_list/build'</span>
<span style="color: #000000">'build' finished successfully (0.028s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf clean build --targets=foo.txt</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_list/build'</span>
<span style="color: #000000">[1/1] foo.txt: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_list/build'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<h4 id="_execution_step_by_step_for_debugging_the_em_step_em_command">4.2.4. Execution step by step for debugging (the <em>step</em> command)</h4>
<div class="paragraph"><p>The <em>step</em> is used to execute specific tasks and to return the exit status and any error message. It is particularly useful for debugging:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf step --files=test_shlib.c,test_staticlib.c</span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">c: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">cshlib: build/shlib/test_shlib.c.1.o -&gt; build/shlib/libmy_shared_lib.so</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">c: stlib/test_staticlib.c -&gt; build/stlib/test_staticlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">cstlib: build/stlib/test_staticlib.c.1.o -&gt; build/stlib/libmy_static_lib.a</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.201s)</span></tt></pre></div></div>
<div class="paragraph"><p>In this case the <tt>.so</tt> files were also rebuilt. Since the files attribute is interpreted as a comma-separated list of regular expressions, the following will produce a different output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf step --files=test_shlib.c$</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">c: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.083s)</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, the tasks to execute may be prefixed by <em>in:</em> or <em>out:</em> to specify if it is a source or a target file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf step --files=out:build/shlib/test_shlib.c.1.o</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">cc: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.091s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">when using <em>waf step</em>, all tasks are executed sequentially, even if some of them return a non-zero exit status</td>
</tr></table>
</div>
</div>
<h2 id="_node_objects">5. Node objects</h2>
<div class="sectionbody">
<div class="paragraph"><p>Node objects represent files or folders and are used to ease the operations dealing with the file system. This chapter provides an overview of their usage.</p></div>
<h3 id="_design_of_the_node_class">5.1. Design of the node class</h3><div style="clear:left"></div>
<h4 id="_the_node_tree">5.1.1. The node tree</h4>
<div class="paragraph"><p>The Waf nodes inherit the class <em>waflib.Node.Node</em> and provide a tree structure to represent the file system:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>parent</strong>: parent node
</p>
</li>
<li>
<p>
<strong>children</strong>: folder contents - or empty if the node is a file
</p>
</li>
</ol></div>
<div class="paragraph"><p>In practice, the reference to the filesystem tree is bound to the context classes for access from Waf commands. Here is an illustration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.path contents %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">children</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.path parent   %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.root parent   %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<strong>ctx.path</strong> represents the path to the <tt>wscript</tt> file being executed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<strong>ctx.root</strong> is the root of the file system or the folder containing the drive letters (win32 systems)
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to    : /tmp/node_tree</span>
<span style="color: #000000">Setting out to    : /tmp/node_tree/build</span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">/tmp/node_tree <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">/</span>
<span style="color: #000000">ctx.path contents {'wscript': /tmp/node_tree/wscript} <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">ctx.path parent   '/tmp' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">ctx.root parent   None <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">'dosomething' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Absolute paths are used frequently
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The folder contents are stored in the dict <em>children</em> which maps names to node objects
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Each node keeps reference to his <em>parent</em> node
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The root node has no <em>parent</em>
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">There is a strict correspondance between nodes and filesystem elements: a node represents exactly one file or one folder, and only one node can represent a file or a folder.</td>
</tr></table>
</div>
<h4 id="_node_caching">5.1.2. Node caching</h4>
<div class="paragraph"><p>By default, only the necessary nodes are created:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">children</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The filesystem root appears to only contain one node, although the real filesystem root contains more folders than just <tt>/tmp</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to   : /tmp/nodes_cache</span>
<span style="color: #000000">Setting out to   : /tmp/nodes_cache/build</span>
<span style="color: #000000">'configure' finished successfully (0.086s)</span>
<span style="color: #000000">{'tmp': /tmp}</span>
<span style="color: #000000">'dosomething' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ls /</span></span>
<span style="color: #000000">bin boot dev etc home tmp usr var</span></tt></pre></div></div>
<div class="paragraph"><p>This means in particular that some nodes may have to be read from the file system or created before being used.</p></div>
<h3 id="_general_usage">5.2. General usage</h3><div style="clear:left"></div>
<h4 id="_searching_and_creating_nodes">5.2.1. Searching and creating nodes</h4>
<div class="paragraph"><p>Nodes may be created manually or read from the file system. Three methods are provided for this purpose:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        nd1 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd1</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd2 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">search</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd2</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd3 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">search</span><span style="color: #000000">(</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd3</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd2</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'some text'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd2</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">())</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">listdir</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Search for a node by reading the file system
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Search for a node or create it if it does not exist
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Search for a node but do not try to create it
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Search for a file which does not exist
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Write to the file pointed by the node, creating or overwriting the file
</td></tr>
</table></div>
<div class="paragraph"><p>The output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure dosomething</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Setting top to    : /tmp/nodes_search</span>
<span style="color: #000000">Setting out to    : /tmp/nodes_search/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">wscript</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">None</span>
<span style="color: #000000">some text</span>
<span style="color: #000000">['.lock-wafbuild', 'foo.txt', 'build', 'wscript', '.git']</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">More methods may be found in the <a href="http://docs.waf.googlecode.com/git/apidocs_17/index.html">API documentation</a></td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">The Node methods are not meant to be safe for concurrent access. The code executed in parallel (method run() of task objects for example) must avoid modifying the Node object data structure.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">The Node methods read/write must be used to prevent file handle inheritance issues on win32 systems instead of plain open/read/write. Such problems arise when spawning processes during parallel builds.</td>
</tr></table>
</div>
<h4 id="_listing_files_and_folders">5.2.2. Listing files and folders</h4>
<div class="paragraph"><p>The method <strong>ant_glob</strong> is used to list files and folders recursively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'wsc*'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'w?cr?p?'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'usr/include/**/zlib*'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000"> dir</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> src</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">([</span><span style="color: #009900">'**/*py'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'**/*p'</span><span style="color: #000000">],</span><span style="color: #000000"> excl</span><span style="color: #000000">=[</span><span style="color: #009900">'**/default*'</span><span style="color: #000000">]))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The method ant_glob is called on a node object, and not on the build context, it returns only files by default
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Patterns may contain wildcards such as <em>*</em> or <em>?</em>, but they are <a href="http://ant.apache.org/manual/dirtasks.html">Ant patterns</a>, not regular expressions
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The symbol <em>**</em> enable recursion. Complex folder hierarchies may take a lot of time, so use with care.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Even though recursion is enabled, only files are returned by default. To turn directory listing on, use <em>dir=True</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Patterns are either lists of strings or space-delimited values. Patterns to exclude are defined in <em>waflib.Node.exclude_regs</em>.
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to    : /tmp/nodes_ant_glob</span>
<span style="color: #000000">Setting out to    : /tmp/nodes_ant_glob/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/wscript]</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/wscript]</span>
<span style="color: #000000">[/usr/include/zlib.h]</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/build/c4che/build.config.py]</span></tt></pre></div></div>
<div class="paragraph"><p>The sequence <em>..</em> represents exactly two dot characters, and not the parent directory. This is used to guarantee that the search will terminate, and that the same files will not be listed multiple times. Consider the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'../wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Invalid, this pattern will never return anything
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Call <em>ant_glob</em> from the parent directory
</td></tr>
</table></div>
<h4 id="_path_manipulation_abspath_path_from">5.2.3. Path manipulation: abspath, path_from</h4>
<div class="paragraph"><p>The following example illustrates a few ways of obtaining absolute and relative paths:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        dir </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        src </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'out.out'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">.</span><span style="color: #000000">path_from</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">path_from</span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Directory node, source node and build node
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Print the absolute path
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Compute the path relative to another node
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Compute the relative path in reverse order
</td></tr>
</table></div>
<div class="paragraph"><p>Here is the execution trace on a unix-like system:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/nested/build'</span>
<span style="color: #000000">/tmp/nested/wscript</span>
<span style="color: #000000">/tmp/nested/build/out.out</span>
<span style="color: #000000">/tmp/nested/build/</span>
<span style="color: #000000">/tmp/nested</span>
<span style="color: #000000">nested/wscript</span>
<span style="color: #000000">../../../..</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/nested/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<h3 id="_buildcontext_specific_methods">5.3. BuildContext-specific methods</h3><div style="clear:left"></div>
<h4 id="_source_and_build_nodes">5.3.1. Source and build nodes</h4>
<div class="paragraph"><p>Although the <em>sources</em> and <em>targets</em> in the <tt>wscript</tt> files are declared as if they were in the current directory, the target files are output into the build directory. To enable this behaviour, the directory structure below the <em>top</em> directory must be replicated in the <em>out</em> directory. For example, the folder <strong>program</strong> from <tt>demos/c</tt> has its equivalent in the build directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd demos/c</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.h</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- program</span>
<span style="color: #000000">|       |-- main.c.0.o</span>
<span style="color: #000000">|       `-- myprogram</span>
<span style="color: #000000">|-- program</span>
<span style="color: #000000">|   |-- a.h</span>
<span style="color: #000000">|   |-- main.c</span>
<span style="color: #000000">|   `-- wscript_build</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>To support this, the build context provides two additional nodes:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
srcnode: node representing the top-level directory
</p>
</li>
<li>
<p>
bldnode: node representing the build directory
</p>
</li>
</ol></div>
<div class="paragraph"><p>To obtain a build node from a src node and vice-versa, the following methods may be used:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Node.get_src()
</p>
</li>
<li>
<p>
Node.get_bld()
</p>
</li>
</ol></div>
<h4 id="_using_nodes_during_the_build_phase">5.3.2. Using Nodes during the build phase</h4>
<div class="paragraph"><p>Although using <em>srcnode</em> and <em>bldnode</em> directly is possible, the three following wrapper methods are much easier to use. They accept a string representing the target as input and return a single node:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>find_dir</strong>: returns a node or None if the folder cannot be found on the system.
</p>
</li>
<li>
<p>
<strong>find_resource</strong>: returns a node under the source directory, a node under the corresponding build directory, or None if no such a node exists. If the file is not in the build directory, the node signature is computed and put into a cache (file contents hash).
</p>
</li>
<li>
<p>
<strong>find_or_declare</strong>: returns a node or create the corresponding node in the build directory.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Besides, they all use <em>find_dir</em> internally which will create the required directory structure in the build directory. Because the folders may be replicated in the build directory before the build starts, it is recommended to use it whenever possible:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'../src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Not recommended, use <em>find_dir</em> instead
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Path separators are converted automatically according to the platform.
</td></tr>
</table></div>
<h4 id="_nodes_tasks_and_task_generators">5.3.3. Nodes, tasks, and task generators</h4>
<div class="paragraph"><p>As seen in the previous chapter, Task objects can process files represented as lists of input and output nodes. The task generators
will usually process the input files given as strings to obtain such nodes and bind them to the tasks.</p></div>
<div class="paragraph"><p>Because the build directory can be enabled or disabled, the following file copy would be ambiguous: <span class="footnote"><br />[When file copies cannot be avoided, the best practice is to change the file names]<br /></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To actually copy a file into the corresponding build directory with the same name, the ambiguity must be removed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">),</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">().</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In practice, it is easier to use a wrapper that conceals these details (more examples can be found in <tt>demos/subst</tt>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'subst'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> is_copy</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
<h2 id="_advanced_build_definitions">6. Advanced build definitions</h2>
<div class="sectionbody">
<h3 id="_custom_commands">6.1. Custom commands</h3><div style="clear:left"></div>
<h4 id="_context_inheritance">6.1.1. Context inheritance</h4>
<div class="paragraph"><p>An instance of the class <em>waflib.Context.Context</em> is used by default for the custom commands. To provide a custom context object it is necessary to create a context subclass:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">bar</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">one</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">two</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'tak'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'bar'</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
A custom command using the default context
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Bind a context class to the command <em>foo</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a new command named <em>tak</em>, but set it to call the script function <em>bar</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure foo bar tak</span></span>
<span style="color: #000000">Setting top to    : /tmp/advbuild_subclass</span>
<span style="color: #000000">Setting out to    : /tmp/advbuild_subclass/build</span>
<span style="color: #000000">&lt;class 'waflib.Configure.ConfigurationContext'&gt;</span>
<span style="color: #000000">'configure' finished successfully (0.008s)</span>
<span style="color: #000000">&lt;class 'wscript.one'&gt;</span>
<span style="color: #000000">'foo' finished successfully (0.001s)</span>
<span style="color: #000000">&lt;class 'waflib.Context.Context'&gt;</span>
<span style="color: #000000">'bar' finished successfully (0.001s)</span>
<span style="color: #000000">&lt;class 'wscript.two'&gt;</span>
<span style="color: #000000">'tak' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>A typical application of custom context is subclassing the build context to use the configuration data loaded in <strong>ctx.env</strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'some data'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'build command'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">one</span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span>
<span style="color: #000000">        fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span></tt></pre></div></div>
<div class="paragraph"><p>The output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure foo</span></span>
<span style="color: #000000">Setting top to    : /tmp/advbuild_confdata</span>
<span style="color: #000000">Setting out to    : /tmp/advbuild_confdata/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">Waf: Entering directory `/disk/comp/waf/docs/book/examples/advbuild_confdata/build'</span>
<span style="color: #000000">some data</span>
<span style="color: #000000">Waf: Leaving directory `/disk/comp/waf/docs/book/examples/advbuild_confdata/build'</span>
<span style="color: #000000">'foo' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The build commands are using this system: <em>waf install</em> → <em>waflib.Build.InstallContext</em>, <em>waf step</em> → <em>waflib.Build.StepContext</em>, etc</td>
</tr></table>
</div>
<h4 id="_command_composition">6.1.2. Command composition</h4>
<div class="paragraph"><p>To re-use commands that have context object of different base classes, insert them in the <em>command stack</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">cleanbuild</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'clean'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">commands</span></tt></pre></div></div>
<div class="paragraph"><p>This technique is useful for writing testcases. By executing <em>waf test</em>, the following script will configure a project, create source files in the source directory, build a program, modify the sources, and rebuild the program. In this case, the program must be rebuilt because a header (implicit dependency) has changed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">setup</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        n </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'main.c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        n</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'#include "foo.h"\nint main() {return 0;}\n'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> v</span>
<span style="color: #000000">        m </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.h'</span><span style="color: #000000">)</span>
<span style="color: #000000">        m</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'int k = %d;\n'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> v</span><span style="color: #000000">)</span>
<span style="color: #000000">        v </span><span style="color: #000000">+=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">test</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> v </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        v </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">12</span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        lst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'configure'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'setup'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'setup'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">]</span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">=</span><span style="color: #000000"> lst </span><span style="color: #000000">+</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">commands</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
A global variable may be used to share data between commands deriving from different classes
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The test command is used to add more commands
</td></tr>
</table></div>
<div class="paragraph"><p>The following output will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf test</span></span>
<span style="color: #000000">'test' finished successfully (0.000s)</span>
<span style="color: #000000">Setting top to                           : /tmp/advbuild_testcase</span>
<span style="color: #000000">Setting out to                           : /tmp/advbuild_testcase/build</span>
<span style="color: #000000">Checking for 'gcc' (c compiler)          : ok</span>
<span style="color: #000000">'configure' finished successfully (0.092s)</span>
<span style="color: #000000">'setup' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/main.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">'build' finished successfully (0.137s)</span>
<span style="color: #000000">'setup' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/main.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">'build' finished successfully (0.125s)</span></tt></pre></div></div>
<h4 id="_binding_a_command_from_a_waf_tool">6.1.3. Binding a command from a Waf tool</h4>
<div class="paragraph"><p>When the top-level wscript is read, it is converted into a python module and kept in memory. Commands may be added dynamically by injecting the desired function into that module. We will now show how to bind a simple command from a Waf tool:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'some_tool'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="paragraph"><p>Waf tools are loaded once for the configuration and for the build. To ensure that the tool is always enabled, it is mandatory to load its options, even if the tool does not actually provide options. Our tool <em>some_tool.py</em>, located next to the <em>wscript</em> file, will contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">cnt</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #808080">        """do something"""</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'just a test'</span><span style="color: #000000">)</span>

<span style="color: #000000">Context</span><span style="color: #000000">.</span><span style="color: #000000">g_module</span><span style="color: #000000">.</span><span style="color: #000000">__dict__</span><span style="color: #000000">[</span><span style="color: #009900">'cnt'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> cnt </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The function to bind must accept a <tt>Context</tt> object as first argument
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The main wscript file of the project is loaded as a python module and stored as <tt>Context.g_module</tt>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure cnt</span></span>
<span style="color: #000000">Setting top to   : /tmp/examples/advbuild_cmdtool</span>
<span style="color: #000000">Setting out to   : /tmp/advbuild_cmdtool/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">just a test</span>
<span style="color: #000000">'cnt' finished successfully (0.001s)</span></tt></pre></div></div>
<h3 id="_custom_build_outputs">6.2. Custom build outputs</h3><div style="clear:left"></div>
<h4 id="_multiple_configurations_2">6.2.1. Multiple configurations</h4>
<div class="paragraph"><p>The <em>WAFLOCK</em> environment variable is used to control the configuration lock and to point at the default build directory. Observe the results on the following project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>We will change the <em>WAFLOCK</em> variable in the execution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-wafdebug <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_waflock/debug'</span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; debug//foo.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_waflock/debug'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-wafrelease</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.176s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_waflock/release' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; release/foo.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_waflock/release'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- .lock-debug <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">|-- .lock-release</span>
<span style="color: #000000">|-- debug</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foo.txt</span>
<span style="color: #000000">|-- release</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The lock file points at the configuration of the project in use and at the build directory to use
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The files are output in the build directory <tt>debug</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The configuration <em>release</em> is used with a different lock file and a different build directory.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The contents of the project directory contain the two lock files and the two build folders.
</td></tr>
</table></div>
<div class="paragraph"><p>The lock file may also be changed from the code by changing the appropriate variable in the waf scripts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">Options</span><span style="color: #000000">.</span><span style="color: #000000">lockfile </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lock-wafname'</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The output directory pointed at by the waf lock file only has effect when not given in the waf script</td>
</tr></table>
</div>
<h4 id="_changing_the_output_directory">6.2.2. Changing the output directory</h4>
<h5 id="_variant_builds">Variant builds</h5>
<div class="paragraph"><p>In the previous section, two different configurations were used for similar builds. We will now show how to inherit the same configuration by two different builds, and how to output the targets in different folders. Let&#8217;s start with the project file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'debug'</span>
<span style="color: #000000">        variant </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'debug'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The command being called is <em>self.cmd</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create the <em>debug</em> command inheriting the build context
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a folder for targets of the <em>debug</em> command
</td></tr>
</table></div>
<div class="paragraph"><p>This project declares two different builds <em>build</em> and <em>debug</em>. Let&#8217;s examine the execution output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf configure build debug</span>
<span style="color: #000000">Setting top to   : /tmp/advbuild_variant</span>
<span style="color: #000000">Setting out to   : /tmp/advbuild_variant/build</span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_variant/build'</span>
<span style="color: #000000">[1/1] build.txt:  -&gt; build/build.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_variant/build'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_variant/build/debug'</span>
<span style="color: #000000">[1/1] debug.txt:  -&gt; build/debug/debug.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_variant/build/debug'</span>
<span style="color: #000000">'debug' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- build.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- debug</span>
<span style="color: #000000">|       `-- debug.txt <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Commands are executed from <em>build/variant</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The default <em>build</em> command does not have any variant
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The target <em>debug</em> is under the variant directory in the build directory
</td></tr>
</table></div>
<h5 id="_configuration_sets_for_variants">Configuration sets for variants</h5>
<div class="paragraph"><p>The variants may require different configuration sets created during the configuration. Here is an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'release'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">variant</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">'call "waf build_debug" or "waf build_release", and try "waf --help"'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> includes</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span><span style="color: #000000">,</span><span style="color: #000000"> CleanContext</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">\</span>
<span style="color: #000000">        InstallContext</span><span style="color: #000000">,</span><span style="color: #000000"> UninstallContext</span>

<span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'debug release'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> y </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">,</span><span style="color: #000000"> CleanContext</span><span style="color: #000000">,</span><span style="color: #000000"> InstallContext</span><span style="color: #000000">,</span><span style="color: #000000"> UninstallContext</span><span style="color: #000000">):</span>
<span style="color: #000000">                name </span><span style="color: #000000">=</span><span style="color: #000000"> y</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'Context'</span><span style="color: #000000">,</span><span style="color: #009900">''</span><span style="color: #000000">).</span><span style="color: #000000">lower</span><span style="color: #000000">()</span>
<span style="color: #000000">                </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">tmp</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> name </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'_'</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> x</span>
<span style="color: #000000">                        variant </span><span style="color: #000000">=</span><span style="color: #000000"> x</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new configuration set to be returned by <em>conf.env</em>, and stored in <em>c4che/debug_cache.py</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Modify some data in the configuration set
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Make sure a variant is set, this will disable the normal commands <em>build</em>, <em>clean</em> and <em>install</em>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>bld.env</em> will load the configuration set of the appropriate variant (<em>debug_cache.py</em> when in <em>debug</em>)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Create new commands such as <em>clean_debug</em> or <em>install_debug</em> (the class name does not matter)
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean_debug build_debug clean_release build_release</span></span>
<span style="color: #000000">'clean_debug' finished successfully (0.005s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/examples/advbuild_variant_env/build/debug'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/debug/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/debug/main.c.0.o -&gt; build/debug/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/advbuild_variant_env/build/debug'</span>
<span style="color: #000000">'build_debug' finished successfully (0.051s)</span>
<span style="color: #000000">'clean_release' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/examples/advbuild_variant_env/build/release'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/release/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/release/main.c.0.o -&gt; build/release/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/advbuild_variant_env/build/release'</span>
<span style="color: #000000">'build_release' finished successfully (0.052s)</span></tt></pre></div></div>
</div>
<h2 id="_task_processing">7. Task processing</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter provides a description of the task classes which are used during the build phase.</p></div>
<h3 id="_task_execution">7.1. Task execution</h3><div style="clear:left"></div>
<h4 id="_main_actors">7.1.1. Main actors</h4>
<div class="paragraph"><p>The build context is only used to create the tasks and to return lists of tasks that may be executed in parallel. The scheduling is delegated to a task producer which lets task consumers to execute the tasks. The task producer keeps a record of the build state such as the amount of tasks processed or the errors.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_actors.png" alt="Actors processing the tasks" />
</div>
</div>
<div class="paragraph"><p>The amount of consumers is determined from the number of processors, or may be set manually by using the <em>-j</em> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -j3</span></span></tt></pre></div></div>
<h4 id="_build_groups">7.1.2. Build groups</h4>
<div class="paragraph"><p>The task producer iterates over lists of tasks returned by the build context. Although the tasks from a list may be executed in parallel by the consumer threads, all the tasks from one list must be consumed before processing another list of tasks. The build ends when there are no more tasks to process.</p></div>
<div class="paragraph"><p>These lists of tasks are called <em>build groups</em> and may be accessed from the build scripts. Let&#8217;s demonstrate this behaviour on an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Each green task must be executed after one yellow task and each pink task must be executed after one blue task. Because there is only one group by default, the parallel execution will be similar to the following:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_nogroup.png" alt="One build group" />
</div>
</div>
<div class="paragraph"><p>We will now modify the example to add one more build group.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now a separator will appear between the group of yellow and green tasks and the group of blue and violet taks:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_twogroups.png" alt="Two build groups" />
</div>
</div>
<div class="paragraph"><p>The tasks and tasks generator are added implicitely to the current group. By giving a name to the groups, it is easy to control what goes where:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'group1'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'group2'</span><span style="color: #000000">)</span>

<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'group1'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'group2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In the previous examples, all task generators from all build groups are processed before the build
actually starts. This default is provided to ensure that the task count is as accurate as possible.
Here is how to tune the build groups:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> POST_LAZY</span><span style="color: #000000">,</span><span style="color: #000000"> POST_BOTH</span><span style="color: #000000">,</span><span style="color: #000000"> POST_AT_ONCE</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">post_mode </span><span style="color: #000000">=</span><span style="color: #000000"> POST_AT_ONCE </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #808080">#ctx.post_mode = POST_LAZY <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #808080">#ctx.post_mode = POST_BOTH <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
All task generators create their tasks before the build starts (default behaviour)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Groups are processed sequentially: all tasks from previous groups are executed before the task generators from the next group are processed
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Combination of the two previous behaviours: task generators created by tasks in the next groups may create tasks
</td></tr>
</table></div>
<div class="paragraph"><p>Build groups can be used for <a href="#build_compiler_first">building a compiler to generate more source files</a> to process.</p></div>
<h4 id="_the_producer_consumer_system">7.1.3. The Producer-consumer system</h4>
<div class="paragraph"><p>In most python interpreters, a global interpreter lock prevents parallelization by more than one cpu core at a time. Therefore, it makes sense to restrict the task scheduling on a single task producer, and to let the threads access only the task execution.</p></div>
<div class="paragraph"><p>The communication between producer and consumers is based on two queues <em>ready</em> and <em>out</em>. The producer adds the tasks to <em>ready</em> and reads them back from <em>out</em>. The consumers obtain the tasks from <em>ready</em> and give them back to the producer into <em>out</em> after executing <em>task.run</em>.</p></div>
<div class="paragraph"><p>The producer uses the an internal list named <em>outstanding</em> to iterate over the tasks and to decide which ones to put in the queue <em>ready</em>. The tasks that cannot be processed are temporarily output in the list <em>frozen</em> to avoid looping endlessly over the tasks waiting for others.</p></div>
<div class="paragraph"><p>The following illustrates the relationship between the task producers and consumers as performed during the build:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="prodcons.png" alt="Parallel execution" />
</div>
</div>
<h4 id="_task_states_and_status">7.1.4. Task states and status</h4>
<div class="paragraph"><p>A state is assigned to each task (<em>task.hasrun = state</em>) to keep track of the execution. The possible values are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="12%" />
<col width="12%" />
<col width="75%" />
<thead>
<tr>
<th align="left" valign="top">State    </th>
<th align="left" valign="top"> Numeric value </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">NOT_RUN</p></td>
<td align="left" valign="top"><p class="table">0</p></td>
<td align="left" valign="top"><p class="table">The task has not been processed yet</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">MISSING</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">The task outputs are missing</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CRASHED</p></td>
<td align="left" valign="top"><p class="table">2</p></td>
<td align="left" valign="top"><p class="table">The task method <em>run</em> returned a non-0 value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">EXCEPTION</p></td>
<td align="left" valign="top"><p class="table">3</p></td>
<td align="left" valign="top"><p class="table">An exception occured in the Task method <em>run</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SKIPPED</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
<td align="left" valign="top"><p class="table">The task was skipped (it was up-to-date)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SUCCESS</p></td>
<td align="left" valign="top"><p class="table">9</p></td>
<td align="left" valign="top"><p class="table">The execution was successful</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>To decide to execute a task or not, the producer uses the value returned by the task method <em>runnable_status</em>. The possible return values are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="14%" />
<col width="85%" />
<thead>
<tr>
<th align="left" valign="top">Code    </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">ASK_LATER</p></td>
<td align="left" valign="top"><p class="table">The task may depend on other tasks which have not finished to run (not ready)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SKIP_ME</p></td>
<td align="left" valign="top"><p class="table">The task does not have to be executed, it is up-to-date</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RUN_ME</p></td>
<td align="left" valign="top"><p class="table">The task is ready to be executed</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The following diagram represents the interaction between the main task methods and the states and status:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="task_run.png" alt="Task states" />
</div>
</div>
<h3 id="_build_order_constraints">7.2. Build order constraints</h3><div style="clear:left"></div>
<h4 id="_the_method_set_run_after">7.2.1. The method set_run_after</h4>
<div class="paragraph"><p>The method <em>set_run_after</em> is used to declare ordering constraints between tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">task1</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">task2</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The tasks to wait for are stored in the attribute <em>run_after</em>. They are used by the method <em>runnable_status</em> to yield the status <em>ASK_LATER</em> when a task has not run yet. This is merely for the build order and not for forcing a rebuild if one of the previous tasks is executed.</p></div>
<h4 id="_computed_constraints">7.2.2. Computed constraints</h4>
<h5 id="_attribute_after_before">Attribute after/before</h5>
<div class="paragraph"><p>The attributes <em>before</em> and <em>after</em> are used to declare ordering constraints between tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskBase</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    before </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'task_test_b'</span><span style="color: #000000">]</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'task_test_a'</span><span style="color: #000000">]</span></tt></pre></div></div>
<h5 id="_ext_in_ext_out">ext_in/ext_out</h5>
<div class="paragraph"><p>Another way to force the order is by declaring lists of abstract symbols on the class attributes. This way the classes are not named explicitly, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskBase</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The <em>extensions</em> ext_in and ext_out do not mean that the tasks have to produce files with such extensions, but are mere symbols for use as precedence constraints.</p></div>
<h5 id="_order_extraction">Order extraction</h5>
<div class="paragraph"><p>Before feeding the tasks to the producer-consumer system, a constraint extraction is performed on the tasks having input and output files. The attributes <em>run_after</em> are initialized with the tasks to wait for.</p></div>
<div class="paragraph"><p>The two functions called on lists of tasks are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>waflib.Task.set_precedence_constraints</em>: extract the build order from the task classes attributes ext_in/ext_out/before/after
</p>
</li>
<li>
<p>
<em>waflib.Task.set_file_constraints</em>: extract the constraints from the tasks having input and output files
</p>
</li>
</ol></div>
<h4 id="_weak_order_constraints">7.2.3. Weak order constraints</h4>
<div class="paragraph"><p>Tasks that are known to take a lot of time may be launched first to improve the build times. The general problem of finding an optimal order for launching tasks in parallel and with constraints is called <a href="http://en.wikipedia.org/wiki/Job-shop_problem">Job Shop</a>. In practice this problem can often be reduced to a critical path problem (approximation).</p></div>
<div class="paragraph"><p>The following pictures illustrate the difference in scheduling a build with different independent tasks, in which a slow task is clearly identified, and launched first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">5</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'sleep 1'</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'short task'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'sleep 5'</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'RED'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'long task'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_nosort.png" alt="No particular order" />
</div>
</div>
<div class="paragraph"><p>A function is used to reorder the tasks from a group before they are passed to the producer. We will replace it to reorder the long task in first position:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">old </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">set_file_constraints</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">meth</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">):</span>
<span style="color: #000000">    lst</span><span style="color: #000000">.</span><span style="color: #000000">sort</span><span style="color: #000000">(</span><span style="color: #000000">cmp</span><span style="color: #000000">=</span><span style="color: #000080">lambda</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> y</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">cmp</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">,</span><span style="color: #000000"> y</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    </span><span style="color: #000000">old</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">set_file_constraints </span><span style="color: #000000">=</span><span style="color: #000000"> meth </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Set the long task in first position
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Execute the original code
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Replace the method
</td></tr>
</table></div>
<div class="paragraph"><p>Here is a representation of the effect:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_sort.png" alt="Slowest task first" />
</div>
</div>
<h3 id="_dependencies">7.3. Dependencies</h3><div style="clear:left"></div>
<h4 id="_task_signatures">7.3.1. Task signatures</h4>
<div class="paragraph"><p>The direct instances of <em>waflib.Task.TaskBase</em> are very limited and cannot be used to track file changes. The subclass <em>waflib.Task.Task</em> provides the necessary features for the most common builds in which source files are used to produce target files.</p></div>
<div class="paragraph"><p>The dependency tracking is based on the use of hashes of the dependencies called <strong>task signatures</strong>. The signature is computed from various dependencies source, such as input files and configuration set values.</p></div>
<div class="paragraph"><p>The following diagram describes how <em>waflib.Task.Task</em> instances are processed:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="task_signature.png" alt="Signatures" />
</div>
</div>
<div class="paragraph"><p>The following data is used in the signature computation:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Explicit dependencies: <em>input nodes</em> and dependencies set explicitly by using <em>bld.depends_on</em>
</p>
</li>
<li>
<p>
Implicit dependencies: dependencies searched by a scanner method (the method <em>scan</em>)
</p>
</li>
<li>
<p>
Values: configuration set values such as compilation flags
</p>
</li>
</ol></div>
<h4 id="_explicit_dependencies">7.3.2. Explicit dependencies</h4>
<h5 id="_input_and_output_nodes">Input and output nodes</h5>
<div class="paragraph"><p>The task objects do not directly depend on other tasks. Other tasks may exist or not, and be executed or nodes. Rather, the input and output nodes hold themselves signatures values, which come from different sources:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Nodes for build files usually inherit the signature of the task that generated the file
</p>
</li>
<li>
<p>
Nodes from elsewhere have a signature computed automatically from the file contents (hash)
</p>
</li>
</ol></div>
<h5 id="_global_dependencies_on_other_nodes">Global dependencies on other nodes</h5>
<div class="paragraph"><p>The tasks may be informed that some files may depend on other files transitively without listing them in the inputs. This is achieved by the method <em>add_manual_dependency</em> from the build context:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'somecopy'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_manual_dependency</span><span style="color: #000000">(</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">),</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'testfile'</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The file <em>somecopy</em> will be rebuilt whenever <em>wscript</em> or <em>testfile</em> change, even by one character:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">[1/1] somecopy: wscript -&gt; build/somecopy</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; testfile</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">[1/1] somecopy: wscript -&gt; build/somecopy</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<h4 id="_implicit_dependencies_scanner_methods">7.3.3. Implicit dependencies (scanner methods)</h4>
<div class="paragraph"><p>Some tasks can be created dynamically after the build has started, so the dependencies cannot be known in advance. Task subclasses can provide a method named <em>scan</em> to obtain additional nodes implicitly. In the following example, the <em>copy</em> task provides a scanner method to depend on the wscript file found next to the input file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> time</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()))</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ calling the scanner method'</span><span style="color: #000000">)</span>
<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">([</span><span style="color: #000000">node</span><span style="color: #000000">],</span><span style="color: #000000"> time</span><span style="color: #000000">.</span><span style="color: #000000">time</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        ret </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">super</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">).</span><span style="color: #000000">runnable_status</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'nodes:       %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">node_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'custom data: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> ret</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'a.in'</span><span style="color: #000000">))</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
A scanner method
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The return value is a tuple containing a list of nodes to depend on and serializable data for custom uses
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Override the method runnable_status to add some logging
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Obtain a reference to the build context associated to this task
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The nodes returned by the scanner method are stored in the map <strong>bld.node_deps</strong>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The custom data returned by the scanner method is stored in the map <strong>bld.raw_deps</strong>
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Create a task manually (encapsulation by task generators will be described in the next chapters)
</td></tr>
</table></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ calling the scanner method <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 55.51</span>
<span style="color: #000000">[1/1] copy: a.in -&gt; build/b.out</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 1280561555.512006</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/3.png" alt="3" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ calling the scanner method</span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 64.31</span>
<span style="color: #000000">[1/1] copy: a.in -&gt; build/b.out</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The scanner method is always called on a clean build
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The scanner method is not called when nothing has changed, although the data returned is retrieved
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
When a dependency changes, the scanner method is executed once again (the custom data has changed)
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">If the build order is incorrect, the method <em>scan</em> may fail to find dependent nodes (missing nodes) or the signature calculation may throw an exception (missing signature for dependent nodes).</td>
</tr></table>
</div>
<h4 id="_values">7.3.4. Values</h4>
<div class="paragraph"><p>The habitual use of command-line parameters such as compilation flags lead to the creation of <em>dependencies on values</em>, and more specifically the configuration set values. The Task class attribute <em>vars</em> is used to control what values can enter in the signature calculation. In the following example, the task created has no inputs and no outputs nodes, and only depends on the values.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        vars </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'FLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'the flags are %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FLAGS</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--flags'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #009900">'-f'</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">=</span><span style="color: #009900">'flags'</span><span style="color: #000000">,</span><span style="color: #000000"> type</span><span style="color: #000000">=</span><span style="color: #009900">'string'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">flags </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a task class named <em>foo</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The task instances will be executed whenever <em>self.env.FLAGS</em> changes
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Print the value for debugging purposes
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Read the value from the command-line
</td></tr>
</table></div>
<div class="paragraph"><p>The execution will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --flags abcdef</span></span>
<span style="color: #000000">[1/1] foo:</span>
<span style="color: #000000">the flags are 'abcdef' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --flags abcdef <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --flags abc</span></span>
<span style="color: #000000">[1/1] foo: <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">the flags are 'abc'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The task is executed on the first run
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The dependencies have not changed, so the task is not executed
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The flags have changed so the task is executed
</td></tr>
</table></div>
<h3 id="_task_tuning">7.4. Task tuning</h3><div style="clear:left"></div>
<h4 id="_class_access">7.4.1. Class access</h4>
<div class="paragraph"><p>When a task provides an attribute named <em>run_str</em> as in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COPY      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/bin/cp'</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COPYFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-f'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">        </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">                run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${COPY} ${COPYFLAGS} ${SRC} ${TGT}'</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">.</span><span style="color: #000000">vars</span><span style="color: #000000">)</span>

<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>It is assumed that <em>run_str</em> represents a command-line, and that the variables in <em>${}</em> such as <em>COPYFLAGS</em> represent variables to add to the dependencies. A metaclass processes <em>run_str</em> to obtain the method <em>run</em> (called to execute the task) and the variables in the attribute <em>vars</em> (merged with existing variables). The function created is displayed in the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action</span></span>
<span style="color: #000000">13:36:49 action   def f(tsk):</span>
<span style="color: #000000">        env = tsk.env</span>
<span style="color: #000000">        gen = tsk.generator</span>
<span style="color: #000000">        bld = gen.bld</span>
<span style="color: #000000">        wd = getattr(tsk, 'cwd', None)</span>
<span style="color: #000000">        def to_list(xx):</span>
<span style="color: #000000">                if isinstance(xx, str): return [xx]</span>
<span style="color: #000000">                return xx</span>
<span style="color: #000000">        lst = []</span>
<span style="color: #000000">        lst.extend(to_list(env['COPY']))</span>
<span style="color: #000000">        lst.extend(to_list(env['COPYFLAGS']))</span>
<span style="color: #000000">        lst.extend([a.path_from(bld.bldnode) for a in tsk.inputs])</span>
<span style="color: #000000">        lst.extend([a.path_from(bld.bldnode) for a in tsk.outputs])</span>
<span style="color: #000000">        lst = [x for x in lst if x]</span>
<span style="color: #000000">        return tsk.exec_command(lst, cwd=wd, env=env.env or None)</span>
<span style="color: #000000">[1/1] copy: wscript -&gt; build/b.out</span>
<span style="color: #000000">['COPY', 'COPYFLAGS']</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span></tt></pre></div></div>
<div class="paragraph"><p>All subclasses of <em>waflib.Task.TaskBase</em> are stored on the module attribute <em>waflib.Task.classes</em>. Therefore, the <em>copy</em> task can be accessed by using:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #009900">'copy'</span><span style="color: #000000">]</span></tt></pre></div></div>
<h4 id="_scriptlet_expressions">7.4.2. Scriptlet expressions</h4>
<div class="paragraph"><p>Although the <em>run_str</em> is aimed at configuration set variables, a few special cases are provided for convenience:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
If the value starts by <strong>env</strong>, <strong>gen</strong>, <strong>bld</strong> or <strong>tsk</strong>, a method call will be made
</p>
</li>
<li>
<p>
If the value starts by SRC[n] or TGT[n], a method call to the input/output node <em>n</em> will be made
</p>
</li>
<li>
<p>
SRC represents the list of task inputs seen from the root of the build directory
</p>
</li>
<li>
<p>
TGT represents the list of task outputs seen from the root of the build directory
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here are a few examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">SRC</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">CPPPATH_ST</span><span style="color: #000000">:</span><span style="color: #000000">INCPATHS</span><span style="color: #000000">}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Absolute path of the parent folder of the task first source file
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
File system root
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Print the task unique identifier
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Perform a map replacement equivalent to <em>[env.CPPPATH_ST % x for x in env.INCPATHS]</em>
</td></tr>
</table></div>
<h4 id="_direct_class_modifications">7.4.3. Direct class modifications</h4>
<h5 id="_always_execute">Always execute</h5>
<div class="paragraph"><p>The function <em>waflib.Task.always_run</em> is used to force a task to be executed whenever a build is performed. It sets a method <em>runnable_status</em> that always return <em>RUN_ME</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">    </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span>
<span style="color: #000000">    copy </span><span style="color: #000000">=</span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">always_run</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">)</span>

<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>For convenience, rule-based task generators can declare the <strong>always</strong> attribute to achieve the same results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo hello'</span><span style="color: #000000">,</span>
<span style="color: #000000">        always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
<h5 id="_file_hashes_and_dependencies">File hashes and dependencies</h5>
<div class="paragraph"><p>Nodes created by tasks during the build inherit the signature of the task that created them.
Tasks consuming such nodes as inputs will be executed whenever the first tasks are executed.
This is usually a desirable behaviour, as the tasks will propagate the dependencies in a transitive manner.</p></div>
<div class="paragraph"><p>In a few contexts though, there can be an excess of downstream rebuilds even if the output files content have not changed.
This will also cause build files in the source directory to be rebuild whenever a new build is initiated (files in the source directory are hashed).
The function <em>waflib.Task.update_outputs</em> is used to enable file hashes in task classes, it is used in the same way as <em>waflib.Task.always_run</em>.</p></div>
<div class="paragraph"><p>For convenience, rule-based task generators can provide the <strong>update_outputs</strong> attribute to simplify the declaration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule           </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target         </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript2'</span><span style="color: #000000">),</span>
<span style="color: #000000">        update_outputs </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule           </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source         </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript2'</span><span style="color: #000000">),</span>
<span style="color: #000000">        target         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript3'</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, the file <strong>wscript2</strong> is created in the source directory.
The <strong>update_outputs</strong> keyword is therefore necessary to prevent unnecessary rebuilds.
Additionally, <strong>wscript3</strong> is rebuilt only when the contents of <strong>wscript2</strong> change.</p></div>
</div>
<h2 id="_task_generators">8. Task generators</h2>
<div class="sectionbody">
<h3 id="_rule_based_task_generators_make_like">8.1. Rule-based task generators (Make-like)</h3><div style="clear:left"></div>
<div class="paragraph"><p>This chapter illustrates the use of rule-based task generators for building simple targets.</p></div>
<h4 id="_declaration_and_usage">8.1.1. Declaration and usage</h4>
<div class="paragraph"><p>Rule-based task generators are a particular category of task generators producing exactly one task.</p></div>
<div class="paragraph"><p>The following example shows a task generator producing the file <em>foobar.txt</em> from the project file <em>wscript</em> by executing the command <em>cp</em> to perform a copy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
To instantiate a new task generator, remember that all arguments have the form <em>key=value</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The attribute <em>rule</em> represents the command to execute in a readable manner (more on this in the next chapters).
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Source files, either in a space-delimited string, or in a list of python strings
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Target files, either in a space-delimited string, or in a list of python strings
</td></tr>
</table></div>
<div class="paragraph"><p>Upon execution, the following output will be observed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript -&gt; build/foobar.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">10:57:33 runner 'cp ../wscript foobar.txt' <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foobar.txt</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf <img src="./callouts/3.png" alt="3" /></span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript → build/foobar.txt <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.013s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
In the first execution, the target is correctly created
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Command-lines are only displayed in <em>verbose mode</em> by using the option <em>-v</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The target is up-to-date, so the task is not executed
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Modify the source file in place by appending a space character
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Since the source has changed, the target is created once again
</td></tr>
</table></div>
<div class="paragraph"><p>The string for the rule also enters in the dependency calculation. If the rule changes, then the task will be recompiled.</p></div>
<h4 id="_rule_functions">8.1.2. Rule functions</h4>
<div class="paragraph"><p>Rules may be given as expression strings or as python function. The function is assigned to the task class created:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                src </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                tgt </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">,</span><span style="color: #000000"> tgt</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> run</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'same.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Rule functions take the task instance as parameter.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Sources and targets are represented internally as Node objects bound to the task instance.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Commands are executed from the root of the build directory. Node methods such as <em>bldpath</em> ease the command line creation.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The task class holds a wrapper around subprocess.Popen(&#8230;) to execute commands.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Use a function instead of a string expression
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule_function/out'</span>
<span style="color: #000000">[1/1] same.txt: wscript -&gt; out/same.txt</span>
<span style="color: #000000">cp /tmp/rule_function/wscript /tmp/rule_function/build/same.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule_function/out'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span></tt></pre></div></div>
<div class="paragraph"><p>The rule function must return a null value (0, None or False) to indicate success, and must generate the files corresponding to the outputs. The rule function is executed by threads internally so it is important to write thread-safe code (cannot search or create node objects).</p></div>
<div class="paragraph"><p>Unlike string expressions, functions may execute several commands at once.</p></div>
<h4 id="_shell_usage">8.1.3. Shell usage</h4>
<div class="paragraph"><p>The attribute <em>shell</em> is used to enable the system shell for command execution. A few points are worth keeping in mind when declaring rule-based task generators:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The Waf tools do not use the shell for executing commands
</p>
</li>
<li>
<p>
The shell is used by default for user commands and custom task generators
</p>
</li>
<li>
<p>
String expressions containing the following symbols &#8216;&gt;&#8217;, &#8216;&lt;&#8217; or &#8216;&amp;&#8217; cannot be transformed into functions to execute commands without a shell, even if told to
</p>
</li>
<li>
<p>
In general, it is better to avoid the shell whenever possible to avoid quoting problems (paths having blank characters in the name for example)
</p>
</li>
<li>
<p>
The shell is creating a performance penalty which is more visible on win32 systems.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f2.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Upon execution, the results will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=runner,action</span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">23:11:23 action <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        def to_list(xx):</span>
<span style="color: #000000">                if isinstance(xx, str): return [xx]</span>
<span style="color: #000000">                return xx</span>
<span style="color: #000000">        lst = []</span>
<span style="color: #000000">        lst.extend(['cp'])</span>
<span style="color: #000000">        lst.extend([a.srcpath(env) for a in task.inputs])</span>
<span style="color: #000000">        lst.extend([a.bldpath(env) for a in task.outputs])</span>
<span style="color: #000000">        lst = [x for x in lst if x]</span>
<span style="color: #000000">        return task.exec_command(lst, cwd=wd)</span>

<span style="color: #000000">23:11:23 action</span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        p = env.get_flat</span>
<span style="color: #000000">        cmd = ''' cp %s %s ''' % (" ".join([a.srcpath(env) for a in task.inputs]), <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                " ".join([a.bldpath(env) for a in task.outputs]))</span>
<span style="color: #000000">        return task.exec_command(cmd, cwd=wd)</span>

<span style="color: #000000">[1/2] f1.txt: wscript -&gt; out/f1.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt; ['cp', '../wscript', 'f1.txt'] <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[2/2] f2.txt: wscript -&gt; out/f2.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt;  cp ../wscript f2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.017s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
String expressions are converted to functions (here, without the shell).
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Command execution by the shell. Notice the heavy use of string concatenation.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Commands to execute are displayed by calling <em>waf --zones=runner</em>. When called without the shell, the arguments are displayed as a list.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">For performance and maintainability, try avoiding the shell whenever possible</td>
</tr></table>
</div>
<h4 id="_inputs_and_outputs">8.1.4. Inputs and outputs</h4>
<div class="paragraph"><p>Source and target arguments are optional for make-like task generators, and may point at one or several files at once. Here are a few examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; cp ${SRC} ${TGT[1].abspath()}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'f1.txt f2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                shell  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo ${SRC}'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.k3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo "test" &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo 1337'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"echo 'task always run'"</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Generate <em>two files</em> whenever the input or the rule change. Likewise, a rule-based task generator may have multiple input files.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The command is executed whenever the input or the rule change. There are no declared outputs.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
No input, the command is executed whenever it changes
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
No input and no output, the command is executed only when the string expression changes
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
No input and no output, the command is executed each time the build is called
</td></tr>
</table></div>
<div class="paragraph"><p>For the record, here is the output of the build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.093s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/5] echo 1337:</span>
<span style="color: #000000">1337</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">[3/5] echo ${SRC}: wscript</span>
<span style="color: #000000">../wscript</span>
<span style="color: #000000">[4/5] f1.txt f2.txt: wscript -&gt; out/f1.txt out/f2.txt</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">[5/5] test.k3:  -&gt; out/test.k3</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.049s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<h4 id="_dependencies_on_file_contents">8.1.5. Dependencies on file contents</h4>
<div class="paragraph"><p>As a second example, we will create a file named <em>r1.txt</em> from the current date. It will be updated each time the build is executed. A second file named <em>r2.txt</em> will be created from <em>r1.txt</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Give the task generator a name, it will create a task class of the same name to execute the command
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create <em>r1.txt</em> with the date
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
There is no source file to depend on and the rule never changes. The task is then set to be executed each time the build is started by using the attribute <em>always</em>
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
If no name is provided, the rule is used as a name for the task class
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Use <em>r1.txt</em> as a source for <em>r2.txt</em>. Since <em>r1.txt</em> was declared before, the dependency will be added automatically (<em>r2.txt</em> will be re-created whenever <em>r1.txt</em> changes)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Set the command generating <em>r2.txt</em> to be executed after the command generating <em>r1.txt</em>. The attribute <em>after</em> references task class names, not task generators. Here it will work because rule-based task generator tasks inherit the <em>name</em> attribute
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:39 CET 2010</span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:44:41 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:41 CET 2010</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span></tt></pre></div></div>
<div class="paragraph"><p>Although r2 <strong>depends</strong> on <em>r1.txt</em>, r2 was not executed in the second build. As a matter of fact, the signature of the task r1 has not changed, and r1 was only set to be executed each time, regardless of its signature. Since the signature of the <em>r1.txt</em> does not change, the signature of r2 will not change either, and <em>r2.txt</em> is considered up-to-date.</p></div>
<div class="paragraph"><p>We will now illustrate how to make certain that the outputs reflect the file contents and trigger the rebuild for dependent tasks by enabling the attribute <em>on_results</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                on_results </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Here <em>r2.txt</em> will be re-created each time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:53 CET 2010 <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Start with a clean build, both <em>r1.txt</em> and <em>r2.txt</em> are created
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Notice the date and time
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The second build was executed at the same date and time, so <em>r1.txt</em> has not changed, therefore <em>r2.txt</em> is up to date
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The third build is executed at another date and time. Since <em>r1.txt</em> has changed, <em>r2.txt</em> is created once again
</td></tr>
</table></div>
<h3 id="_name_and_extension_based_file_processing">8.2. Name and extension-based file processing</h3><div style="clear:left"></div>
<div class="paragraph"><p>Transformations may be performed automatically based on the file name or on the extension.</p></div>
<h4 id="_refactoring_repeated_rule_based_task_generators_into_implicit_rules">8.2.1. Refactoring repeated rule-based task generators into implicit rules</h4>
<div class="paragraph"><p>The explicit rules described in the previous chapter become limited for processing several files of the same kind. The following code may lead to unmaintainable scripts and to slow builds (for loop):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> x</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #000000">x</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">)</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Rather, the rule should be removed from the user script, like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The equivalent logic may then be provided by using the following code. It may be located in either the same <em>wscript</em>, or in a waf tool:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        rule         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        shell        </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ext_out      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        reentrant    </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        install_path </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The name for the corresponding task class to use
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The rule is the same as for any rule-based task generator
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Input file, processed by extension
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Output files extensions separated by spaces. In this case there is only one output file
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The reentrant attribute is used to add the output files as source again, for processing by another implicit rule
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
String representing the installation path for the output files, similar to the destination path from <em>bld.install_files</em>. To disable installation, set it to False.
</td></tr>
</table></div>
<h4 id="_chaining_more_than_one_command">8.2.2. Chaining more than one command</h4>
<div class="paragraph"><p>Now consider the long chain <em>uh.in</em> → <em>uh.a</em> → <em>uh.b</em> → <em>uh.c</em>. The following implicit rules demonstrate how to generate the files while maintaining a minimal user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'a'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'b'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.c'</span><span style="color: #000000">,</span><span style="color: #000000"> reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>During the build phase, the correct compilation order is computed based on the extensions given:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.090s)</span>
<span style="color: #000000">Waf: Entering directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">[1/3] a: uh.in -&gt; build/uh.a</span>
<span style="color: #000000">[2/3] b: build/uh.a -&gt; build/uh.b</span>
<span style="color: #000000">[3/3] c: build/uh.b -&gt; build/uh.c</span>
<span style="color: #000000">Waf: Leaving directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span></tt></pre></div></div>
<h4 id="_scanner_methods">8.2.3. Scanner methods</h4>
<div class="paragraph"><p>Because transformation chains rely on implicit transformations, it may be desirable to hide some files from the list of sources. Or, some dependencies may be produced conditionally and may not be known in advance. A <em>scanner method</em> is a kind of callback used to find additional dependencies just before the target is generated. For illustration purposes, let us start with an empty project containing three files: the <em>wscript</em>, <em>ch.in</em> and <em>ch.dep</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- ch.dep</span>
<span style="color: #000000">|-- ch.in</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The build will create a copy of <em>ch.in</em> called <em>ch.out</em>. Also, <em>ch.out</em> must be rebuild whenever <em>ch.dep</em> changes. This corresponds more or less to the following Makefile:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">ch.out:</span><span style="color: #000000"> ch.in ch.dep</span>
<span style="color: #000000">        cp ch.in ch.out</span></tt></pre></div></div>
<div class="paragraph"><p>The user script should only contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'ch.in'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The code below is independent from the user scripts and may be located in a Waf tool.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan_meth</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">        dep </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">name</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.dep'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> dep</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">raise</span><span style="color: #000000"> </span><span style="color: #000000">ValueError</span><span style="color: #000000">(</span><span style="color: #009900">"Could not find the .dep file for %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">([</span><span style="color: #000000">dep</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'copy'</span><span style="color: #000000">,</span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        scan      </span><span style="color: #000000">=</span><span style="color: #000000"> scan_meth</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The scanner method accepts a task object as input (not a task generator)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use node methods to locate the dependency (and raise an error if it cannot be found)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Scanner methods return a tuple containing two lists. The first list contains the list of node objects to depend on. The second list contains private data such as debugging information. The results are cached between build calls so the contents must be serializable.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Add the scanner method to chain declaration
</td></tr>
</table></div>
<div class="paragraph"><p>The execution trace will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.in</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.dep <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; build/ch.out <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.005s) <img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ echo 2 &gt; ch.dep <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; build/ch.out <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Initialize the file contents of <em>ch.in</em> and <em>ch.dep</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Execute a first clean build. The file <em>ch.out</em> is produced
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The target <em>ch.out</em> is up-to-date because nothing has changed
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Change the contents of <em>ch.dep</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The dependency has changed, so the target is rebuilt
</td></tr>
</table></div>
<div class="paragraph"><p>Here are a few important points about scanner methods:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
they are executed only when the target is not up-to-date.
</p>
</li>
<li>
<p>
they may not modify the <em>task</em> object or the contents of the configuration set <em>task.env</em>
</p>
</li>
<li>
<p>
they are executed in a single main thread to avoid concurrency issues
</p>
</li>
<li>
<p>
the results of the scanner (tuple of two lists) are re-used between build executions (and it is possible to access programatically those results)
</p>
</li>
<li>
<p>
the make-like rules also accept a <em>scan</em> argument (scanner methods are bound to the task rather than the task generators)
</p>
</li>
<li>
<p>
they are used by Waf internally for c/c++ support, to add dependencies dynamically on the header files (<em>.c</em> → <em>.h</em>)
</p>
</li>
</ol></div>
<h4 id="_extension_callbacks">8.2.4. Extension callbacks</h4>
<div class="paragraph"><p>In the chain declaration from the previous sections, the attribute <em>reentrant</em> was described to control if the generated files are to be processed or not. There are cases however where one of the two generated files must be declared (because it will be used as a dependency) but where it cannot be considered as a source file in itself (like a header in c/c\++). Now consider the following two chains (<em>uh.in</em> → <em>uh.a1</em> + <em>uh.a2</em>) and (<em>uh.a1</em> → <em>uh.b</em>) in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a'</span><span style="color: #000000">,</span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.a2'</span><span style="color: #000000">],</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span>

<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The following error message will be produced:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject'</span>
<span style="color: #000000">Cannot guess how to process bld:///tmp/smallproject/uh.a2 (got mappings ['.a1', '.in'] in</span>
<span style="color: #000000">   class TaskGen.task_gen) -&gt; try conf.load(..)?</span></tt></pre></div></div>
<div class="paragraph"><p>The error message indicates that there is no way to process <em>uh.a2</em>. Only files of extension <em>.a1</em> or <em>.in</em> can be processed. Internally, extension names are bound to callback methods. The error is raised because no such method could be found, and here is how to register an extension callback globally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.a2'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="paragraph"><p>To register an extension callback locally, a reference to the task generator object must be kept:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">callback</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">pass</span>
<span style="color: #000000">        obj</span><span style="color: #000000">.</span><span style="color: #000000">mappings</span><span style="color: #000000">[</span><span style="color: #009900">'.a2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> callback</span></tt></pre></div></div>
<div class="paragraph"><p>The exact method signature and typical usage for the extension callbacks is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">".a"</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">".b"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">my_callback</span><span style="color: #000000">(</span><span style="color: #000000">task_gen_object</span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000">):</span>
<span style="color: #000000">        task_gen_object</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span>
<span style="color: #000000">                task_name</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                node</span><span style="color: #000000">,</span><span style="color: #000000">  </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                output_nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Comma-separated list of extensions (strings)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task generator instance holding the data
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Instance of Node, representing a file (either source or build)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The first argument to create a task is the name of the task class
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The second argument is the input node (or a list of nodes for several inputs)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The last parameter is the output node (or a list of nodes for several outputs)
</td></tr>
</table></div>
<div class="paragraph"><p>The creation of new task classes will be described in the next section.</p></div>
<h4 id="_task_class_declaration">8.2.5. Task class declaration</h4>
<div class="paragraph"><p>Waf tasks are instances of the class Task.TaskBase. Yet, the base class contains the real minimum, and the immediate subclass <em>Task.Task</em> is usually chosen in user scripts. We will now start over with a simple project containing only one project <em>wscript</em> file and and example file named <em>ah.in</em>. A task class will be added.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'abcd'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">abcd</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'executing...'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new instance of <em>abcd</em>. The method <em>create_task</em> is a shortcut to make certain the task will keep a reference on its task generator.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Inherit the class Task located in the module Task.py
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The method run is called when the task is executed
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The task return status must be an integer, which is zero to indicate success. The tasks that have failed will be executed on subsequent builds
</td></tr>
</table></div>
<div class="paragraph"><p>The output of the build execution will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">&lt;class 'wscript_main.abcd'&gt;</span>
<span style="color: #000000">[1/1] abcd:</span>
<span style="color: #000000">executing...</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="paragraph"><p>Although it is possible to write down task classes in plain python, two functions (factories) are provided to simplify the work, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'xsubpp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        rule    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${PERL} ${XSUBPP} ${SRC} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        before  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build_it</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span>

<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">task_type_from_func</span><span style="color: #000000">(</span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'sometask'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        func    </span><span style="color: #000000">=</span><span style="color: #000000"> build_it</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">        vars    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'SRT'</span><span style="color: #000000">],</span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'RED'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a new task class executing a rule string
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Task class name
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Rule to execute during the build
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Color for the output during the execution
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Execute the task instance before any instance of task classes named <em>cc</em>. The opposite of <em>before</em> is <em>after</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Create a new task class from a custom python function. The <em>vars</em> attribute represents additional configuration set values to use as dependencies
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Task class name
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Function to use
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
In this context, the extension names are meant to be used for computing the execution order with other tasks, without naming the other task classes explicitly
</td></tr>
</table></div>
<div class="paragraph"><p>Note that most attributes are common between the two function factories. More usage examples may be found in most Waf tools.</p></div>
<h4 id="_source_attribute_processing">8.2.6. Source attribute processing</h4>
<div class="paragraph"><p>The first step in processing the source file attribute is to convert all file names into Nodes. Special methods may be mapped to intercept names by the exact file name entry (no extension). The Node objects are then added to the task generator attribute <em>source</em>.</p></div>
<div class="paragraph"><p>The list of nodes is then consumed by regular extension mappings. Extension methods may re-inject the output nodes for further processing by appending them to the the attribute <em>source</em> (hence the name re-entrant provided in declare_chain).</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="source.png" alt="Source attribute processing" />
</div>
</div>
<h3 id="_general_purpose_task_generators">8.3. General purpose task generators</h3><div style="clear:left"></div>
<div class="paragraph"><p>So far, various task generators uses have been demonstrated. This chapter provides a detailed description of task generator structure and usage.</p></div>
<h4 id="_task_generator_definition">8.3.1. Task generator definition</h4>
<div class="paragraph"><p>The chapter on make-like rules illustrated how the attribute <em>rule</em> is processed. Then the chapter on name and extension-based file processing illustrated how the attribute <em>source</em> is processed (in the absence of the rule attribute). To process <em>any attribute</em>, the following properties should hold:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Attributes should be processed only when the task generator is set to generate the tasks (lazy processing)
</p>
</li>
<li>
<p>
There is no list of authorized attributes (task generators may be extended by user scripts)
</p>
</li>
<li>
<p>
Attribute processing should be controlable on a task generator instance basis (special rules for particular task generators)
</p>
</li>
<li>
<p>
The extensions should be split into independent files (low coupling between the Waf tools)
</p>
</li>
</ol></div>
<div class="paragraph"><p>Implementing such a system is a difficult problem which lead to the creation of very different designs:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>A hierarchy of task generator subclasses</em> It was abandoned due to the high coupling between the Waf tools: the C tools required knowledge from the D tool for building hybrid applications
</p>
</li>
<li>
<p>
<em>Method decoration (creating linked lists of method calls)</em> Replacing or disabling a method safely was no longer possible (addition-only), so this system disappeared quickly
</p>
</li>
<li>
<p>
<em>Flat method and execution constraint declaration</em> The concept is close to aspect-oriented programming and might scare programmers.
</p>
</li>
</ol></div>
<div class="paragraph"><p>So far, the third design proved to be the most flexible and was kept. Here is how to define a task generator method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        v </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myattr </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myMethod</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen_method </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">myMethod</span><span style="color: #000000">(</span><span style="color: #000000">tgen</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Attributes may be set by arguments or by accessing the object. It is set two times in this example.
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Call the task generator method explicitly
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Use a python decorator
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Task generator methods have a unique argument representing the current instance
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Process the attribute <em>myattr</em> when present (the case in the example)
</td></tr>
</table></div>
<div class="paragraph"><p>The output from the build will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">hello world</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The method could be bound by using <em>setattr</em> directly, like for binding any new method on a python class.</td>
</tr></table>
</div>
<h4 id="_executing_the_method_during_the_build">8.3.2. Executing the method during the build</h4>
<div class="paragraph"><p>So far, the task generator methods defined are only executed through explicit calls. Another decorator is necessary to have a task generator executed during the build phase automatically. Here is the updated example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen_method </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">methodName</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Bind a method to the task generator class (redundant when other methods such as <em>TaskGen.feature</em> are used)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Bind the method to the symbol <em>myfeature</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">23:03:44 task_gen posting &gt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 139657958706768 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; exec_rule (139657958706768) <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; process_source (139657958706768) <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; methodName (139657958706768) <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Hello, world!</span>
<span style="color: #000000">23:03:44 task_gen posted <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The debugging zone <em>task_gen</em> is used to display the task generator methods being executed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Display which task generator is being executed
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The method <em>exec_rule</em> is used to process the <em>rule</em>. It is always executed.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
The method <em>process_source</em> is used to process the <em>source</em> attribute. It is always executed exept if the method <em>exec_rule</em> processes a <em>rule</em> attribute
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Our task generator method is executed, and prints <em>Hello, world!</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
The task generator methods have been executed, the task generator is marked as done (posted)
</td></tr>
</table></div>
<h4 id="_task_generator_features">8.3.3. Task generator features</h4>
<div class="paragraph"><p>So far, the task generator methods we added were declared to be executed by all task generator instances. Limiting the execution to specific task generators requires the use of the <em>feature</em> decorator:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping pong'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pong</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237584</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; process_source (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237584)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237776</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; process_source (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; pong (140631018237776)</span>
<span style="color: #000000">pong</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237776)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Although the task generator instances are processed in order, the task generator method execution requires a specific declaration for the order of execution. Here, the method <em>pong</em> is executed before the method <em>ping</em></td>
</tr></table>
</div>
<h4 id="_task_generator_method_execution_order">8.3.4. Task generator method execution order</h4>
<div class="paragraph"><p>To control the execution order, two new decorators need to be added. We will now show a new example with two custom task generator methods <em>method1</em> and <em>method2</em>, executed in that order:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'exec_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method1</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 1 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'method1'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method2</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 2 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">15:54:02 task_gen posting objects (normal)</span>
<span style="color: #000000">15:54:02 task_gen posting &lt;task_gen of type task_gen defined in dir:///tmp/simpleproject&gt; 139808568487632</span>
<span style="color: #000000">15:54:02 task_gen -&gt; method1 (139808568487632)</span>
<span style="color: #000000">method 1 'Hello, world!'</span>
<span style="color: #000000">15:54:02 task_gen -&gt; exec_rule (139808568487632)</span>
<span style="color: #000000">15:54:02 task_gen -&gt; method2 (139808568487632)</span>
<span style="color: #000000">method 2 'Hello, world!'</span>
<span style="color: #000000">15:54:02 task_gen -&gt; process_source (139808568487632)</span>
<span style="color: #000000">15:54:02 task_gen posted</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">15:54:02 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<h4 id="_adding_or_removing_a_method_for_execution">8.3.5. Adding or removing a method for execution</h4>
<div class="paragraph"><p>The order constraints on the methods (after/before), are used to sort the list of methods in the attribute <em>meths</em>. The sorting is performed once, and the list is consumed as methods are executed. Though no new feature may be added once the first method is executed, new methods may be added dynamically in self.meths. Here is how to create an infinite loop by adding the same method at the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">infinite_loop</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'infinite_loop'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Likewise, methods may be removed from the list of methods to execute:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">remove_process_source</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">remove</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The task generator method workflow is represented in the following illustration:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="posting.png" alt="Task generator workflow" />
</div>
</div>
<h4 id="_expressing_abstract_dependencies_between_task_generators">8.3.6. Expressing abstract dependencies between task generators</h4>
<div class="paragraph"><p>We will now illustrate how task generator methods can be used to express abstract dependencies between task generator objects. Here is a new project file located under <em>/tmp/targets/</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>By executing <em>waf --targets=B</em>, only the task generator <em>B</em> will create its tasks, and the output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.042s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">[1/1] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.032s)</span></tt></pre></div></div>
<div class="paragraph"><p>Here is a way to ensure that the task generator <em>A</em> has created its tasks when <em>B</em> does:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">,</span><span style="color: #000000"> depends_on</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span>
<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post_the_other</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    deps </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'depends_on'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> name </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">deps</span><span style="color: #000000">):</span>
<span style="color: #000000">        other </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (before) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        other</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (after) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
This method will be executed for all task generators, before the attribute <tt>rule</tt> is processed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Try to process the attribute <tt>depends_on</tt>, if present
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Obtain the task generator by name, and for the same variant
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Force the other task generator to create its tasks
</td></tr>
</table></div>
<div class="paragraph"><p>The output will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">other task generator tasks (before) [] <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">other task generator tasks (after) [ <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        {task: A  -&gt; }]</span>
<span style="color: #000000">[1/2] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">[2/2] A: <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">A</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The other task generator has not created any task yet
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
A task generator creates all its tasks by calling its method <tt>post()</tt>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Although <tt>--targets=B</tt> was requested, the task from target <em>A</em> was created and executed too
</td></tr>
</table></div>
<div class="paragraph"><p>In practice, the dependencies will often re-use the task objects created by the other task generator: node, configuration set, etc. This is used by the uselib system (see the next chapter on c/c++ builds).</p></div>
</div>
<h2 id="_c_and_c_projects">9. C and C++ projects</h2>
<div class="sectionbody">
<div class="paragraph"><p>Although Waf is language neutral, it is used very often for C and C++ projects. This chapter describes the Waf tools and functions used for these languages.</p></div>
<h3 id="_common_script_for_c_c_and_d_applications">9.1. Common script for C, C++ and D applications</h3><div style="clear:left"></div>
<h4 id="_predefined_task_generators">9.1.1. Predefined task generators</h4>
<div class="paragraph"><p>The C/C++ builds consist in transforming (compiling) source files into object files, and to assemble (link) the object files at the end. In theory a single programming language should be sufficient for writing any application, but the situation is usually more complicated:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Source files may be created by other compilers in other languages (IDL, ASN1, etc)
</p>
</li>
<li>
<p>
Additional files may enter in the link step (libraries, object files) and applications may be divided in dynamic or static libraries
</p>
</li>
<li>
<p>
Different platforms may require different processing rules (manifest files on MS-Windows, etc)
</p>
</li>
</ol></div>
<div class="paragraph"><p>To conceal the implementation details and the portability concerns, each target (program, library) can be wrapped as single task generator object as in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'myshlib mystlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'mystlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'b.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'myshlib'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'myobjects'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">objects</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'c.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'myobjects'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Use compiler_c to load the c routines and to find a compiler (for c++ use <em>compiler_cxx</em> and <em>compiler_d</em> for d)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Declare a program built from <em>main.c</em> and using two other libraries
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a static library
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Declare a shared library, using the objects from <em>myobjects</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The targets will have different extensions and names depending on the platform. For example on Linux, the contents of the build directory will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree build</span></span>
<span style="color: #000000">build/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">|-- a.c.1.o</span>
<span style="color: #000000">|-- app <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">|-- b.c.2.o</span>
<span style="color: #000000">|-- c.c.3.o</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">|-- libmyshlib.so <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|-- libmystlib.a</span>
<span style="color: #000000">`-- main.c.0.o <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Programs have no extension on Linux but will have <em>.exe</em> on Windows
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The <em>.so</em> extension for shared libraries on Linux will be <em>.dll</em> on Windows
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The <em>.o</em> object files use the original file name and an index to avoid errors in multiple compilations
</td></tr>
</table></div>
<div class="paragraph"><p>The build context methods <em>program</em>, <em>shlib</em>, <em>stlib</em> and <em>objects</em> return a single task generator with the appropriate features detected from the source list. For example, for a program having <em>.c</em> files in the source attribute, the features added will be <em>"c cprogram"</em>, for a <em>d</em> static library, <em>"d dstlib"</em>.</p></div>
<h4 id="_additional_attributes">9.1.2. Additional attributes</h4>
<div class="paragraph"><p>The methods described previously can process many more attributes than just <em>use</em>. Here is an advanced example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'appname'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                features     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'more'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'features'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">                includes     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                defines      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'LINUX=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'BIDULE'</span><span style="color: #000000">],</span>

<span style="color: #000000">                lib          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                libpath      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">],</span>
<span style="color: #000000">                stlib        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'dl'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                stlibpath    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/local/lib'</span><span style="color: #000000">],</span>
<span style="color: #000000">                linkflags    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                rpath        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt/kde/lib'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                vnum         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'1.2.3'</span><span style="color: #000000">,</span>

<span style="color: #000000">                install_path </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${SOME_PATH}/bin'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>
<span style="color: #000000">                cflags       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-Wall'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/10.png" alt="10" /></span>
<span style="color: #000000">                cxxflags     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O3'</span><span style="color: #000000">],</span>
<span style="color: #000000">                dflags       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">],</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Source file list
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Target, converted automatically to <tt>target.exe</tt> or <tt>libtarget.so</tt>, depending on the platform and type
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Additional features to add (for a program consisting in c files, the default will be <em>'c cprogram'</em>)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Includes and defines
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Shared libraries and shared libraries link paths
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Static libraries and link paths
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Use linkflags for specific link flags (not for passing libraries)
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
rpath and vnum, ignored on platforms that do not support them
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
Programs and shared libraries are installed by default. To disable the installation, set None.
</td></tr>
<tr><td><img src="./callouts/10.png" alt="10" /></td><td>
Miscalleneous flags, applied to the source files that support them (if present)
</td></tr>
</table></div>
<h3 id="_include_processing">9.2. Include processing</h3><div style="clear:left"></div>
<h4 id="_execution_path_and_flags">9.2.1. Execution path and flags</h4>
<div class="paragraph"><p>Include paths are used by the C/C++ compilers for finding headers. When one header changes, the files are recompiled automatically. For example on a project having the following structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- foo.h</span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   |-- main.c</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>The file <em>src/wscript</em> will contain the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.. .'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The command-line (output by <tt>waf -v</tt>) will have the following form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cc -I. -I.. -Isrc -I../src ../src/main.c -c -o src/main_1.o</span></tt></pre></div></div>
<div class="paragraph"><p>Because commands are executed from the build directory, the folders have been converted to include flags in the following way:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">.. -&gt; -I..      -I.</span>
<span style="color: #000000">.  -&gt; -I../src  -Isrc</span></tt></pre></div></div>
<div class="paragraph"><p>There are the important points to remember:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The includes are always given relative to the directory containing the wscript file
</p>
</li>
<li>
<p>
The includes add both the source directory and the corresponding build directory for the task generator variant
</p>
</li>
<li>
<p>
Commands are executed from the build directory, so the include paths must be converted
</p>
</li>
<li>
<p>
System include paths should be defined during the configuration and added to INCLUDES variables (uselib)
</p>
</li>
</ol></div>
<h4 id="_the_waf_preprocessor">9.2.2. The Waf preprocessor</h4>
<div class="paragraph"><p>Waf uses a preprocessor written in Python for adding the dependencies on the headers. A simple parser looking at #include statements would miss constructs such as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> mymacro </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> mymacro</span></tt></pre></div></div>
<div class="paragraph"><p>Using the compiler for finding the dependencies would not work for applications requiring file preprocessing such as Qt. For Qt, special include files having the <em>.moc</em> extension must be detected by the build system and produced ahead of time. The c compiler could not parse such files.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.moc"</span></tt></pre></div></div>
<div class="paragraph"><p>Since system headers are not tracked by default, the waf preprocessor may miss dependencies written in the following form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#if</span></span><span style="color: #000000"> SOMEMACRO</span>
<span style="color: #000000">        </span><span style="color: #808080">/* an include in the project */</span>
<span style="font-weight: bold"><span style="color: #008080">        #include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#endif</span></span></tt></pre></div></div>
<div class="paragraph"><p>To write portable code and to ease debugging, it is strongly recommended to put all the conditions used within a project into a <em>config.h</em> file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span>
<span style="color: #000000">                fragment    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'int main() { return 0; }\n'</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'FOO'</span><span style="color: #000000">,</span>
<span style="color: #000000">                mandatory   </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>For performance reasons, the implicit dependency on the system headers is ignored by default. The following code may be used to enable this behaviour:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> c_preproc</span>
<span style="color: #000000">c_preproc</span><span style="color: #000000">.</span><span style="color: #000000">go_absolute </span><span style="color: #000000">=</span><span style="color: #000000"> True</span></tt></pre></div></div>
<div class="paragraph"><p>Additional tools such as <a href="http://code.google.com/p/waf/source/browse/trunk/waflib/extras/gccdeps.py">gccdeps</a> or <a href="http://code.google.com/p/waf/source/browse/trunk/waflib/extras/dumbpreproc.py">dumbpreproc</a> provide alternate dependency scanners that can be faster in certain cases (boost).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The Waf engine will detect if tasks generate headers necessary for the compilation and compute the build order accordingly. It may sometimes improve the performance of the scanner if the tasks creating headers provide the hint <em>ext_out=[".h"]</em>.</td>
</tr></table>
</div>
<h4 id="_dependency_debugging">9.2.3. Dependency debugging</h4>
<div class="paragraph"><p>The Waf preprocessor contains a specific debugging zone:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=preproc</span></span></tt></pre></div></div>
<div class="paragraph"><p>To display the dependencies obtained or missed, use the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=deps</span></span>

<span style="color: #000000">23:53:21 deps deps for src:///comp/waf/demos/qt4/src/window.cpp: <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">  [src:///comp/waf/demos/qt4/src/window.h, bld:///comp/waf/demos/qt4/src/window.moc]; <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">  unresolved ['QtGui', 'QGLWidget', 'QWidget'] <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
File being preprocessed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Headers found
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
System headers discarded
</td></tr>
</table></div>
<div class="paragraph"><p>The dependency computation is performed only when the files are not up-to-date, so these commands will display something only when there is a file to compile.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The scanner is only called when C files or dependencies change. In the rare case of adding headers after a successful compilation, then it may be necessary to run <em>waf clean build</em> to force a full scanning.</td>
</tr></table>
</div>
<h3 id="_library_interaction_use">9.3. Library interaction (use)</h3><div style="clear:left"></div>
<h4 id="_local_libraries">9.3.1. Local libraries</h4>
<div class="paragraph"><p>The attribute <em>use</em> enables the link against libraries (static or shared), or the inclusion of object files when the task generator referenced is not a library.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'mylib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'stlib1'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'stlib1'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The name attribute must point at exactly one task generator
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The attribute <em>use</em> contains the task generator names to use
</td></tr>
</table></div>
<div class="paragraph"><p>In this example, the file <em>app</em> will be re-created whenever <em>mylib</em> changes (order and dependency). By using task generator names, the programs and libraries declarations may appear in any order and across scripts. For convenience, the name does not have to be defined, and will be pre-set from the target name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'mylib'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'mylib'</span><span style="color: #000000">])</span></tt></pre></div></div>
<div class="paragraph"><p>The <em>use</em> processing also exhibits a recursive behaviour. Let&#8217;s illustrate it by the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'b.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cshlib'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib2'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1 lib2'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib3'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
A simple shared library
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The <em>cshlib</em> flags will be propagated to both the library and the program. <span class="footnote"><br />[To prevent the propagation, see <a href="http://code.google.com/p/waf/source/browse/trunk/docs/book/examples/cprog_propagation/wscript">http://code.google.com/p/waf/source/browse/trunk/docs/book/examples/cprog_propagation/wscript</a>]<br /></span>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>lib3</em> uses both a shared library and a static library
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
A program using <em>lib3</em>
</td></tr>
</table></div>
<div class="paragraph"><p>Because of the shared library dependency <em>lib1</em> → <em>lib2</em>, the program <em>app</em> should link against both <em>lib1</em> and <em>lib3</em>, but not against <em>lib2</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">'clean' finished successfully (0.004s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/cprog_propagation/build'</span>
<span style="color: #000000">[1/8] c: a.c -&gt; build/a.c.0.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '-fPIC', '../a.c', '-c', '-o', 'a.c.0.o']</span>
<span style="color: #000000">[2/8] c: b.c -&gt; build/b.c.1.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '../b.c', '-c', '-o', 'b.c.1.o']</span>
<span style="color: #000000">[3/8] c: c.c -&gt; build/c.c.2.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '-fPIC', '../c.c', '-c', '-o', 'c.c.2.o']</span>
<span style="color: #000000">[4/8] c: main.c -&gt; build/main.c.3.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '../main.c', '-c', '-o', 'main.c.3.o']</span>
<span style="color: #000000">[5/8] cstlib: build/b.c.1.o -&gt; build/liblib2.a</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/ar', 'rcs', 'liblib2.a', 'b.c.1.o']</span>
<span style="color: #000000">[6/8] cshlib: build/a.c.0.o -&gt; build/liblib1.so</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'a.c.0.o', '-o', 'liblib1.so', '-shared']</span>
<span style="color: #000000">[7/8] cshlib: build/c.c.2.o -&gt; build/liblib3.so</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'c.c.2.o', '-o', 'liblib3.so', '-Wl,-Bstatic', '-L.', '-llib2', '-Wl,-Bdynamic', '-L.', '-llib1', '-shared']</span>
<span style="color: #000000">[8/8] cprogram: build/main.c.3.o -&gt; build/app</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'main.c.3.o', '-o', 'app', '-Wl,-Bdynamic', '-L.', '-llib1', '-llib3']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/cprog_propagation/build'</span>
<span style="color: #000000">'build' finished successfully (0.144s)</span></tt></pre></div></div>
<div class="paragraph"><p>To sum up the two most important aspects of the <em>use</em> attribute:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The task generators may be created in any order and in different files, but must provide a unique name for the <em>use</em> attribute
</p>
</li>
<li>
<p>
The <em>use</em> processing will iterate recursively over all the task generators involved, but the flags added depend on the target kind (shared/static libraries)
</p>
</li>
</ol></div>
<h4 id="_special_local_libraries">9.3.2. Special local libraries</h4>
<h5 id="_includes_folders">Includes folders</h5>
<div class="paragraph"><p>The use keywork may point at special libraries that do not actually declare a target. For example, header-only libraries are commonly used to add specific include paths to several targets:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                includes        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'. src'</span><span style="color: #000000">,</span>
<span style="color: #000000">                export_includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'src'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                name            </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'com_includes'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'shlib1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use             </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'com_includes'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use             </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'shlib1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The <em>includes</em> attribute is private, but <em>export_includes</em> will be used by other task generators
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The paths added are relative to the other task generator
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The <em>export_includes</em> will be propagated to other task generators
</td></tr>
</table></div>
<h5 id="_object_files">Object files</h5>
<div class="paragraph"><p>Here is how to enable specific compilation flags for particular files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">objects</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                cflags  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                cflags  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_c_program'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Files will be compiled in c mode, but no program or library will be produced
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Different compilation flags may be used
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The objects will be added automatically in the link stage
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
There is no object propagation to other programs or libraries to avoid duplicate symbol errors
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Like static libraries, object files are often abused to copy-paste binary code. Try to minimize the executables size by using shared libraries whenever possible.</td>
</tr></table>
</div>
<h5 id="_fake_libraries">Fake libraries</h5>
<div class="paragraph"><p>Local libraries will trigger a recompilation whenever they change. The methods <em>read_shlib</em> and <em>read_stlib</em> can be used to add this behaviour to external libraries or to binary files present in the project.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">read_shlib</span><span style="color: #000000">(</span><span style="color: #009900">'m'</span><span style="color: #000000">,</span><span style="color: #000000"> paths</span><span style="color: #000000">=[</span><span style="color: #009900">'.'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">])</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'m'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The methods will try to find files such as <em>libm.so</em> or <em>libm.dll</em> in the specified paths to compute the required paths and dependencies. In this example, the target <em>app</em> will be re-created whenever <em>/usr/lib64/libm.so</em> changes. These libraries are propagated between task generators just like shared or static libraries declared locally.</p></div>
<h4 id="_foreign_libraries_and_flags">9.3.3. Foreign libraries and flags</h4>
<div class="paragraph"><p>When an element in the attribute <em>use</em> does not match a local library, it is assumed that it represents a system library, and the the required flags are present in the configuration set <em>env</em>. This system enables the addition of several compilation and link flags at once, as in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> sys</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">INCLUDES_TEST      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> sys</span><span style="color: #000000">.</span><span style="color: #000000">platform </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #009900">'win32'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DEFINES_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'TEST'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O0'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIB_TEST       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIBPATH_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LINKFLAGS_TEST </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">INCLUDES_TEST  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt/gnome/include'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        mylib </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'teststaticlib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'TEST'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> mylib</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CC_NAME </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'gcc'</span><span style="color: #000000">:</span>
<span style="color: #000000">                mylib</span><span style="color: #000000">.</span><span style="color: #000000">cxxflags </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
For portability reasons, it is recommended to use INCLUDES instead of giving flags of the form -I/include. Note that the INCLUDES use used by both c and c++
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Variables may be left undefined in platform-specific settings, yet the build scripts will remain identical.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Declare a few variables during the configuration, the variables follow the convention VAR_NAME
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Add all the VAR_NAME corresponding to the <em>use variable</em> NAME, which is <em>TEST</em> in this example
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>Model to avoid</em>: setting the flags and checking for the configuration should be performed in the configuration section
</td></tr>
</table></div>
<div class="paragraph"><p>The variables used for C/C++ are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Use variables and task generator attributes for C/C++</caption>
<col width="20%" />
<col width="20%" />
<col width="60%" />
<thead>
<tr>
<th align="left" valign="top">Uselib variable </th>
<th align="left" valign="top"> Attribute </th>
<th align="left" valign="top"> Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">LIB</p></td>
<td align="left" valign="top"><p class="table">lib</p></td>
<td align="left" valign="top"><p class="table">list of sharedlibrary names to use, without prefix or extension</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LIBPATH</p></td>
<td align="left" valign="top"><p class="table">libpath</p></td>
<td align="left" valign="top"><p class="table">list of search path for shared libraries</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">STLIB</p></td>
<td align="left" valign="top"><p class="table">stlib</p></td>
<td align="left" valign="top"><p class="table">list of static library names to use, without prefix or extension</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">STLIBPATH</p></td>
<td align="left" valign="top"><p class="table">stlibpath</p></td>
<td align="left" valign="top"><p class="table">list of search path for static libraries</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LINKFLAGS</p></td>
<td align="left" valign="top"><p class="table">linkflags</p></td>
<td align="left" valign="top"><p class="table">list of link flags (use other variables whenever possible)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RPATH</p></td>
<td align="left" valign="top"><p class="table">rpath</p></td>
<td align="left" valign="top"><p class="table">list of paths to hard-code into the binary during linking time</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CFLAGS</p></td>
<td align="left" valign="top"><p class="table">cflags</p></td>
<td align="left" valign="top"><p class="table">list of compilation flags for c files</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXFLAGS</p></td>
<td align="left" valign="top"><p class="table">cxxflags</p></td>
<td align="left" valign="top"><p class="table">list of compilation flags for c++ files</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DFLAGS</p></td>
<td align="left" valign="top"><p class="table">dflags</p></td>
<td align="left" valign="top"><p class="table">list of compilation flags for d files</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">INCLUDES</p></td>
<td align="left" valign="top"><p class="table">includes</p></td>
<td align="left" valign="top"><p class="table">include paths</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">a variable/list to trigger c++ file recompilations when it changes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CCDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">same as above, for c</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LINKDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">same as above, for the link tasks</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DEFINES</p></td>
<td align="left" valign="top"><p class="table">defines</p></td>
<td align="left" valign="top"><p class="table">list of defines in the form [&#8216;key=value&#8217;, &#8230;]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORK</p></td>
<td align="left" valign="top"><p class="table">framework</p></td>
<td align="left" valign="top"><p class="table">list of frameworks to use</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORKPATH</p></td>
<td align="left" valign="top"><p class="table">frameworkpath</p></td>
<td align="left" valign="top"><p class="table">list of framework paths to use</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ARCH</p></td>
<td align="left" valign="top"><p class="table">arch</p></td>
<td align="left" valign="top"><p class="table">list of architectures in the form [<em>ppc</em>, <em>x86</em>]</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The variables may be left empty for later use, and will not cause errors. During the development, the configuration cache files (for example, _cache.py) may be modified from a text editor to try different configurations without forcing a whole project reconfiguration. The files affected will be rebuilt however.</p></div>
<h3 id="_configuration_helpers">9.4. Configuration helpers</h3><div style="clear:left"></div>
<h4 id="_configuration_tests">9.4.1. Configuration tests</h4>
<div class="paragraph"><p>The method <em>check</em> is used to detect parameters using a small build project. The main parameters are the following</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
msg: title of the test to execute
</p>
</li>
<li>
<p>
okmsg: message to display when the test succeeds
</p>
</li>
<li>
<p>
errmsg: message to display when the test fails
</p>
</li>
<li>
<p>
env: environment to use for the build (conf.env is used by default)
</p>
</li>
<li>
<p>
compile_mode: <em>cc</em> or <em>cxx</em>
</p>
</li>
<li>
<p>
define_name: add a define for the configuration header when the test succeeds (in most cases it is calculated automatically)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The errors raised are instances of <em>waflib.Errors.ConfigurationError</em>. There are no return codes.</p></div>
<div class="paragraph"><p>Besides the main parameters, the attributes from c/c++ task generators may be used. Here is a concrete example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">header_name</span><span style="color: #000000">=</span><span style="color: #009900">'time.h'</span><span style="color: #000000">,</span><span style="color: #000000"> features</span><span style="color: #000000">=</span><span style="color: #009900">'c cprogram'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">function_name</span><span style="color: #000000">=</span><span style="color: #009900">'printf'</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">"stdio.h"</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main() {2+2==4;}\n'</span><span style="color: #000000">,</span><span style="color: #000000"> define_name</span><span style="color: #000000">=</span><span style="color: #009900">"boobah"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'m'</span><span style="color: #000000">,</span><span style="color: #000000"> cflags</span><span style="color: #000000">=</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">,</span><span style="color: #000000"> defines</span><span style="color: #000000">=[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">],</span>
<span style="color: #000000">                uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cxx</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'linux'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">,</span><span style="color: #000000"> cxxflags</span><span style="color: #000000">=</span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'''</span>
<span style="color: #009900">                        #include &lt;stdio.h&gt;</span>
<span style="color: #009900">                        int main() { printf("4"); return 0; } '''</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"booeah"</span><span style="color: #000000">,</span>
<span style="color: #000000">                execute     </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_ret  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                msg         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"Checking for something"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main(){return 0;}'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Try to compile a program using the configuration header time.h, if present on the system, if the test is successful, the define HAVE_TIME_H will be added
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Try to compile a program with the function printf, adding the header stdio.h (the header_name may be a list of additional headers). All configuration tests are required by default (@conf methods) and will raise configuration exceptions. To conceal them, set the attribute <em>mandatory</em> to False.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Try to compile a piece of code, and if the test is successful, define the name boobah
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Modifications made to the task generator environment are not stored. When the test is successful and when the attribute uselib_store is provided, the names lib, cflags and defines will be converted into <em>use variables</em> LIB_M, CFLAGS_M and DEFINES_M and the flag values are added to the configuration environment.
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Try to compile a simple c program against a library called <em>linux</em>, and reuse the previous parameters for libm by <em>use</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Execute a simple program, collect the output, and put it in a define when successful
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
The tests create a build with a single task generator. By passing the <em>features</em> attribute directly it is possible to disable the compilation or to create more complicated configuration tests.
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
After all the tests are executed, write a configuration header in the build directory (optional). The configuration header is used to limit the size of the command-line.
</td></tr>
</table></div>
<div class="paragraph"><p>Here is an example of a <tt>config.h</tt> produced with the previous test code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_PRINTF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_TIME_H </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> boobah </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> booeah </span><span style="color: #009900">"4"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<div class="paragraph"><p>The file <tt>_cache.py</tt> will contain the following variables:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">DEFINES_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">]</span>
<span style="color: #000000">CXXFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">CFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">LIB_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">]</span>
<span style="color: #000000">boobah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">booeah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'4'</span>
<span style="color: #000000">defines </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'booeah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'"4"'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'boobah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_TIME_H'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_PRINTF'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">}</span>
<span style="color: #000000">dep_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'config.h'</span><span style="color: #000000">]</span>
<span style="color: #000000">waf_config_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/compilation/waf/demos/adv/build/config.h'</span><span style="color: #000000">]</span></tt></pre></div></div>
<h4 id="_advanced_tests">9.4.2. Advanced tests</h4>
<div class="paragraph"><p>The methods <em>conf.check</em> create a build context and a task generator internally. This means that the attributes <em>includes</em>, <em>defines</em>, <em>cxxflags</em> may be used (not all shown here). Advanced tests may be created by passing feature arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'special_test'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">my_special_test</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'special_test'</span><span style="color: #000000">,</span><span style="color: #000000"> msg</span><span style="color: #000000">=</span><span style="color: #009900">'my test!'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create a task generator from another task generator
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Disable the compilation of <tt>test.c</tt> by setting no source files
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Use the feature special_test
</td></tr>
</table></div>
<h4 id="_creating_configuration_headers">9.4.3. Creating configuration headers</h4>
<div class="paragraph"><p>Adding lots of command-line define values increases the size of the command-line and makes it harder to review the flags when errors occur. Besides that, the defines passed on the command-line may fail unexpectedly with different compilers and command execution contexts. For example, define values containing quotes may be misinterpreted in Visual Studio response files. It is therefore a best practice to use configuration headers whenever possible.</p></div>
<div class="paragraph"><p>Writing configuration headers can be performed using the following methods:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">undefine</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF_VERSION'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'1.0.2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The code snipped will produce the following <em>config.h</em> in the build directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">build/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">`-- config.h</span></tt></pre></div></div>
<div class="paragraph"><p>The contents of the config.h for this example are:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="color: #808080">/* #undef NOLIBF */</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF_VERSION </span><span style="color: #009900">"1.0.2"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">By default, the defines are moved from the command-line into the configuration header. This means that the attribute <em>conf.env.DEFINE</em> is cleared by this operation. To prevent this behaviour, use <em>conf.write_config_header(remove=False)</em></td>
</tr></table>
</div>
<h4 id="_pkg_config">9.4.4. Pkg-config</h4>
<div class="paragraph"><p>Instead of duplicating the configuration detection in all dependent projects, configuration files may be written when libraries are installed. To ease the interaction with build systems based on Make (cannot query databases or apis), small applications have been created for reading the cache files and to interpret the parameters (with names traditionally ending in <em>-config</em>): <a href="http://pkg-config.freedesktop.org/wiki/">pkg-config</a>, wx-config, sdl-config, etc.</p></div>
<div class="paragraph"><p>The method <em>check_cfg</em> is provided to ease the interaction with these applications. Here are a few examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">atleast_pkgconfig_version</span><span style="color: #000000">=</span><span style="color: #009900">'0.0.0'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        pango_version </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">modversion</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'MYPANGO'</span><span style="color: #000000">,</span>
<span style="color: #000000">                args</span><span style="color: #000000">=[</span><span style="color: #009900">'--cflags'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--libs'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                args</span><span style="color: #000000">=[</span><span style="color: #009900">'pango &gt;= 0.1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'pango &lt; 9.9.9'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--cflags'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--libs'</span><span style="color: #000000">],</span>
<span style="color: #000000">                msg</span><span style="color: #000000">=</span><span style="color: #009900">"Checking for 'pango 0.1.0'"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'sdl-config'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--cflags --libs'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'SDL'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'mpicc'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--showme:compile --showme:link'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'OPEN_MPI'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Check for the pkg-config version
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Retrieve the module version for a package as a string. If there were no errors, <em>PANGO_VERSION</em> is defined. It can be overridden with the attribute <em>uselib_store='MYPANGO'</em>.
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Check if the pango package is present, and define <em>HAVE_PANGO</em> (calculated automatically from the package name)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Beside defining <em>HAVE_MYPANGO</em>, extract and store the relevant flags to the <em>use variable</em> MYPANGO (<em>LIB_MYPANGO</em>, <em>LIBPATH_MYPANGO</em>, etc)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Like the previous test, but with pkg-config clauses to enforce a particular version number
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Display a custom message on the output. The attributes <em>okmsg</em> and <em>errmsg</em> represent the messages to display in case of success and error respectively
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Obtain the flags for sdl-config. The example is applicable for other configuration programs such as wx-config, pcre-config, etc
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Suppress the configuration error which is raised whenever the program to execute is not found or returns a non-zero exit status
</td></tr>
</table></div>
<div class="paragraph"><p>Due to the amount of flags, the lack of standards between config applications, and to the compiler-dependent flags (-I for gcc, /I for msvc), the pkg-config output is parsed before setting the corresponding <em>use variables</em> in a go. The function <em>parse_flags(line, uselib, env)</em> in the Waf module c_config.py performs the flag extraction.</p></div>
<div class="paragraph"><p>The outputs are written in the build directory into the file <em>config.log</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399"># project  configured on Tue Aug 31 17:30:21 2010 by</span></span>
<span style="font-weight: bold"><span style="color: #993399"># waf 1.7.11 (abi 98, python 20605f0 on linux2)</span></span>
<span style="font-weight: bold"><span style="color: #993399"># using /home/waf/bin/waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">#</span></span>
<span style="color: #000000">---</span>
<span style="color: #000000">Setting top to</span>
<span style="color: #000000">/disk/comp/waf/docs/book/examples/cprog_pkgconfig</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Setting out to</span>
<span style="color: #000000">/disk/comp/waf/docs/book/examples/cprog_pkgconfig/build</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for program pkg-config</span>
<span style="color: #000000">/usr/bin/pkg-config</span>
<span style="color: #000000">find program=['pkg-config'] paths=['/usr/local/bin', '/usr/bin'] var='PKGCONFIG' -&gt; '/usr/bin/pkg-config'</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pkg-config version &gt;= 0.0.0</span>
<span style="color: #000000">['/usr/bin/pkg-config', '--atleast-pkgconfig-version=0.0.0']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">['/usr/bin/pkg-config', '--modversion', 'pango']</span>
<span style="color: #000000">out: 1.28.0</span>

<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango 0.1.0</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango &gt;= 0.1.0', 'pango &lt; 9.9.9', '--cflags', '--libs', 'pango']</span>
<span style="color: #000000">out: -pthread -I/usr/include/pango-1.0 -I/usr/include/glib-2.0 -I/usr/lib64/glib-2.0/include</span>
<span style="color: #000000">     -pthread -lpango-1.0 -lgobject-2.0 -lgmodule-2.0 -lgthread-2.0 -lrt -lglib-2.0</span>

<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for sdl-config</span>
<span style="color: #000000">['sdl-config', '--cflags', '--libs']</span>
<span style="color: #000000">out: -I/usr/include/SDL -D_GNU_SOURCE=1 -D_REENTRANT</span>
<span style="color: #000000">-L/usr/lib64 -lSDL -lpthread</span>

<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for mpicc</span>
<span style="color: #000000">['mpicc', '--showme:compile', '--showme:link']</span>
<span style="color: #000000">out: -pthread libtool: link: -pthread -L/usr/lib64 -llammpio -llamf77mpi -lmpi -llam -lutil -ldl</span></tt></pre></div></div>
<div class="paragraph"><p>After such a configuration, the configuration set contents will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">'CFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CXXFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CXXFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'DEFINES'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'HAVE_PANGO=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_MYPANGO=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_SDL=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_OPEN_MPI=1'</span><span style="color: #000000">]</span>
<span style="color: #009900">'DEFINES_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'_GNU_SOURCE=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'_REENTRANT'</span><span style="color: #000000">]</span>
<span style="color: #009900">'INCLUDES_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include/pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/include/glib-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/lib64/glib-2.0/include'</span><span style="color: #000000">]</span>
<span style="color: #009900">'INCLUDES_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include/SDL'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIBPATH_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIBPATH_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'lammpio'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'lamf77mpi'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'mpi'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'lam'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'util'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'dl'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gobject-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gmodule-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gthread-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'rt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'glib-2.0'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'SDL'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LINKFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LINKFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'PKGCONFIG'</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/bin/pkg-config'</span>
<span style="color: #009900">'PREFIX'</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/local'</span>
<span style="color: #009900">'define_key'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'HAVE_PANGO'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_MYPANGO'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_SDL'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_OPEN_MPI'</span><span style="color: #000000">]</span></tt></pre></div></div>
</div>
<h2 id="_advanced_scenarios">10. Advanced scenarios</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter demonstrates a few examples of the waf library for more complicated and less common scenarios.</p></div>
<h3 id="_project_organization">10.1. Project organization</h3><div style="clear:left"></div>
<h4 id="_building_the_compiler_first_a_id_build_compiler_first_a">10.1.1. Building the compiler first<a id="build_compiler_first"></a></h4>
<div class="paragraph"><p>The example below demonstrates how to build a compiler which is used for building the remaining targets. The requirements are the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create the compiler and all its intermediate tasks
</p>
</li>
<li>
<p>
Re-use the compiler in a second build step
</p>
</li>
<li>
<p>
The compiler will transform <em>.src</em> files into <em>.cpp</em> files, which will be processed too
</p>
</li>
<li>
<p>
Call the compiler again if it was rebuilt (add the dependency on the compiler)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The first thing to do is to write the expected user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp'</span><span style="color: #000000">)</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.cpp a.src'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Build the compiler first, it will result in a binary named <em>comp</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Add a new build group to make certain the compiler is complete before processing the next tasks
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The file <em>a.src</em> is to be transformed by <em>comp</em> into <em>a.cpp</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The code for the <em>src → cpp</em> conversion will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">src2cpp</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${SRC[0].abspath()} ${SRC[1].abspath()} ${TGT}'</span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'PINK'</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.src'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_src</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    tg </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #009900">'comp'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">    comp </span><span style="color: #000000">=</span><span style="color: #000000"> tg</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">comp</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">],</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">extend</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Declare a new task class for processing the source file by our compiler
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Files of extension <em>.src</em> are to be processed by this method
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Obtain a reference on the task generator producing the compiler
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Create the task <em>src → cpp</em>, the compiler being as used as the first source file
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Add the generated <em>cpp</em> file to be processed too
</td></tr>
</table></div>
<div class="paragraph"><p>The compilation results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.006s)</span>
<span style="color: #000000">Setting top to                           : /tmp/scenarios_compiler</span>
<span style="color: #000000">Setting out to                           : /tmp/scenarios_compiler/build</span>
<span style="color: #000000">Checking for program g++,c++             : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar                  : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.118s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_compiler/build'</span>
<span style="color: #000000">[1/5] cxx: comp.cpp -&gt; build/comp.cpp.0.o</span>
<span style="color: #000000">10:21:14 runner ['/usr/bin/g++', '../comp.cpp', '-c', '-o', 'comp.cpp.0.o']</span>
<span style="color: #000000">[2/5] cxxprogram: build/comp.cpp.0.o -&gt; build/comp <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">10:21:14 runner ['/usr/bin/g++', 'comp.cpp.0.o', '-o', '/tmp/scenarios_compiler/build/comp']</span>
<span style="color: #000000">[3/5] cxx: main.cpp -&gt; build/main.cpp.1.o</span>
<span style="color: #000000">10:21:15 runner ['/usr/bin/g++', '../main.cpp', '-c', '-o', 'main.cpp.1.o']</span>
<span style="color: #000000">[4/5] src2cpp: a.src -&gt; build/a.cpp</span>
<span style="color: #000000">10:21:15 runner ['/tmp/scenarios_compiler/build/comp', '../a.src', 'a.cpp'] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[5/5] cxxprogram: build/main.cpp.1.o -&gt; build/foo <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">10:21:15 runner ['/usr/bin/g++', 'main.cpp.1.o', '-o', 'foo']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_compiler/build'</span>
<span style="color: #000000">'build' finished successfully (1.009s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Creation of the <em>comp</em> program
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Use the compiler to generate <em>a.cpp</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Compile and link <em>a.cpp</em> and <em>main.cpp</em> into the program <em>foo</em>
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">When &#8216;waf --targets=foo&#8217; is called, the task generator &#8216;comp&#8217; will create its tasks too (task generators from previous groups are processed).</td>
</tr></table>
</div>
<h4 id="_providing_arbitrary_configuration_files">10.1.2. Providing arbitrary configuration files</h4>
<div class="paragraph"><p>A file is copied into the build directory before the build starts. The build may use this file for building other targets.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cfg_file </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'somedir/foo.txt'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">    orig </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'/etc/fstab'</span><span style="color: #000000">)</span>
<span style="color: #000000">    txt </span><span style="color: #000000">=</span><span style="color: #000000"> orig</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">    dest </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">bldnode</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #000000">cfg_file</span><span style="color: #000000">)</span>
<span style="color: #000000">    dest</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">mkdir</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    dest</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #000000">txt</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'cfg_files'</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #000000">cfg_file</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Read the file <em>/etc/fstab</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create the destination directory in case it does not already exist
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Create a new file in the build directory
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Mark the output as a configuration file so it can be used during the build
</td></tr>
</table></div>
<div class="paragraph"><p>The execution output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure build</span></span>
<span style="color: #000000">Setting top to     : /tmp/scenarios_impfile</span>
<span style="color: #000000">Setting out to     : /tmp/scenarios_impfile/build</span>
<span style="color: #000000">'configure' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_impfile/build'</span>
<span style="color: #000000">[1/1] bar.txt: build/somedir/foo.txt -&gt; build/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_impfile/build'</span>
<span style="color: #000000">'build' finished successfully (0.008s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- bar.txt</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- somedir</span>
<span style="color: #000000">|       `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<h3 id="_mixing_extensions_and_c_c_features">10.2. Mixing extensions and C/C++ features</h3><div style="clear:left"></div>
<h4 id="_files_processed_by_a_single_task_generator">10.2.1. Files processed by a single task generator</h4>
<div class="paragraph"><p>Now let&#8217;s illustrate the @extension decorator on idl file processing. Files with .idl extension are processed to produce .c and .h files (<tt>foo.idl</tt> → <tt>foo.c</tt> + <tt>foo.h</tt>). The .c files must be compiled after being generated.</p></div>
<div class="paragraph"><p>First, here is the declaration expected in user scripts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo.idl main.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The file <tt>foo.idl</tt> is listed as a source. It will be processed to <tt>foo.cpp</tt> and compiled and linked with <tt>main.cpp</tt></p></div>
<div class="paragraph"><p>Here is the code to support this scenario:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">idl</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; touch ${TGT[1].abspath()}'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">    cpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">    hpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.hpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">,</span><span style="color: #000000"> hpp_node</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">cpp_node</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Dummy command for demonstration purposes. In practice the rule to use would be like <em>omniidl -bcxx ${SRC} -C${TGT}</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Because the idl task produces headers, it must be executed before any other <tt>cpp</tt> file is compiled
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Create the task from the <em>.idl</em> extension.
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Reinject the file to compile by the C++ compiler
</td></tr>
</table></div>
<div class="paragraph"><p>The execution results will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">Setting top to   : /tmp/scenarios_idl</span>
<span style="color: #000000">Setting out to   : /tmp/scenarios_idl/build</span>
<span style="color: #000000">Checking for program g++,c++   : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar        : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.072s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_idl/build'</span>
<span style="color: #000000">[1/4] idl: foo.idl -&gt; build/foo.cpp build/foo.hpp</span>
<span style="color: #000000">19:47:11 runner 'cp ../foo.idl foo.cpp &amp;&amp; touch foo.hpp'</span>
<span style="color: #000000">[2/4] cxx: main.cpp -&gt; build/main.cpp.0.o</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', '-I.', '-I..', '../main.cpp', '-c', '-o', 'main.cpp.0.o']</span>
<span style="color: #000000">[3/4] cxx: build/foo.cpp -&gt; build/foo.cpp.0.o</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', '-I.', '-I..', 'foo.cpp', '-c', '-o', 'foo.cpp.0.o']</span>
<span style="color: #000000">[4/4] cxxprogram: build/main.cpp.0.o build/foo.cpp.0.o -&gt; build/myapp</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', 'main.cpp.0.o', 'foo.cpp.0.o', '-o', 'myapp']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_idl/build'</span>
<span style="color: #000000">'build' finished successfully (0.149s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">The drawback of this declaration is that the source files produced by the idl transformation can be used by only one task generator.</td>
</tr></table>
</div>
<h4 id="_resources_shared_by_several_task_generators">10.2.2. Resources shared by several task generators</h4>
<div class="paragraph"><p>Let&#8217;s suppose now that the idl outputs will be shared by several task generators. We will first start by writing the expected user script:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'notify.idl'</span><span style="color: #000000">,</span>
<span style="color: #000000">        name     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">],</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'testprog'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">        add_idl  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Process an idl file in a first task generator. Name this task generator <em>idl_gen</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Somewhere else (maybe in another script), another task generator will use the source generated by the idl processing
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Reference the idl processing task generator by the name <em>idl_gen</em>.
</td></tr>
</table></div>
<div class="paragraph"><p>The code to support this scenario will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">idl</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; touch ${TGT[1].abspath()}'</span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        cpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        hpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.hpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">,</span><span style="color: #000000"> hpp_node</span><span style="color: #000000">])</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">more_source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_add_source</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'add_idl'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[])):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span>
<span style="color: #000000">                y</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'more_source'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">extend</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">.</span><span style="color: #000000">more_source</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The idl processing must be performed before any C++ task is executed
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Bind the output file to a new attribute
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Add the source from another task generator object
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Process <em>add_idl</em>, finding the other task generator
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Ensure that the other task generator has created its tasks
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Update the source list
</td></tr>
</table></div>
<div class="paragraph"><p>The task execution output will be very similar to the output from the first example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.007s)</span>
<span style="color: #000000">Setting top to  : /tmp/scenarios_idl2</span>
<span style="color: #000000">Setting out to  : /tmp/scenarios_idl2/build</span>
<span style="color: #000000">Checking for program g++,c++    : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar         : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.080s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_idl2/build'</span>
<span style="color: #000000">[1/4] idl: foo.idl -&gt; build/foo.cpp build/foo.hpp</span>
<span style="color: #000000">20:20:24 runner 'cp ../foo.idl foo.cpp &amp;&amp; touch foo.hpp'</span>
<span style="color: #000000">[2/4] cxx: main.cpp -&gt; build/main.cpp.1.o</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', '-I.', '-I..', '../main.cpp', '-c', '-o', 'main.cpp.1.o']</span>
<span style="color: #000000">[3/4] cxx: build/foo.cpp -&gt; build/foo.cpp.1.o</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', '-I.', '-I..', 'foo.cpp', '-c', '-o', 'foo.cpp.1.o']</span>
<span style="color: #000000">[4/4] cxxprogram: build/main.cpp.1.o build/foo.cpp.1.o -&gt; build/testprog</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', 'main.cpp.1.o', 'foo.cpp.1.o', '-o', 'testprog']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_idl2/build'</span>
<span style="color: #000000">'build' finished successfully (0.130s)</span></tt></pre></div></div>
<h3 id="_task_generator_methods">10.3. Task generator methods</h3><div style="clear:left"></div>
<h4 id="_replacing_particular_attributes">10.3.1. Replacing particular attributes</h4>
<div class="paragraph"><p>In general, task generator attributes are not replaced, so the following is not going to be compile <tt>main.c</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/includes'</span>
<span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">MAIN </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span>
<span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">    features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">    source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${MAIN}'</span><span style="color: #000000">,</span>
<span style="color: #000000">    target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">    includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'. ${FOO}'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This design decision is motivated by two main reasons:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Processing the attributes has a negative performance impact
</p>
</li>
<li>
<p>
For consistency all attributes would have to be processed
</p>
</li>
</ol></div>
<div class="paragraph"><p>Nevertheless, it is we will demonstrate how to provide Waf with a method to process some attributes. To add a new task generator method, it is necessary to think about its integration with other methods: is there a particular order? The answer is yes, for example, the source attribute is used to create the compilation tasks. To display what methods are in use, execute Waf with the following logging key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=task_gen</span></span>
<span style="color: #000000">...</span>
<span style="color: #000000">19:20:51 task_gen posting task_gen 'app' declared in 'scenarios_expansion' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_rule (9232720) <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_source (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_link (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_objdeps (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_use (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; propagate_uselib_vars (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_incpaths (9232720)</span>
<span style="color: #000000">19:20:51 task_gen posted app</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Task generator execution
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Method name and task generator id in parentheses
</td></tr>
</table></div>
<div class="paragraph"><p>From the method list, we find that <strong>process_rule</strong> and <strong>process_source</strong> are processing the <em>source</em> attribute. The <em>includes</em> attribute is processed by <strong>apply_incpaths</strong>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'process_rule'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">transform_strings</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'includes source'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                val </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> val</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> str</span><span style="color: #000000">):</span>
<span style="color: #000000">                                </span><span style="color: #000000">setattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">subst_vars</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                        </span><span style="color: #000080">elif</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> list</span><span style="color: #000000">):</span>
<span style="color: #000000">                                </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">xrange</span><span style="color: #000000">(</span><span style="color: #000000">len</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">)):</span>
<span style="color: #000000">                                        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">],</span><span style="color: #000000"> str</span><span style="color: #000000">):</span>
<span style="color: #000000">                                                val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">subst_vars</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">],</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Execute this method in all task generators
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Methods to take into account
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Iterate over all interesting attributes
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Substitute the attributes
</td></tr>
</table></div>
<h4 id="_inserting_special_include_flags">10.3.2. Inserting special include flags</h4>
<div class="paragraph"><p>A scenario that appears from times to times in C/C++ projects is the need to insert specific flags before others, regardless of how flags are usually processed. We will now consider the following case: execute all C++ compilations with the flag &#8216;-I.&#8217; in first position (before any other include).</p></div>
<div class="paragraph"><p>First, a look at the definition of the C++ compilation rule shows that the variable <em>INCPATHS</em> contains the include flags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cxx</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'GREEN'</span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${CXX} ${CXXFLAGS} ${CPPPATH_ST:INCPATHS} ${CXX_SRC_F}${SRC} ${CXX_TGT_F}${TGT}'</span>
<span style="color: #000000">    vars    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'CXXDEPS'</span><span style="color: #000000">]</span>
<span style="color: #000000">    ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span>
<span style="color: #000000">    scan    </span><span style="color: #000000">=</span><span style="color: #000000"> c_preproc</span><span style="color: #000000">.</span><span style="color: #000000">scan</span></tt></pre></div></div>
<div class="paragraph"><p>Those include flags are set by the method <em>apply_incpaths</em>. The trick is then to modify <em>INCPATHS</em> after that method has been executed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cxxprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> after</span><span style="color: #000000">,</span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_blddir</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>A related case is how to add the top-level directory containing a configuration header:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'insert_blddir'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_srcdir</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    path </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> path</span><span style="color: #000000">)</span></tt></pre></div></div>
<h3 id="_custom_tasks">10.4. Custom tasks</h3><div style="clear:left"></div>
<h4 id="_force_the_compilation_of_a_particular_task">10.4.1. Force the compilation of a particular task</h4>
<div class="paragraph"><p>In some applications, it may be interesting to keep track of the date and time of the last build. In C this may be done by using the macros &#8216;<em>DATE</em>&#8217; and &#8216;<em>TIME</em>&#8217;, for example, the following <tt>about.c</tt> file will contain:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">{</span>
<span style="color: #000000">    </span><span style="color: #000000">printf</span><span style="color: #000000">(</span><span style="color: #009900">"Project compiled: %s %s</span><span style="color: #CC33CC">\n</span><span style="color: #009900">"</span><span style="color: #000000">,</span><span style="color: #000000"> __DATE__</span><span style="color: #000000">,</span><span style="color: #000000"> __TIME__</span><span style="color: #000000">);</span>
<span style="color: #000000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The files are only compiled when they change though, so it is necessary to find a way to force the <tt>about.c</tt> recompilation. To sum up, the compilation should be performed whenever:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
One of the c files of the project is compiled
</p>
</li>
<li>
<p>
The link flags for any task change
</p>
</li>
<li>
<p>
The link task including the object for our macro is removed
</p>
</li>
</ol></div>
<div class="paragraph"><p>To illustrate this behaviour, we will now set up a project will use various c files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">    opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c about.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">        use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_static_lib'</span><span style="color: #000000">)</span>

<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_static_lib'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The main file will just call the function <em>ping</em> defined <tt>about.c</tt> to display the date and time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> </span><span style="color: #009900">"a.h"</span>

<span style="color: #009900">int</span><span style="color: #000000"> </span><span style="color: #000000">main</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">{</span>
<span style="color: #000000">    </span><span style="color: #000000">ping</span><span style="color: #000000">();</span>
<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000">;</span>
<span style="color: #000000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The task method <em>runnable_status</em> must be overridden to take into account the dependencies:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">if</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">name </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'about.c'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> g </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">groups</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">for</span><span style="color: #000000"> tg </span><span style="color: #000080">in</span><span style="color: #000000"> g</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">,</span><span style="color: #000000"> TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">                    </span><span style="color: #000080">continue</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">                h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">hash</span><span style="color: #000000">((</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">hash_env_vars</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'LINKFLAGS'</span><span style="color: #000000">]),</span><span style="color: #000000"> h</span><span style="color: #000000">))</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> tsk </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'compiled_tasks'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[]):</span><span style="color: #000000"> </span><span style="color: #808080"># all .c or .cpp compilations</span>
<span style="color: #000000">                    </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                        </span><span style="color: #000080">continue</span>
<span style="color: #000000">                    </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> tsk</span><span style="color: #000000">.</span><span style="color: #000000">hasrun</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">ASK_LATER</span>
<span style="color: #000000">                    h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">hash</span><span style="color: #000000">((</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">(),</span><span style="color: #000000"> h</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CCDEPS </span><span style="color: #000000">=</span><span style="color: #000000"> h</span>

<span style="color: #000000">        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">            os</span><span style="color: #000000">.</span><span style="color: #000000">stat</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">c </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> c </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">c</span><span style="color: #000000">.</span><span style="color: #000000">runnable_status </span><span style="color: #000000">=</span><span style="color: #000000"> runnable_status</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
If the task processes <tt>about.c</tt>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Define a hash value that the task will depend on (CCDEPS)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Iterate over all task generators of the project
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Hash the link flags and the signatures of all other compilation tasks
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Make sure to execute the task if it was never executed before
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Normal behaviour
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Modify the <em>c</em> task class
</td></tr>
</table></div>
<div class="paragraph"><p>The execution will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">[2/5] c: test_staticlib.c -&gt; build/test_staticlib.c.1.o</span>
<span style="color: #000000">[3/5] cstlib: build/test_staticlib.c.1.o -&gt; build/libmy_static_lib.a</span>
<span style="color: #000000">[4/5] c: about.c -&gt; build/about.c.0.o</span>
<span style="color: #000000">[5/5] cprogram: build/main.c.0.o build/about.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_end/build' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'build' finished successfully (0.088s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ./build/app</span></span>
<span style="color: #000000">Project compiled: Jul 25 2010 14:05:30</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; main.c <img src="./callouts/2.png" alt="2" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">[1/5] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[4/5] c: about.c -&gt; build/about.c.0.o <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[5/5] cprogram: build/main.c.0.o build/about.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">'build' finished successfully (0.101s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ./build/app</span></span>
<span style="color: #000000">Project compiled: Jul 25 2010 14:05:49</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
All files are compiled on the first build
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
The file <tt>main.c</tt> is modified
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The build generates <tt>about.c</tt> again to update the build time string
</td></tr>
</table></div>
<h4 id="_a_compiler_producing_source_files_with_names_unknown_in_advance">10.4.2. A compiler producing source files with names unknown in advance</h4>
<div class="paragraph"><p>The requirements for this problem are the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
A compiler <strong>creates source files</strong> (one .src file &#8594; several .c files)
</p>
</li>
<li>
<p>
The source file names to create are <strong>known only when the compiler is executed</strong>
</p>
</li>
<li>
<p>
The compiler is slow so it should run <strong>only when absolutely necessary</strong>
</p>
</li>
<li>
<p>
Other tasks will <strong>depend on the generated files</strong> (compile and link the .c files into a program)
</p>
</li>
</ol></div>
<div class="paragraph"><p>To do this, the information on the source files must be shared between the build executions.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'mytool'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COMP </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'evil_comp.py'</span><span style="color: #000000">).</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'x.c foo.src'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'astaticlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Compiler path
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
An example, having a <em>.src</em> file
</td></tr>
</table></div>
<div class="paragraph"><p>The contents of <em>mytool</em> will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> Context</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Utils </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> subprocess</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.src'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_shpip</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'src2c'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">src2c</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'PINK'</span>
<span style="color: #000000">    quiet </span><span style="color: #000000">=</span><span style="color: #000000"> True </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'%s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COMP</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        n </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">()</span>
<span style="color: #000000">        n</span><span style="color: #000000">.</span><span style="color: #000000">mkdir</span><span style="color: #000000">()</span>
<span style="color: #000000">        cwd </span><span style="color: #000000">=</span><span style="color: #000000"> n</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">cmd_and_log</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">,</span><span style="color: #000000"> cwd</span><span style="color: #000000">=</span><span style="color: #000000">cwd</span><span style="color: #000000">,</span><span style="color: #000000"> quiet</span><span style="color: #000000">=</span><span style="color: #000000">Context</span><span style="color: #000000">.</span><span style="color: #000000">STDOUT</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">out</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> out</span><span style="color: #000000">]</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">()]</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> lst</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">more_tasks </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> node </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">name</span><span style="color: #000000">.</span><span style="color: #000000">endswith</span><span style="color: #000000">(</span><span style="color: #009900">'.h'</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">continue</span>
<span style="color: #000000">            tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">create_compiled_task</span><span style="color: #000000">(</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">more_tasks</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">            tsk</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()])</span>

<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'link_task'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">])</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        ret </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">super</span><span style="color: #000000">(</span><span style="color: #000000">src2c</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">).</span><span style="color: #000000">runnable_status</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ret </span><span style="color: #000000">==</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">SKIP_ME</span><span style="color: #000000">:</span>

<span style="color: #000000">            lst </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()]</span>
<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">!=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">():</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">            nodes </span><span style="color: #000000">=</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">:]</span>
<span style="color: #000000">            </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> nodes</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                    os</span><span style="color: #000000">.</span><span style="color: #000000">stat</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">                    </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">            nodes </span><span style="color: #000000">=</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">:]</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">nodes</span><span style="color: #000000">)</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>

<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> ret</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
The processing will be delegated to the task
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Disable the warnings raised when a task has no outputs
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Make certain the processing will be executed before any task using <em>.h</em> files
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
When the task is executed, collect the process stdout which contains the generated file names
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
Store the output file nodes in a persistent cache
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Create the tasks to compile the outputs
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
The c tasks will be processed after the current task is done. This does not mean that the c tasks will always be executed.
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
If the task generator of the <em>src</em> file has a link task, set the build order
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
When this task can be skipped, force the dynamic c task creation
</td></tr>
</table></div>
<div class="paragraph"><p>The output will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.006s)</span>
<span style="color: #000000">Setting top to  : /tmp/scenarios_unknown</span>
<span style="color: #000000">Setting out to  : /tmp/scenarios_unknown/build</span>
<span style="color: #000000">Checking for program gcc,cc              : /usr/bin/gcc</span>
<span style="color: #000000">Checking for program ar                  : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.115s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">[1/3] src2c: foo.src</span>
<span style="color: #000000">[2/5] c: build/shpip/a12.c -&gt; build/shpip/a12.c.0.o</span>
<span style="color: #000000">[3/5] c: build/shpop/a13.c -&gt; build/shpop/a13.c.0.o</span>
<span style="color: #000000">[4/5] c: x.c -&gt; build/x.c.0.o</span>
<span style="color: #000000">[5/5] cstlib: build/x.c.0.o build/shpip/a12.c.0.o build/shpop/a13.c.0.o -&gt; build/libastaticlib.a</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">'build' finished successfully (0.188s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">'build' finished successfully (0.013s)</span></tt></pre></div></div>
</div>
<h2 id="_using_the_development_version">11. Using the development version</h2>
<div class="sectionbody">
<div class="paragraph"><p>A few notes on the waf development follow.</p></div>
<h3 id="_execution_traces">11.1. Execution traces</h3><div style="clear:left"></div>
<h4 id="_logging">11.1.1. Logging</h4>
<div class="paragraph"><p>The generic flags to add more information to the stack traces or to the messages is <em>-v</em> (verbosity), it is used to display the command-lines executed during a build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span></tt></pre></div></div>
<div class="paragraph"><p>To display all the traces (useful for bug reports), use the following flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -vvv</span></span></tt></pre></div></div>
<div class="paragraph"><p>Debugging information can be filtered easily with the flag <em>zones</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action</span></span></tt></pre></div></div>
<div class="paragraph"><p>Tracing zones must be comma-separated, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action,envhash,task_gen</span></span></tt></pre></div></div>
<div class="paragraph"><p>The Waf module <em>Logs</em> replaces the Python module logging. In the source code, traces are provided by using the <em>debug</em> function, they must obey the format "zone: message" like in the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Logs</span><span style="color: #000000">.</span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #009900">"task: executing %r - it was never run before or its class changed"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The following zones are used in Waf:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. Debugging zones</caption>
<col width="16%" />
<col width="83%" />
<thead>
<tr>
<th align="left" valign="top">Zone    </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">runner</p></td>
<td align="left" valign="top"><p class="table">command-lines executed (enabled when -v is provided without debugging zones)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">deps</p></td>
<td align="left" valign="top"><p class="table">implicit dependencies found (task scanners)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_gen</p></td>
<td align="left" valign="top"><p class="table">task creation (from task generators) and task generator method execution</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">action</p></td>
<td align="left" valign="top"><p class="table">functions to execute for building the targets</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">env</p></td>
<td align="left" valign="top"><p class="table">environment contents</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">envhash</p></td>
<td align="left" valign="top"><p class="table">hashes of the environment objects - helps seeing what changes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">build</p></td>
<td align="left" valign="top"><p class="table">build context operations such as filesystem access</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">preproc</p></td>
<td align="left" valign="top"><p class="table">preprocessor execution</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">group</p></td>
<td align="left" valign="top"><p class="table">groups and task generators</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./warning.png" alt="Warning" />
</td>
<td class="content">Debugging information can be displayed only after the command-line has been parsed. For example, no debugging information will be displayed when a waf tool is being by for the command-line options <em>opt.load()</em> or by the global init method function <em>init.tool()</em></td>
</tr></table>
</div>
<h4 id="_build_visualization">11.1.2. Build visualization</h4>
<div class="paragraph"><p>The Waf tool named <em>parallel_debug</em> is used to inject code in Waf modules and to obtain a detailed execution trace. This module is provided in the folder <tt>waflib/extras</tt> and must be imported in one&#8217;s project before use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'parallel_debug'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'parallel_debug'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The execution will generate a diagram of the tasks executed during the build in the file <tt>pdebug.svg</tt>:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="pdebug.png" alt="Parallel execution diagram" />
</div>
</div>
<div class="paragraph"><p>The details will be generated in the file <tt>pdebug.dat</tt> as space-separated values. The file can be processed by other applications such as Gnuplot to obtain other diagrams:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">#! /usr/bin/env gnuplot</span></span>
<span style="color: #000000">set terminal png</span>
<span style="color: #000000">set output "output.png"</span>
<span style="color: #000000">set ylabel "Amount of active threads"</span>
<span style="color: #000000">set xlabel "Time in seconds"</span>
<span style="color: #000000">set title "Active threads on a parallel build (waf -j5)"</span>
<span style="color: #000000">unset label</span>
<span style="color: #000000">set yrange [-0.1:5.2]</span>
<span style="color: #000000">set ytic 1</span>
<span style="color: #000000">plot 'pdebug.dat' using 3:7 with lines title "" lt 2</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dev.png" alt="Thread activity during the build" />
</div>
</div>
<div class="paragraph"><p>The data file columns are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 3. pdebug file format</caption>
<col width="11%" />
<col width="22%" />
<col width="66%" />
<thead>
<tr>
<th align="left" valign="top">Column </th>
<th align="left" valign="top"> Type </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">Identifier of the thread which has started or finished processing a task</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">2</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">Identifier of the task processed</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3</p></td>
<td align="left" valign="top"><p class="table">float</p></td>
<td align="left" valign="top"><p class="table">Event time</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">4</p></td>
<td align="left" valign="top"><p class="table">string</p></td>
<td align="left" valign="top"><p class="table">Type of the task processed</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">5</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">Amount of tasks processed</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">Amount of tasks waiting to be processed by the task consumers</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">7</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">Amount of active threads</p></td>
</tr>
</tbody>
</table>
</div>
<h3 id="_profiling">11.2. Profiling</h3><div style="clear:left"></div>
<h4 id="_benchmark_projects">11.2.1. Benchmark projects</h4>
<div class="paragraph"><p>The script <tt>utils/genbench.py</tt> is used as a base to create large c-like project files. The habitual use is the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ utils/genbench.py /tmp/build 50 100 15 5</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/build</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf -p -j2</span></span></tt></pre></div></div>
<div class="paragraph"><p>The C++ project created will generate 50 libraries from 100 class files for each, each source file having 15 include headers pointing at the same library and 5 headers pointing at other headers randomly chosen.</p></div>
<div class="paragraph"><p>The compilation time may be discarded easily by disabling the actual compilation, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">touch_func</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">:</span>
<span style="color: #000000">                        x</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">''</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">.</span><span style="color: #000000">keys</span><span style="color: #000000">():</span>
<span style="color: #000000">                cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #000000">x</span><span style="color: #000000">]</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">func </span><span style="color: #000000">=</span><span style="color: #000000"> touch_func</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'CYAN'</span></tt></pre></div></div>
<h4 id="_profile_traces">11.2.2. Profile traces</h4>
<div class="paragraph"><p>Profiling information is obtained by calling the module cProfile and by injecting specific code. The most interesting methods to profile is <em>waflib.Build.BuildContext.compile</em>. The amount of function calls is usually a bottleneck, and reducing it results in noticeable speedups. Here is an example on the method compile:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ncomp</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> cProfile</span><span style="color: #000000">,</span><span style="color: #000000"> pstats</span>
<span style="color: #000000">        cProfile</span><span style="color: #000000">.</span><span style="color: #000000">runctx</span><span style="color: #000000">(</span><span style="color: #009900">'self.orig_compile()'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">{},</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'self'</span><span style="color: #000000">:</span><span style="color: #000000"> self</span><span style="color: #000000">},</span><span style="color: #000000"> </span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p </span><span style="color: #000000">=</span><span style="color: #000000"> pstats</span><span style="color: #000000">.</span><span style="color: #000000">Stats</span><span style="color: #000000">(</span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p</span><span style="color: #000000">.</span><span style="color: #000000">sort_stats</span><span style="color: #000000">(</span><span style="color: #009900">'time'</span><span style="color: #000000">).</span><span style="color: #000000">print_stats</span><span style="color: #000000">(</span><span style="color: #000000">45</span><span style="color: #000000">)</span>

<span style="color: #000000">BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">orig_compile </span><span style="color: #000000">=</span><span style="color: #000000"> BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">compile</span>
<span style="color: #000000">BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">compile </span><span style="color: #000000">=</span><span style="color: #000000"> ncomp</span></tt></pre></div></div>
<div class="paragraph"><p>Here the output obtained on a benchmark build created as explained in the previous section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Fri Jul 23 15:11:15 2010    profi.txt</span>

<span style="color: #000000">         1114979 function calls (1099879 primitive calls) in 5.768 CPU seconds</span>

<span style="color: #000000">   Ordered by: internal time</span>
<span style="color: #000000">   List reduced from 139 to 45 due to restriction 45</span>

<span style="color: #000000">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
<span style="color: #000000">   109500    0.523    0.000    1.775    0.000 /comp/waf/waflib/Node.py:615(get_bld_sig)</span>
<span style="color: #000000">     5000    0.381    0.000    1.631    0.000 /comp/waf/waflib/Task.py:475(compute_sig_implicit_deps)</span>
<span style="color: #000000">   154550    0.286    0.000    0.286    0.000 {method 'update' of '_hashlib.HASH' objects}</span>
<span style="color: #000000">   265350    0.232    0.000    0.232    0.000 {id}</span>
<span style="color: #000000">40201/25101    0.228    0.000    0.228    0.000 /comp/waf/waflib/Node.py:319(abspath)</span>
<span style="color: #000000">    10000    0.223    0.000    0.223    0.000 {open}</span>
<span style="color: #000000">    20000    0.197    0.000    0.197    0.000 {method 'read' of 'file' objects}</span>
<span style="color: #000000">    15000    0.193    0.000    0.349    0.000 /comp/waf/waflib/Task.py:270(uid)</span>
<span style="color: #000000">    10000    0.189    0.000    0.850    0.000 /comp/waf/waflib/Utils.py:96(h_file)</span></tt></pre></div></div>
<div class="paragraph"><p>A few known hot spots are present in the library:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The persistence implemented by the cPickle module (the cache file to serialize may take a few megabytes)
</p>
</li>
<li>
<p>
Accessing configuration data from the Environment instances
</p>
</li>
<li>
<p>
Computing implicit dependencies in general
</p>
</li>
</ol></div>
<h4 id="_optimizations_tips">11.2.3. Optimizations tips</h4>
<div class="paragraph"><p>The Waf source code has already been optimized in various ways. In practice, the projects may use additional assumptions to replace certain methods or parameters from its build scripts. For example, if a project is always executed on Windows, then the <em>framework</em> and <em>rpath</em> variables may be removed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">ccroot </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> USELIB_VARS</span>
<span style="color: #000000">USELIB_VARS</span><span style="color: #000000">[</span><span style="color: #009900">'cprogram'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> USELIB_VARS</span><span style="color: #000000">[</span><span style="color: #009900">'cxxprogram'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">\</span>
<span style="color: #000000">        </span><span style="color: #000000">set</span><span style="color: #000000">([</span><span style="color: #009900">'LIB'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'STLIB'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LIBPATH'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'STLIBPATH'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LINKFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LINKDEPS'</span><span style="color: #000000">])</span></tt></pre></div></div>
<h3 id="_waf_programming">11.3. Waf programming</h3><div style="clear:left"></div>
<h4 id="_setting_up_a_waf_directory_for_development">11.3.1. Setting up a Waf directory for development</h4>
<div class="paragraph"><p>Waf is hosted on <a href="http://code.google.com/p/waf/source">Google code</a>, and uses Subversion for source control. To obtain the development copy, use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ git clone http://code.google.com/p/waf/ wafdir</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd wafdir</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf-light --make-waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>To avoid regenerating Waf each time, the environment variable <strong>WAFDIR</strong> should be used to point at the directory containing <em>waflib</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFDIR=/path/to/directory/</span></span></tt></pre></div></div>
<h4 id="_specific_guidelines">11.3.2. Specific guidelines</h4>
<div class="paragraph"><p>Though Waf is written in Python, additional restrictions apply to the source code:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Identation is tab-only, and the maximum line length should be about 200 characters
</p>
</li>
<li>
<p>
The development code is kept compatible with Python 2.3, to the exception of decorators in the Tools directory. In particular, the Waf binary can be generated using Python 2.3
</p>
</li>
<li>
<p>
The <em>waflib</em> modules must be insulated from the <em>Tools</em> modules to keep the Waf core small and language independent
</p>
</li>
<li>
<p>
Api compatibility is maintained in the cycle of a minor version (from 1.5.0 to 1.5.n)
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">More code always means more bugs. Whenever possible, unnecessary code must be removed, and the existing code base should be simplified.</td>
</tr></table>
</div>
</div>
<h2 id="_waf_architecture_overview">12. Waf architecture overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter provides describes the Waf library and the interaction between the components.</p></div>
<h3 id="_modules_and_classes">12.1. Modules and classes</h3><div style="clear:left"></div>
<h4 id="_core_modules">12.1.1. Core modules</h4>
<div class="paragraph"><p>Waf consists of the following modules which constitute the core library. They are located in the directory <tt>waflib/</tt>. The modules located under <tt>waflib/Tools</tt> and <tt>waflib/extras</tt> are extensions which are not part of the Waf core.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 4. List of core modules</caption>
<col width="14%" />
<col width="85%" />
<thead>
<tr>
<th align="left" valign="top">Module    </th>
<th align="left" valign="top"> Role</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Build</p></td>
<td align="left" valign="top"><p class="table">Defines the build context classes (build, clean, install, uninstall), which holds the data for one build (paths, configuration data)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Configure</p></td>
<td align="left" valign="top"><p class="table">Contains the configuration context class, which is used for launching configuration tests and writing the configuration settings for the build</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ConfigSet</p></td>
<td align="left" valign="top"><p class="table">Contains a dictionary class which supports a lightweight copy scheme and provides persistence services</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Context</p></td>
<td align="left" valign="top"><p class="table">Contains the base class for all waf commands (context parameters of the Waf commands)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Errors</p></td>
<td align="left" valign="top"><p class="table">Exceptions used in the Waf code</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Logs</p></td>
<td align="left" valign="top"><p class="table">Loggging system wrapping the calls to the python logging module</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Node</p></td>
<td align="left" valign="top"><p class="table">Contains the file system representation class</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Options</p></td>
<td align="left" valign="top"><p class="table">Provides a custom command-line option processing system based on optparse</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Runner</p></td>
<td align="left" valign="top"><p class="table">Contains the task execution system (thread-based producer-consumer)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Scripting</p></td>
<td align="left" valign="top"><p class="table">Constitutes the entry point of the Waf application, executes the user commands such as build, configuration and installation</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TaskGen</p></td>
<td align="left" valign="top"><p class="table">Provides the task generator system, and its extension system based on method addition</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Task</p></td>
<td align="left" valign="top"><p class="table">Contains the task class definitions, and factory functions for creating new task classes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Utils</p></td>
<td align="left" valign="top"><p class="table">Contains support functions and classes used by other Waf modules</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Not all core modules are required for using Waf as a library. The dependencies between the modules are represented on the following diagram. For example, the module <em>Node</em> requires both modules <em>Utils</em> and <em>Errors</em>. Conversely, if the module <em>Build</em> is used alone, then the modules <em>Scripting</em> and <em>Configure</em> can be removed safely.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="core.png" alt="Module dependencies" />
</div>
</div>
<h4 id="_context_classes">12.1.2. Context classes</h4>
<div class="paragraph"><p>User commands, such as <em>configure</em> or <em>build</em>, are represented by classes derived from <em>waflib.Context.Context</em>. When a command does not have a class associated, the base class <em>waflib.Context.Context</em> is used instead.</p></div>
<div class="paragraph"><p>The method <em>execute</em> is the start point for a context execution, it often calls the method <em>recurse</em> to start reading the user scripts and execute the functions referenced by the <em>fun</em> class attribute.</p></div>
<div class="paragraph"><p>The command is associated to a context class by the class attribute <em>cmd</em> set on the class. Context subclasses are added in <em>waflib.Context.classes</em> by the metaclass <em>store_context</em> and loaded through the function <em>waflib.Context.create_context</em>. The classes defined last will replace existing commands.</p></div>
<div class="paragraph"><p>As an example, the following context class will define or override the <em>configure</em> command. When calling <em>waf configure</em>, the function <em>foo</em> will be called from wscript files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">somename</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">    cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'configure'</span>
<span style="color: #000000">    fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="classes.png" alt="Context classes" />
</div>
</div>
<h4 id="_build_classes">12.1.3. Build classes</h4>
<div class="paragraph"><p>The class <em>waflib.Build.BuildContext</em> and its subclasses such as <em>waflib.Build.InstallContext</em> or <em>waflib.Build.StepContext</em> have task generators created when reading the user scripts. The task generators will usually have task instances, depending on the operations performed after all task generators have been processed.</p></div>
<div class="paragraph"><p>The <em>ConfigSet</em> instances are copied from the build context to the tasks (<em>waflib.ConfigSet.ConfigSet.derive</em>) to propagate values such as configuration flags. A copy-on-write is performed through most methods of that class (append_value, prepend_value, append_unique).</p></div>
<div class="paragraph"><p>The <em>Parallel</em> object encapsulates the iteration over all tasks of the build context, and delegates the execution to thread objects (producer-consumer).</p></div>
<div class="paragraph"><p>The overall structure is represented on the following diagram:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="classes_build.png" alt="Build classes" />
</div>
</div>
<h3 id="_context_objects">12.2. Context objects</h3><div style="clear:left"></div>
<h4 id="_context_commands_and_recursion">12.2.1. Context commands and recursion</h4>
<div class="paragraph"><p>The context commands are designed to be as independent as possible, and may be executed concurrently. The main application is the execution of small builds as part of configuration tests. For example, the method <em>waflib.Tools.c_config.run_c_code</em> creates a private build context internally to perform the tests.
Here is an example of a build that creates and executes simple configuration contexts concurrently:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span><span style="color: #000000">,</span><span style="color: #000000"> ConfigurationContext</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> Build</span><span style="color: #000000">,</span><span style="color: #000000"> Logs</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #000000">run_test</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">'stdio.h'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #000000">run_test</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">'unistd.h'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run_test</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        top </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">bldnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>

<span style="color: #000000">        ctx </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ConfigurationContext</span><span style="color: #000000">(</span><span style="color: #000000">top_dir</span><span style="color: #000000">=</span><span style="color: #000000">top</span><span style="color: #000000">,</span><span style="color: #000000"> out_dir</span><span style="color: #000000">=</span><span style="color: #000000">out</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">init_dirs</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">in_msg </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">msg</span><span style="color: #000000">(</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        header </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">header_name</span>
<span style="color: #000000">        logfile </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">().</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> os</span><span style="color: #000000">.</span><span style="color: #000000">sep </span><span style="color: #000000">\</span>
<span style="color: #000000">                </span><span style="color: #000000">+</span><span style="color: #000000"> header </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'.log'</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">logger </span><span style="color: #000000">=</span><span style="color: #000000"> Logs</span><span style="color: #000000">.</span><span style="color: #000000">make_logger</span><span style="color: #000000">(</span><span style="color: #000000">logfile</span><span style="color: #000000">,</span><span style="color: #000000"> header</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">header_name</span><span style="color: #000000">=</span><span style="color: #000000">header</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Create task generators which will run the method <em>run_test</em> method defined below
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Create a new configuration context as part of a <em>Task.run</em> call
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Initialize ctx.srcnode and ctx.bldnode (build and configuration contexts only)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Set the internal counter for the context methods <em>msg</em>, <em>start_msg</em> and <em>end_msg</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
The console output is disabled (non-zero counter value to disable nested messages)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
Each context may have a logger to redirect the error messages
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Initialize the default environment to a copy of the task one
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
Perform a configuration check
</td></tr>
</table></div>
<div class="paragraph"><p>After executing <em>waf build</em>, the project folder will contain the new log files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   |-- stdio.h.log</span>
<span style="color: #000000">|   `-- unistd.h.log</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>A few measures are set to ensure that the contexts can be executed concurrently:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Context objects may use different loggers derived from the <em>waflib.Logs</em> module.
</p>
</li>
<li>
<p>
Each context object is associated to a private subclass of <em>waflib.Node.Node</em> to ensure that the node objects are unique. To pickle Node objects, it is important to prevent concurrent access by using the lock object <em>waflib.Node.pickle_lock</em>.
</p>
</li>
</ol></div>
<h4 id="_build_context_and_persistence">12.2.2. Build context and persistence</h4>
<div class="paragraph"><p>The build context holds all the information necessary for a build. To accelerate the start-up, a part of the information is stored and loaded between the runs. The persistent attributes are the following:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 5. Persistent attributes</caption>
<col width="14%" />
<col width="42%" />
<col width="42%" />
<thead>
<tr>
<th align="left" valign="top">Attribute </th>
<th align="left" valign="top"> Description                                            </th>
<th align="left" valign="top"> Type</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">root</p></td>
<td align="left" valign="top"><p class="table">Node representing the root of the file system</p></td>
<td align="left" valign="top"><p class="table">Node</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">node_deps</p></td>
<td align="left" valign="top"><p class="table">Implicit dependencies</p></td>
<td align="left" valign="top"><p class="table">dict mapping Node to signatures</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">raw_deps</p></td>
<td align="left" valign="top"><p class="table">Implicit file dependencies which could not be resolved</p></td>
<td align="left" valign="top"><p class="table">dict mapping Node ids to any serializable type</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_sigs</p></td>
<td align="left" valign="top"><p class="table">Signature of the tasks executed</p></td>
<td align="left" valign="top"><p class="table">dict mapping a Task computed uid to a hash</p></td>
</tr>
</tbody>
</table>
</div>
<h3 id="_support_for_c_like_languages">12.3. Support for c-like languages</h3><div style="clear:left"></div>
<h4 id="_compiled_tasks_and_link_tasks">12.3.1. Compiled tasks and link tasks</h4>
<div class="paragraph"><p>The tool <em>waflib.Tools.ccroot</em> provides a system for creating object files and linking them into a single final file. The method <em>waflib.Tools.ccroot.apply_link</em> is called after the method <em>waflib.TaskGen.process_source</em> to create the link task. In pseudocode:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">call the method process_source:</span>
<span style="color: #000000">  for each source file foo.ext:</span>
<span style="color: #000000">    process the file by extension</span>
<span style="color: #000000">      if the method create_compiled_task is used:</span>
<span style="color: #000000">        create a new task</span>
<span style="color: #000000">        set the output file name to be foo.ext.o</span>
<span style="color: #000000">        add the task to the list self.compiled_tasks</span>

<span style="color: #000000">call the method apply_link</span>
<span style="color: #000000">  for each name N in self.features:</span>
<span style="color: #000000">    find a class named N:</span>
<span style="color: #000000">      if the class N derives from 'waflib.Tools.ccroot.link_task':</span>
<span style="color: #000000">        create a task of that class, assign it to self.link_task</span>
<span style="color: #000000">        set the link_task inputs from self.compiled_tasks</span>
<span style="color: #000000">        set the link_task output name to be env.N_PATTERN % self.target</span>
<span style="color: #000000">        stop</span></tt></pre></div></div>
<div class="paragraph"><p>This system is used for <em>assembly</em>, <em>C</em>, <em>C++</em>, <em>D</em> and <em>fortran</em> by default. Note that the method <em>apply_link</em> is supposed to be called after the method <em>process_source</em>.</p></div>
<div class="paragraph"><p>We will now demonstrate how to support the following mini language:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cp: .ext -&gt; .o</span>
<span style="color: #000000">cat: *.o -&gt; .exe</span></tt></pre></div></div>
<div class="paragraph"><p>Here is the project file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'mylink'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.ext faa.ext'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bingo'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span><span style="color: #000000">,</span><span style="color: #000000"> after_method</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> ccroot </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'mylink'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">call_apply_link</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">apply_link</span><span style="color: #000000">()</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">mylink</span><span style="color: #000000">(</span><span style="color: #000000">ccroot</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cat ${SRC} &gt; ${TGT}'</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">ext2o</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.ext'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_ext</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_compiled_task</span><span style="color: #000000">(</span><span style="color: #009900">'ext2o'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
This import will bind the methods such as <em>create_compiled_task</em> and <em>apply_link_task</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
An alternate definition would be calling <em>waflib.TaskGen.feats[&#8216;mylink&#8217;] = [&#8216;apply_link&#8217;]</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
The link task must be a subclass of another link task class
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
Calling the method <em>create_compiled_task</em>
</td></tr>
</table></div>
<div class="paragraph"><p>The execution outputs will be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Setting top to   : /tmp/architecture_link</span>
<span style="color: #000000">Setting out to   : /tmp/architecture_link/build</span>
<span style="color: #000000">'configure' finished successfully (0.008s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/architecture_link/build'</span>
<span style="color: #000000">[1/3] ext2o: foo.ext -&gt; build/foo.ext.0.o</span>
<span style="color: #000000">12:50:25 runner ['cp', '../foo.ext', 'foo.ext.0.o']</span>
<span style="color: #000000">[2/3] ext2o: faa.ext -&gt; build/faa.ext.0.o</span>
<span style="color: #000000">12:50:25 runner ['cp', '../faa.ext', 'faa.ext.0.o']</span>
<span style="color: #000000">[3/3] mylink: build/foo.ext.0.o build/faa.ext.0.o -&gt; build/bingo</span>
<span style="color: #000000">12:50:25 runner 'cat foo.ext.0.o faa.ext.0.o &gt; bingo'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/architecture_link/build'</span>
<span style="color: #000000">'build' finished successfully (0.041s)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">Task generator instances have at most one link task instance</td>
</tr></table>
</div>
<h3 id="_writing_re_usable_waf_tools">12.4. Writing re-usable Waf tools</h3><div style="clear:left"></div>
<h4 id="_adding_a_waf_tool">12.4.1. Adding a waf tool</h4>
<h5 id="_importing_the_code">Importing the code</h5>
<div class="paragraph"><p>The intent of the Waf tools is to promote high cohesion by moving all conceptually related methods and classes into separate files, hidden from the Waf core, and as independent from each other as possible.</p></div>
<div class="paragraph"><p>Custom Waf tools can be left in the projects, added to a custom waf file through the <em>waflib/extras</em> folder, or used through <em>sys.path</em> changes.</p></div>
<div class="paragraph"><p>The tools can import other tools directly through the <em>import</em> keyword. The scripts however should always import the tools to the <em>ctx.load</em> to limit the coupling. Compare for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">extras</span><span style="color: #000000">.</span><span style="color: #000000">foo </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> method1</span>
<span style="color: #000000">    </span><span style="color: #000000">method1</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>and:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">method1</span><span style="color: #000000">()</span></tt></pre></div></div>
<div class="paragraph"><p>The second version should be preferred, as it makes fewer assumptions on whether <em>method1</em> comes from the module <em>foo</em> or not, and on where the module <em>foo</em> is located.</p></div>
<h5 id="_naming_convention_for_c_c_fortran">Naming convention for C/C++/Fortran</h5>
<div class="paragraph"><p>The tools <em>compiler_c</em>, <em>compiler_cxx</em> and <em>compiler_fc</em> use other waf tools to detect the presense of particular compilers. They provide a particular naming convention to give a chance to new tools to register themselves automatically and save the import in user scripts. The tools having names beginning by <em>c_</em>, <em>cxx_</em> and <em>fc_</em> will be tested.</p></div>
<div class="paragraph"><p>The registration code will be similar to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">compiler_X </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> X_compiler</span>
<span style="color: #000000">X_compiler</span><span style="color: #000000">[</span><span style="color: #009900">'platform'</span><span style="color: #000000">].</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'module_name'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>where <strong>X</strong> represents the type of compiler (<em>c</em>, <em>cxx</em> or <em>fc</em>), <strong>platform</strong> is the platform on which the detection should take place (linux, win32, etc), and <strong>module_name</strong> is the name of the tool to use.</p></div>
<h4 id="_command_methods">12.4.2. Command methods</h4>
<h5 id="_subclassing_is_only_for_commands">Subclassing is only for commands</h5>
<div class="paragraph"><p>As a general rule, subclasses of <em>waflib.Context.Context</em> are created only when a new user command is necessary. This is the case for example when a command for a specific variant (output folder) is required, or to provide a new behaviour. When this happens, the class methods <em>recurse</em>, <em>execute</em> or the class attributes <em>cmd</em>, <em>fun</em> are usually overridden.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./note.png" alt="Note" />
</td>
<td class="content">If there is no new command needed, do not use subclassing.</td>
</tr></table>
</div>
<h5 id="_domain_specific_methods_are_convenient_for_the_end_users">Domain-specific methods are convenient for the end users</h5>
<div class="paragraph"><p>Although the Waf framework promotes the most flexible way of declaring tasks through task generators, it is often more convenient to declare domain-specific wrappers in large projects. For example, the samba project provides a function used as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">SAMBA_SUBSYSTEM</span><span style="color: #000000">(</span><span style="color: #009900">'NDR_NBT_BUF'</span><span style="color: #000000">,</span>
<span style="color: #000000">    source    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'nbtname.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">    deps      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'talloc'</span><span style="color: #000000">,</span>
<span style="color: #000000">    autoproto </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'nbtname.h'</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
<h5 id="_how_to_bind_new_methods">How to bind new methods</h5>
<div class="paragraph"><p>New methods are commonly bound to the build context or to the configuration context by using the <em>@conf</em> decorator:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span>

<span style="color: #000000">@conf</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">enterprise_program</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">    kw</span><span style="color: #000000">[</span><span style="color: #009900">'features'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c cprogram debug_tasks'</span>
<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">self</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #808080"># no feature line</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">enterprise_program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The methods should always be bound in this manner or manually, as subclassing may create conflicts between tools written for different purposes.</p></div>
</div>
<h2 id="_further_reading">13. Further reading</h2>
<div class="sectionbody">
<div class="paragraph"><p>Due to the amount of features provided by Waf, this book cannot be both complete and up-to-date. For greater understanding and practice the following links are recommended to the reader:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 6. Recommended links</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Link</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://docs.waf.googlecode.com/git/apidocs_17/index.html">http://docs.waf.googlecode.com/git/apidocs_17/index.html</a></p></td>
<td align="left" valign="top"><p class="table">The apidocs</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf">http://code.google.com/p/waf</a></p></td>
<td align="left" valign="top"><p class="table">The Waf project page</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf/w/list">http://code.google.com/p/waf/w/list</a></p></td>
<td align="left" valign="top"><p class="table">The Waf wiki, including the frequently asked questions (FAQ)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://groups.google.com/group/waf-users">http://groups.google.com/group/waf-users</a></p></td>
<td align="left" valign="top"><p class="table">The Waf mailing-list</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://waf-devel.blogspot.com/2011/01/python-32-and-build-system-kit.html">http://waf-devel.blogspot.com/2011/01/python-32-and-build-system-kit.html</a></p></td>
<td align="left" valign="top"><p class="table">Information on the build system kit</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h2 id="_glossary">14. Glossary</h2>
<div class="sectionbody">
<div class="dlist glossary"><dl>
<dt>
Build Order
</dt>
<dd>
<p>
        The build order is the sequence in which tasks must be executed. Because tasks can be executed in parallel, several build orders can be computed depending on the constraints between the tasks. When a build order cannot be computed (usually by contradictory order constraints), the build is said to be in a deadlock.
</p>
</dd>
<dt>
Dependency
</dt>
<dd>
<p>
        A dependency represents the conditions by which a task can be considered up-to-date or not (execution status). The dependencies can be explicit (file inputs and outputs) or abstract (dependency on a value for example).
</p>
</dd>
<dt>
Task generator
</dt>
<dd>
<p>
        A task generator is an object instance of the class Task.task_gen. The task generators encapsulate the creation of various task instances at a time, and simplify the creation of ordering constraints between them (for example, compilation tasks are executed before link tasks).
</p>
</dd>
<dt>
Task
</dt>
<dd>
<p>
        A Waf task is an object instance of the class Task.TaskBase. Waf tasks may be simple (Task.TaskBase) or related to the filesystem (Task.Task). Tasks represent the production of something during the build (files in general), and may be executed in sequence (with ordering constraints) or in parallel.
</p>
</dd>
<dt>
Tool
</dt>
<dd>
<p>
        A Waf tool is a python module containing Waf-specific extensions. The Waf tools are located in the folder <tt>waflib/Tools/</tt> and usually contain a global variable <em>configure</em> which may reference functions to execute in the configuration.
</p>
</dd>
<dt>
Node
</dt>
<dd>
<p>
        The Node class is a data structure used to represent the filesystem in an efficient manner. The node objects may represent files or folders. File nodes are associated to signatures objects. The signature can be hashes of the file contents (source files) or task signatures (build files).
</p>
</dd>
<dt>
Command
</dt>
<dd>
<p>
        Function present in the top-level project file (wscript) and accepting a <em>waflib.Context.Context</em> instance as unique input parameter. The function is executed when its name is given on the command-line (for example running <em>waf configure</em> will execute the function <em>configure</em>)
</p>
</dd>
<dt>
Variant
</dt>
<dd>
<p>
        Additional output directory used to enable several (build) commands to create the same targets with different compilation flags.
</p>
</dd>
</dl></div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-05-25 21:54:25 CEST
</div>
</div>
</body>
</html>
